@page "/definisi-kod-penghutang"
@using IMAS.API.AkaunBelumTerima.Shared.Models
@using IMAS.Blazor.AkaunBelumTerima.Services.Refit
@using MudBlazor
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IPenyelenggaraanPenghutangApi PenyelenggaraanPenghutangService

<MudPaper Class="pa-4">

    <!-- ======================= Senarai Kod Penghutang ======================= -->
    <MudCard Class="mb-4" Style="border-left:6px solid #2c7be5;">
        <MudCardHeader Class="py-2" Style="background:#2c7be5; color:white;">
            <MudText Typo="Typo.subtitle1" Class="pl-2">Definisi Kod Penghutang</MudText>
        </MudCardHeader>

        <MudCardContent>

            <!-- Controls: page size + search -->
            <MudGrid AlignItems="AlignItems.Center" Class="mb-2">
                <MudItem xs="12" md="3">
                    <MudSelect T="int" Value="@_pageSize" ValueChanged="(v) => { _pageSize = v; _page = 1; }"
                               Dense="true" Variant="Variant.Outlined" Style="background:white; width:100px;">
                        <MudSelectItem T="int" Value="10">10</MudSelectItem>
                        <MudSelectItem T="int" Value="25">25</MudSelectItem>
                        <MudSelectItem T="int" Value="50">50</MudSelectItem>
                        <MudSelectItem T="int" Value="100">100</MudSelectItem>
                    </MudSelect>
                    <MudText Typo="Typo.caption">records</MudText>
                </MudItem>

                <MudItem xs="12" md="9" Class="d-flex justify-end">
                    <MudText Typo="Typo.caption" Class="mr-2">Search:</MudText>
                    <MudTextField T="string" @bind-Value="_search" Immediate="true"
                                  Variant="Variant.Outlined" Dense="true"
                                  Style="background:white; max-width:260px;" />
                </MudItem>
            </MudGrid>

            <!-- Table -->
            @if (_isLoading)
            {
                <MudProgressLinear Indeterminate />
            }
            else
            {
                <MudTable Items="_paged" Dense="true" Hover="true" Striped="true" Bordered="true" Elevation="0"
                          T="PenyelenggaraanPenghutangDTO">
                    <HeaderContent>
                        <MudTh width="18%">Kod Penghutang</MudTh>
                        <MudTh width="22%">Nama</MudTh>
                        <MudTh width="18%">Nama Kedua</MudTh>
                        <MudTh width="18%">Bank</MudTh>
                        <MudTh width="16%">No. Akaun</MudTh>
                        <MudTh width="8%"></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Kod Penghutang">@context.KodPenghutang</MudTd>
                        <MudTd DataLabel="Nama">@context.Nama</MudTd>
                        <MudTd DataLabel="Nama Kedua">@context.NamaKedua</MudTd>
                        <MudTd DataLabel="Bank">@context.Bank</MudTd>
                        <MudTd DataLabel="No. Akaun">@context.NoAkaun</MudTd>
                        <MudTd>
                            <MudButton Color="Color.Info" Variant="Variant.Outlined" Size="Size.Small"
                                       OnClick="@(()=>EditItem(context))">Ubah</MudButton>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.caption">No data available in table</MudText>
                    </NoRecordsContent>
                </MudTable>

                <!-- Footer count + pager -->
                <MudGrid AlignItems="AlignItems.Center" Class="mt-2">
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.caption">
                            Showing @(_total == 0 ? 0 : ((_page - 1) * _pageSize + 1))
                            to @((Math.Min(_page * _pageSize, _total))) of @_total entries
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" md="6" Class="d-flex justify-end">
                        <MudPagination Page="@_page" PageChanged="(p)=>_page=p"
                                       Count="@(Math.Max(1, (int)Math.Ceiling((double)_total/_pageSize)))"
                                       HidePrevNext="false" Class="my-0" />
                    </MudItem>
                </MudGrid>
            }
        </MudCardContent>
    </MudCard>

    <!-- ======================= Borang (Tambah/Ubah) ======================= -->
    <MudCard Style="border-left:6px solid #16a085;">
        <MudCardHeader Class="py-2" Style="background:#16a085; color:white;">
            <MudText Typo="Typo.subtitle1" Class="pl-2">
                @( _model.ID == Guid.Empty ? "Tambah Kod Penghutang" : "Ubah Kod Penghutang")
            </MudText>
        </MudCardHeader>
        <MudCardContent>

            <!-- Baris utama -->
            <MudGrid Class="mb-2">
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.caption">Kod Penghutang *</MudText>
                    <MudTextField T="string" @bind-Value="_model.KodPenghutang" Dense="true"
                                  Variant="Variant.Outlined" Style="background:white;" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.caption">Nama *</MudText>
                    <MudTextField T="string" @bind-Value="_model.Nama" Dense="true"
                                  Variant="Variant.Outlined" Style="background:white;" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.caption">Nama Kedua</MudText>
                    <MudTextField T="string" @bind-Value="_model.NamaKedua" Dense="true"
                                  Variant="Variant.Outlined" Style="background:white;" />
                </MudItem>
            </MudGrid>

            <!-- Tabs mirroring the UI (we implement Butiran Akaun fields) -->
            <MudTabs Rounded="true">
                <MudTabPanel Text="Butiran Akaun">
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.caption">Bank</MudText>
                            <MudSelect T="string" @bind-Value="_model.Bank" Dense="true"
                                       Variant="Variant.Outlined" Style="background:white;">
                                <MudSelectItem T="string" Value="@("")">Select...</MudSelectItem>
                                @foreach (var b in _banks)
                                {
                                    <MudSelectItem T="string" Value="@b">@b</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.caption">No. Akaun</MudText>
                            <MudTextField T="string" @bind-Value="_model.NoAkaun" Dense="true"
                                          Variant="Variant.Outlined" Style="background:white;" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>
                <MudTabPanel Text="Butiran Penghutang">
                    <MudText Typo="Typo.caption" Class="text-secondary">— tiada medan khusus (boleh ditambah kemudian)</MudText>
                </MudTabPanel>
                <MudTabPanel Text="Alamat">
                    <MudText Typo="Typo.caption" Class="text-secondary">— tiada medan khusus (boleh ditambah kemudian)</MudText>
                </MudTabPanel>
                <MudTabPanel Text="Surat Peringatan">
                    <MudText Typo="Typo.caption" Class="text-secondary">— tiada medan khusus (boleh ditambah kemudian)</MudText>
                </MudTabPanel>
                <MudTabPanel Text="Lain-lain">
                    <MudText Typo="Typo.caption" Class="text-secondary">— tiada medan khusus (boleh ditambah kemudian)</MudText>
                </MudTabPanel>
            </MudTabs>

            <MudDivider Class="my-3" />

            <!-- Actions -->
            <MudStack Row="true" Spacing="2">
                <MudButton Color="Color.Success" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Save"
                           OnClick="SaveItem">Simpan</MudButton>
                <MudButton Color="Color.Info" Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Restore"
                           OnClick="ResetForm">Reset</MudButton>
                <MudButton Color="Color.Error" Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Delete"
                           Disabled="@(_model.ID == Guid.Empty)" OnClick="DeleteItem">Padam</MudButton>
            </MudStack>

        </MudCardContent>
    </MudCard>

</MudPaper>

@code {
    private bool _isLoading;
    private int _page = 1;
    private int _pageSize = 10;
    private string _search = string.Empty;

    private List<PenyelenggaraanPenghutangDTO> _all = new();
    private PenyelenggaraanPenghutangDTO _model = NewModel();

    // simple bank list (swap to API if you have one)
    private readonly List<string> _banks = new()
    {
        "Maybank", "CIMB", "RHB", "Bank Islam", "Public Bank", "Hong Leong"
    };

    // ==== Filtering & paging
    private IEnumerable<PenyelenggaraanPenghutangDTO> _filtered =>
        _all
            .Where(x => string.IsNullOrWhiteSpace(_search)
                || (x.KodPenghutang?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.Nama?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.NamaKedua?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.Bank?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.NoAkaun?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false));

    private List<PenyelenggaraanPenghutangDTO> _paged =>
        _filtered.OrderBy(x => x.KodPenghutang)
                 .Skip((_page - 1) * _pageSize)
                 .Take(_pageSize)
                 .ToList();

    private int _total => _filtered.Count();

    // ==== Lifecycle
    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            // Refit baru: terus dapat List<PenyelenggaraanPenghutangDTO>
            var list = await PenyelenggaraanPenghutangService.GetAllAsync();
            // Jika campur kategori + kod dalam table sama, tapis hanya yg ada KodPenghutang
            _all = (list ?? new()).Where(x => !string.IsNullOrWhiteSpace(x.KodPenghutang)).ToList();
            _page = 1;
        }
        catch (Exception ex)
        {
            _all = new();
            Snackbar.Add($"Gagal memuatkan data: {ex.Message}", Severity.Error);
        }
        finally { _isLoading = false; }
    }

    private static PenyelenggaraanPenghutangDTO NewModel() => new()
    {
        ID = Guid.Empty,
        KodPenghutang = string.Empty,
        Nama = string.Empty,
        NamaKedua = string.Empty,
        Bank = string.Empty,
        NoAkaun = string.Empty
    };

    private void EditItem(PenyelenggaraanPenghutangDTO row)
    {
        _model = new PenyelenggaraanPenghutangDTO
        {
            ID = row.ID,
            KodPenghutang = row.KodPenghutang,
            Nama = row.Nama,
            NamaKedua = row.NamaKedua,
            Bank = row.Bank,
            NoAkaun = row.NoAkaun
        };
    }

    private async Task SaveItem()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_model.KodPenghutang) || string.IsNullOrWhiteSpace(_model.Nama))
            {
                Snackbar.Add("Kod Penghutang dan Nama wajib diisi.", Severity.Warning);
                return;
            }

            if (_model.ID == Guid.Empty)
            {
                // CREATE – Refit baru return DTO terus
                var created = await PenyelenggaraanPenghutangService.CreateAsync(_model);
                Snackbar.Add("Rekod berjaya ditambah.", Severity.Success);
            }
            else
            {
                // UPDATE – Refit baru return DTO terus
                var updated = await PenyelenggaraanPenghutangService.UpdateAsync(_model.ID, _model);
                Snackbar.Add("Rekod berjaya dikemaskini.", Severity.Success);
            }

            ResetForm();
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal menyimpan: {ex.Message}", Severity.Error);
        }
    }

    private void ResetForm() => _model = NewModel();

    private async Task DeleteItem()
    {
        if (_model.ID == Guid.Empty) return;

        var confirm = await DialogService.ShowMessageBox(
            "Pengesahan", (MarkupString)$"Padam rekod <b>{_model.KodPenghutang}</b>?",
            yesText: "Padam", cancelText: "Batal", options: new DialogOptions { CloseOnEscapeKey = true });

        if (confirm is not true) return;

        try
        {
            var del = await PenyelenggaraanPenghutangService.DeleteAsync(_model.ID);
            if (!del.IsSuccessStatusCode) throw new Exception(del.Error?.Message ?? $"HTTP {(int)del.StatusCode}");
            Snackbar.Add("Rekod berjaya dipadam.", Severity.Success);
            ResetForm();
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal memadam: {ex.Message}", Severity.Error);
        }
    }
}
