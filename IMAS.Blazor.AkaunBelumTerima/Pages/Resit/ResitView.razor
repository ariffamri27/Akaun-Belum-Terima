@page "/penyediaan-resit"

@using IMAS.API.AkaunBelumTerima.Shared.Models
@using IMAS.Blazor.AkaunBelumTerima.Services.Refit
@using MudBlazor

@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IResitApi ResitService
@inject IPenyelenggaraanPenghutangApi PenghutangService

<MudPaper Class="pa-4">

    <!-- HEADER / TITLE -->
    <MudCard Class="mb-4" Style="border-left:6px solid #9C27B0;">
        <MudCardHeader Class="py-2" Style="background:#9C27B0; color:white;">
            <MudText Typo="Typo.subtitle1" Class="pl-2">
                Penyediaan Resit
            </MudText>
        </MudCardHeader>

        <MudCardContent>

            <!-- ACTION BUTTONS -->
            <MudStack Row="true" Spacing="2" Class="mb-3">
                <MudButton Color="Color.Success"
                           Variant="Variant.Filled"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="AddNew">
                    Tambah
                </MudButton>

                <MudButton Color="Color.Info"
                           Variant="Variant.Filled"
                           StartIcon="@Icons.Material.Filled.Edit"
                           Disabled="@(!_singleSelectedBelum.HasValue)"
                           OnClick="EditSelected">
                    Ubah
                </MudButton>

                <MudButton Color="Color.Default"
                           Variant="Variant.Filled"
                           StartIcon="@Icons.Material.Filled.Clear"
                           Disabled="@(!_selectedBelum.Any())"
                           OnClick="ClearSelection">
                    Batal
                </MudButton>
            </MudStack>

            <!-- TABS -->
            <MudTabs Rounded="true" @bind-ActivePanelIndex="_activeTab">

                <!-- ================= BELUM POS ================= -->
                <MudTabPanel Text="Belum Pos">

                    <!-- Controls: page size + search -->
                    <MudGrid AlignItems="AlignItems.Center" Class="mb-2">
                        <MudItem xs="12" md="3">
                            <MudSelect T="int"
                                       Value="@_pageSizeBelum"
                                       ValueChanged="(v)=>{ _pageSizeBelum = v; _pageBelum = 1; }"
                                       Dense="true"
                                       Variant="Variant.Outlined"
                                       Style="background:white; width:100px;">
                                <MudSelectItem T="int" Value="10">10</MudSelectItem>
                                <MudSelectItem T="int" Value="25">25</MudSelectItem>
                                <MudSelectItem T="int" Value="50">50</MudSelectItem>
                                <MudSelectItem T="int" Value="100">100</MudSelectItem>
                            </MudSelect>
                            <MudText Typo="Typo.caption">records</MudText>
                        </MudItem>

                        <MudItem xs="12" md="9" Class="d-flex justify-end">
                            <MudText Typo="Typo.caption" Class="mr-2">Search:</MudText>
                            <MudTextField T="string"
                                          @bind-Value="_searchBelum"
                                          Immediate="true"
                                          Variant="Variant.Outlined"
                                          Dense="true"
                                          Style="background:white; max-width:260px;" />
                        </MudItem>
                    </MudGrid>

                    @if (_isLoading)
                    {
                        <MudProgressLinear Indeterminate />
                    }
                    else
                    {
                        <!-- TABLE: BELUM POS -->
                        <MudTable Items="_pagedBelum"
                                  T="PenyediaanResitRow"
                                  Dense="true"
                                  Hover="true"
                                  Striped="true"
                                  Bordered="true"
                                  Elevation="0">
                            <HeaderContent>
                                <MudTh width="4%">
                                    <MudCheckBox T="bool"
                                                 Checked="@_allBelumChecked"
                                                 CheckedChanged="(v)=>ToggleSelectAll(v)" />
                                </MudTh>
                                <MudTh width="18%">No. Resit</MudTh>
                                <MudTh width="14%">Tarikh</MudTh>
                                <MudTh>Nama Penghutang</MudTh>
                                <MudTh width="12%">Status</MudTh>
                                <MudTh width="26%"></MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>
                                    <MudCheckBox T="bool"
                                                 Checked="@_selectedBelum.Contains(context.ID)"
                                                 CheckedChanged="(v)=>ToggleSelect(context.ID, v)" />
                                </MudTd>
                                <MudTd DataLabel="No. Resit">@context.NoResit</MudTd>
                                <MudTd DataLabel="Tarikh">@context.Tarikh?.ToString("dd/MM/yyyy")</MudTd>
                                <MudTd DataLabel="Nama Penghutang">@context.NamaPenghutang</MudTd>
                                <MudTd DataLabel="Status">@context.Status</MudTd>
                                <MudTd>
                                    <MudStack Row="true" Spacing="1">
                                        <MudButton Color="Color.Info"
                                                   Variant="Variant.Outlined"
                                                   Size="Size.Small"
                                                   OnClick="@(()=>SelectRow(context))">
                                            Pilih
                                        </MudButton>
                                        <MudButton Color="Color.Success"
                                                   Variant="Variant.Outlined"
                                                   Size="Size.Small"
                                                   OnClick="@(()=>PosSingle(context))">
                                            Pos
                                        </MudButton>
                                        <MudButton Color="Color.Error"
                                                   Variant="Variant.Outlined"
                                                   Size="Size.Small"
                                                   OnClick="@(()=>DeleteItem(context))">
                                            Hapus
                                        </MudButton>
                                        <MudButton Color="Color.Secondary"
                                                   Variant="Variant.Outlined"
                                                   Size="Size.Small"
                                                   OnClick="@(()=>ShowCorrection(context))">
                                            Ulasan Pembetulan
                                        </MudButton>
                                    </MudStack>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText Typo="Typo.caption">No data available in table</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        <!-- Footer -->
                        <MudGrid AlignItems="AlignItems.Center" Class="mt-2">
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.caption">
                                    Showing @(_totalBelum == 0 ? 0 : ((_pageBelum - 1) * _pageSizeBelum + 1))
                                    to @((Math.Min(_pageBelum * _pageSizeBelum, _totalBelum)))
                                    of @_totalBelum entries
                                </MudText>
                            </MudItem>
                            <MudItem xs="12" md="6" Class="d-flex justify-end">
                                <MudPagination Page="@_pageBelum"
                                               PageChanged="(p)=>_pageBelum = p"
                                               Count="@(Math.Max(1, (int)Math.Ceiling((double)_totalBelum/_pageSizeBelum)))"
                                               HidePrevNext="false"
                                               Class="my-0" />
                            </MudItem>
                        </MudGrid>

                        <MudDivider Class="my-3" />

                        <MudButton Color="Color.Success"
                                   Variant="Variant.Filled"
                                   StartIcon="@Icons.Material.Filled.CheckCircle"
                                   Disabled="@(!_selectedBelum.Any())"
                                   OnClick="PosSelected">
                            Pos Berkelompok
                        </MudButton>
                    }

                </MudTabPanel>

                <!-- ================= SUDAH POS ================= -->
                <MudTabPanel Text="Sudah Pos">

                    <!-- Controls -->
                    <MudGrid AlignItems="AlignItems.Center" Class="mb-2">
                        <MudItem xs="12" md="3">
                            <MudSelect T="int"
                                       Value="@_pageSizeSudah"
                                       ValueChanged="(v)=>{ _pageSizeSudah = v; _pageSudah = 1; }"
                                       Dense="true"
                                       Variant="Variant.Outlined"
                                       Style="background:white; width:100px;">
                                <MudSelectItem T="int" Value="10">10</MudSelectItem>
                                <MudSelectItem T="int" Value="25">25</MudSelectItem>
                                <MudSelectItem T="int" Value="50">50</MudSelectItem>
                                <MudSelectItem T="int" Value="100">100</MudSelectItem>
                            </MudSelect>
                            <MudText Typo="Typo.caption">records</MudText>
                        </MudItem>

                        <MudItem xs="12" md="9" Class="d-flex justify-end">
                            <MudText Typo="Typo.caption" Class="mr-2">Search:</MudText>
                            <MudTextField T="string"
                                          @bind-Value="_searchSudah"
                                          Immediate="true"
                                          Variant="Variant.Outlined"
                                          Dense="true"
                                          Style="background:white; max-width:260px;" />
                        </MudItem>
                    </MudGrid>

                    @if (_isLoading)
                    {
                        <MudProgressLinear Indeterminate />
                    }
                    else
                    {
                        <!-- TABLE: SUDAH POS -->
                        <MudTable Items="_pagedSudah"
                                  T="PenyediaanResitRow"
                                  Dense="true"
                                  Hover="true"
                                  Striped="true"
                                  Bordered="true"
                                  Elevation="0">
                            <HeaderContent>
                                <MudTh width="18%">No. Resit</MudTh>
                                <MudTh width="14%">Tarikh</MudTh>
                                <MudTh>Nama Penghutang</MudTh>
                                <MudTh width="12%">Status</MudTh>
                                <MudTh width="26%"></MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="No. Resit">@context.NoResit</MudTd>
                                <MudTd DataLabel="Tarikh">@context.Tarikh?.ToString("dd/MM/yyyy")</MudTd>
                                <MudTd DataLabel="Nama Penghutang">@context.NamaPenghutang</MudTd>
                                <MudTd DataLabel="Status">
                                    <MudChip T="string"
                                             Color="Color.Success"
                                             Variant="Variant.Filled"
                                             Size="Size.Small">
                                        @context.Status
                                    </MudChip>
                                </MudTd>
                                <MudTd>
                                    <MudButton Color="Color.Info"
                                               Variant="Variant.Outlined"
                                               Size="Size.Small"
                                               OnClick="@(()=>SelectRow(context))">
                                        Pilih
                                    </MudButton>
                                    <MudButton Color="Color.Secondary"
                                               Variant="Variant.Outlined"
                                               Size="Size.Small"
                                               Class="ml-1"
                                               OnClick="@(()=>ShowCorrection(context))">
                                        Ulasan Pembetulan
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText Typo="Typo.caption">No data available in table</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        <!-- Footer -->
                        <MudGrid AlignItems="AlignItems.Center" Class="mt-2">
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.caption">
                                    Showing @(_totalSudah == 0 ? 0 : ((_pageSudah - 1) * _pageSizeSudah + 1))
                                    to @((Math.Min(_pageSudah * _pageSizeSudah, _totalSudah)))
                                    of @_totalSudah entries
                                </MudText>
                            </MudItem>
                            <MudItem xs="12" md="6" Class="d-flex justify-end">
                                <MudPagination Page="@_pageSudah"
                                               PageChanged="(p)=>_pageSudah = p"
                                               Count="@(Math.Max(1, (int)Math.Ceiling((double)_totalSudah/_pageSizeSudah)))"
                                               HidePrevNext="false"
                                               Class="my-0" />
                            </MudItem>
                        </MudGrid>
                    }
                </MudTabPanel>

            </MudTabs>

        </MudCardContent>
    </MudCard>

</MudPaper>

@code {
    // ===== View model (UI) – map dari ResitDTO + Penghutang =====
    public class PenyediaanResitRow
    {
        public Guid ID { get; set; }
        public string? NoResit { get; set; }
        public DateTime? Tarikh { get; set; }
        public string? NamaPenghutang { get; set; }
        public Guid? PenghutangId { get; set; }
        public string Status { get; set; } = "Baru"; // "Baru" / "Pos"
        public bool SudahPos => string.Equals(Status, "Pos", StringComparison.OrdinalIgnoreCase);
    }

    // ===== State =====
    private bool _isLoading;
    private int _activeTab = 0;

    private List<PenyediaanResitRow> _all = new();
    private List<PenyelenggaraanPenghutangDTO> _allDebtors = new();

    // Belum Pos
    private int _pageBelum = 1;
    private int _pageSizeBelum = 10;
    private string _searchBelum = string.Empty;
    private HashSet<Guid> _selectedBelum = new();
    private bool _allBelumChecked =>
        _pagedBelum.Any() && _pagedBelum.All(x => _selectedBelum.Contains(x.ID));

    // Sudah Pos
    private int _pageSudah = 1;
    private int _pageSizeSudah = 10;
    private string _searchSudah = string.Empty;

    private Guid? _singleSelectedBelum =>
        _selectedBelum.Count == 1 ? _selectedBelum.First() : (Guid?)null;

    // ===== Filters & paging =====
    private IEnumerable<PenyediaanResitRow> _belumQuery =>
        _all
            .Where(x => !x.SudahPos)
            .Where(x => string.IsNullOrWhiteSpace(_searchBelum)
                || (x.NoResit?.Contains(_searchBelum, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.NamaPenghutang?.Contains(_searchBelum, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.Status?.Contains(_searchBelum, StringComparison.OrdinalIgnoreCase) ?? false));

    private IEnumerable<PenyediaanResitRow> _sudahQuery =>
        _all
            .Where(x => x.SudahPos)
            .Where(x => string.IsNullOrWhiteSpace(_searchSudah)
                || (x.NoResit?.Contains(_searchSudah, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.NamaPenghutang?.Contains(_searchSudah, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.Status?.Contains(_searchSudah, StringComparison.OrdinalIgnoreCase) ?? false));

    private List<PenyediaanResitRow> _pagedBelum => _belumQuery
        .OrderByDescending(x => x.Tarikh).ThenBy(x => x.NoResit)
        .Skip((_pageBelum - 1) * _pageSizeBelum).Take(_pageSizeBelum).ToList();

    private List<PenyediaanResitRow> _pagedSudah => _sudahQuery
        .OrderByDescending(x => x.Tarikh).ThenBy(x => x.NoResit)
        .Skip((_pageSudah - 1) * _pageSizeSudah).Take(_pageSizeSudah).ToList();

    private int _totalBelum => _belumQuery.Count();
    private int _totalSudah => _sudahQuery.Count();

    // ===== Lifecycle =====
    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            // Penghutang utk dapat nama
            var debtors = await PenghutangService.GetAllAsync();
            _allDebtors = debtors.Where(d => !string.IsNullOrWhiteSpace(d.Nama)).ToList();

            // Resit via API
            var resits = await ResitService.GetAllAsync();

            _all = (resits ?? new())
                .Where(r => r.ID.HasValue)
                .Select(r =>
                {
                    var debtor = _allDebtors.FirstOrDefault(d => d.ID == r.PenyelenggaraanPenghutangEntitiesID);
                    return new PenyediaanResitRow
                    {
                        ID = r.ID!.Value,
                        NoResit = r.NoResit,
                        Tarikh = r.Tarikh,
                        PenghutangId = r.PenyelenggaraanPenghutangEntitiesID,
                        NamaPenghutang = debtor?.Nama,
                        Status = MapStatusPosToStatus(r.StatusPos)
                    };
                })
                .ToList();

            _selectedBelum.Clear();
            _pageBelum = 1;
            _pageSudah = 1;
        }
        catch (Exception ex)
        {
            _all = new();
            Snackbar.Add($"Gagal memuatkan data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    // ===== Helper mapping status UI <-> DB =====
    private static string MapStatusPosToStatus(string? statusPos)
    {
        if (string.IsNullOrWhiteSpace(statusPos))
            return "Baru";

        var s = statusPos.Trim().ToUpperInvariant();
        return (s == "SUDAH POS" || s == "POS") ? "Pos" : "Baru";
    }

    private static string MapStatusToStatusPos(string? status)
    {
        if (string.Equals(status, "Pos", StringComparison.OrdinalIgnoreCase))
            return "SUDAH POS";

        return "BARU";
    }

    // ===== Selection helpers =====
    private void ToggleSelect(Guid id, bool selected)
    {
        if (selected)
            _selectedBelum.Add(id);
        else
            _selectedBelum.Remove(id);
    }

    private void ToggleSelectAll(bool selected)
    {
        if (selected)
        {
            foreach (var row in _pagedBelum)
                _selectedBelum.Add(row.ID);
        }
        else
        {
            foreach (var row in _pagedBelum)
                _selectedBelum.Remove(row.ID);
        }
    }

    private void ClearSelection()
    {
        _selectedBelum.Clear();
    }

    private void SelectRow(PenyediaanResitRow row)
    {
        // Sekadar highlight pilihan – nanti boleh sambung buka form / dialog
        _selectedBelum.Clear();
        _selectedBelum.Add(row.ID);
        Snackbar.Add($"Resit {row.NoResit} dipilih.", Severity.Info);
    }

    // ===== Action buttons atas =====
    private void AddNew()
    {
        // Boleh navigate ke page lain / buka dialog bila sedia
        Snackbar.Add("Fungsi Tambah resit belum diimplementasi (frontend sahaja).", Severity.Info);
    }

    private void EditSelected()
    {
        if (_singleSelectedBelum is Guid id)
        {
            var row = _all.FirstOrDefault(x => x.ID == id);
            if (row != null)
                Snackbar.Add($"Resit {row.NoResit} dipilih untuk ubah (sambung form kemudian).", Severity.Info);
        }
        else
        {
            Snackbar.Add("Sila pilih satu resit untuk diubah.", Severity.Warning);
        }
    }

    // ===== Row actions =====
    private async Task PosSingle(PenyediaanResitRow row)
    {
        var ok = await DialogService.ShowMessageBox(
            "Pengesahan",
            (MarkupString)$"Pos resit <b>{row.NoResit}</b>?",
            yesText: "Pos",
            cancelText: "Batal");

        if (ok is not true) return;

        try
        {
            var dto = await ResitService.GetByIdAsync(row.ID);
            dto.StatusPos = MapStatusToStatusPos("Pos");
            await ResitService.UpdateAsync(row.ID, dto);

            Snackbar.Add("Resit berjaya dipos.", Severity.Success);
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal pos resit: {ex.Message}", Severity.Error);
        }
    }

    private async Task PosSelected()
    {
        var ids = _selectedBelum.ToList();
        if (!ids.Any())
        {
            Snackbar.Add("Tiada resit dipilih.", Severity.Warning);
            return;
        }

        var ok = await DialogService.ShowMessageBox(
            "Pengesahan",
            (MarkupString)$"Pos berkelompok <b>{ids.Count}</b> resit terpilih?",
            yesText: "Pos",
            cancelText: "Batal");

        if (ok is not true) return;

        try
        {
            foreach (var id in ids)
            {
                var dto = await ResitService.GetByIdAsync(id);
                dto.StatusPos = MapStatusToStatusPos("Pos");
                await ResitService.UpdateAsync(id, dto);
            }

            Snackbar.Add("Resit terpilih berjaya dipos.", Severity.Success);
            _selectedBelum.Clear();
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal pos berkelompok: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteItem(PenyediaanResitRow row)
    {
        var ok = await DialogService.ShowMessageBox(
            "Pengesahan",
            (MarkupString)$"Padam resit <b>{row.NoResit}</b>?",
            yesText: "Padam",
            cancelText: "Batal");

        if (ok is not true) return;

        try
        {
            var resp = await ResitService.DeleteAsync(row.ID);
            if (!resp.IsSuccessStatusCode)
                throw new Exception(resp.Error?.Message ?? $"HTTP {(int)resp.StatusCode}");

            Snackbar.Add("Resit berjaya dipadam.", Severity.Success);
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal memadam resit: {ex.Message}", Severity.Error);
        }
    }

    private async Task ShowCorrection(PenyediaanResitRow row)
    {
        // Placeholder – nanti boleh sambung simpan ulasan dalam field lain
        await DialogService.ShowMessageBox(
            "Ulasan Pembetulan",
            (MarkupString)$"Tiada ulasan pembetulan disimpan untuk resit <b>{row.NoResit}</b>.",
            yesText: "Tutup");
    }
}
