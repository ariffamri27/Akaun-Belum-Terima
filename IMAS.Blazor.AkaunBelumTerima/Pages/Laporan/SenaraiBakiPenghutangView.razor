@page "/LaporanSenaraiBakiPenghutang"
@using MudBlazor
@using IMAS.API.AkaunBelumTerima.Shared.Models
@using IMAS.Blazor.AkaunBelumTerima.Services.Refit
@inject IPenyelenggaraanPenghutangApi PenghutangApi
@inject ISnackbar Snackbar

<MudPaper Class="pa-4">
    <MudCard Style="border-left:6px solid #2c7be5;">
        <MudCardHeader Class="py-2" Style="background:#2c7be5; color:white;">
            <MudText Typo="Typo.subtitle1" Class="pl-2">
                Laporan Senarai Baki Penghutang
            </MudText>
        </MudCardHeader>

        <MudCardContent>

            @if (_loading)
            {
                <MudProgressLinear Indeterminate="true" Class="mb-2" />
            }

            <!-- ===================== KRITERIA LAPORAN ===================== -->
            <MudGrid Class="mt-3 mb-4" Style="max-width:900px;">

                <!-- Tahun Kewangan -->
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.caption">Tahun Kewangan</MudText>
                    <MudSelect T="int?" @bind-Value="_selectedYear"
                               Dense="true" Variant="Variant.Outlined"
                               Style="background:white;">
                        <MudSelectItem T="int?" Value="@((int?)null)">Select...</MudSelectItem>
                        @foreach (var year in _years)
                        {
                            <MudSelectItem T="int?" Value="@year">@year</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <!-- Tarikh Mula -->
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.caption">Tarikh Mula</MudText>
                    <MudDatePicker @bind-Date="_startDate"
                                   Dense="true"
                                   Variant="Variant.Outlined"
                                   Format="dd/MM/yyyy"
                                   Style="background:white;" />
                </MudItem>

                <!-- Tarikh Akhir -->
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.caption">Tarikh Akhir</MudText>
                    <MudDatePicker @bind-Date="_endDate"
                                   Dense="true"
                                   Variant="Variant.Outlined"
                                   Format="dd/MM/yyyy"
                                   Style="background:white;" />
                </MudItem>

                <!-- Kategori Penghutang: kod + dropdown -->
                <MudItem xs="12" md="12" Class="mt-3">
                    <MudText Typo="Typo.caption">Kategori Penghutang</MudText>
                    <MudGrid>

                        <!-- Kod kategori (readonly) -->
                        <MudItem xs="12" md="3">
                            <MudTextField T="string"
                                          @bind-Value="_kategoriKod"
                                          Dense="true"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true"
                                          Style="background:white;" />
                        </MudItem>

                        <!-- Senarai kategori -->
                        <MudItem xs="12" md="9">
                            <MudSelect T="Guid?"
                                       Value="_selectedKategoriId"
                                       ValueChanged="OnKategoriChanged"
                                       Dense="true"
                                       Variant="Variant.Outlined"
                                       Style="background:white;">
                                <MudSelectItem T="Guid?" Value="@((Guid?)null)">
                                    Select...
                                </MudSelectItem>
                                @foreach (var k in _kategoriList)
                                {
                                    <MudSelectItem T="Guid?" Value="@k.ID">
                                        @($"{k.Kod} - {k.KeteranganKod}")
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>

                    </MudGrid>
                </MudItem>

            </MudGrid>

            <MudDivider Class="my-4" />

            <!-- ===================== HEADER LAPORAN (LOGO + TEKS) ===================== -->
            <MudGrid Justify="Justify.Center" Class="text-center my-4">
                <MudItem xs="12" sm="6">
                    <img src="/images/mpob_logo.png" style="width:180px;" />
                    <MudText Typo="Typo.subtitle1" Class="mt-2">
                        <b>LEMBAGA MINYAK SAWIT MALAYSIA</b>
                    </MudText>
                    <MudText Typo="Typo.subtitle2" Class="mb-4">
                        MALAYSIAN PALM OIL BOARD
                    </MudText>

                    <MudText Typo="Typo.body2">
                        6, Persiaran Institusi<br />
                        Bandar Baru Bangi<br />
                        43000 Kajang, Selangor.
                    </MudText>

                    <MudText Typo="Typo.body2" Class="mt-2">
                        Tel : +603-8769 4400<br />
                        Fax : +603-8925 9446
                    </MudText>

                    <MudText Typo="Typo.body2" Class="mb-6">
                        Website : www.mpob.gov.my
                    </MudText>

                    <MudText Typo="Typo.h6" Class="mt-4">
                        <b>SISTEM PENGURUSAN KEWANGAN</b>
                    </MudText>
                    <MudText Typo="Typo.body1">
                        SENARAI BAKI PENGHUTANG
                    </MudText>
                </MudItem>
            </MudGrid>

            <MudDivider Class="my-4" />

            <!-- ===================== TABLE SENARAI BAKI ===================== -->
            <MudTable T="BakiPenghutangRow"
                      Items="_rows"
                      Dense="true"
                      Hover="true"
                      Bordered="true"
                      Elevation="0">

                <HeaderContent>
                    <MudTh width="8%">Bil</MudTh>
                    <MudTh width="22%">Kategori</MudTh>
                    <MudTh width="14%">Kod</MudTh>
                    <MudTh>Nama</MudTh>
                    <MudTh width="16%" Class="text-end">Amaun (RM)</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd>@context.Bil</MudTd>
                    <MudTd>@context.Kategori</MudTd>
                    <MudTd>@context.Kod</MudTd>
                    <MudTd>@context.Nama</MudTd>
                    <MudTd Class="text-end">
                        @context.Amaun.ToString("N2")
                    </MudTd>
                </RowTemplate>

                <NoRecordsContent>
                    <MudText Typo="Typo.caption" Class="pa-3">
                        No data available in table
                    </MudText>
                </NoRecordsContent>
            </MudTable>

            <MudDivider Class="my-4" />

            <!-- ===================== BUTANG TINDAKAN ===================== -->
            <MudGrid Justify="Justify.Center" Class="mb-2">
                <MudItem>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Class="mx-2"
                               OnClick="Cetak">
                        Cetak
                    </MudButton>

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Success"
                               StartIcon="@Icons.Material.Filled.FileDownload"
                               Class="mx-2"
                               OnClick="ExportExcel">
                        Export Excel
                    </MudButton>

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Warning"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               Class="mx-2"
                               OnClick="KemaskiniBaki">
                        Kemaskini Baki
                    </MudButton>
                </MudItem>
            </MudGrid>

        </MudCardContent>
    </MudCard>
</MudPaper>

@code {
    private bool _loading;

    // ---- filter values ----
    private int? _selectedYear;
    private DateTime? _startDate;
    private DateTime? _endDate;

    private Guid? _selectedKategoriId;
    private string? _kategoriKod;

    // ---- sumber dropdown (daripada PenyelenggaraanPenghutangDTO) ----
    private List<int> _years = new();
    private List<PenyelenggaraanPenghutangDTO> _kategoriList = new();

    // ---- rows laporan (view-model) ----
    public class BakiPenghutangRow
    {
        public int Bil { get; set; }
        public string? Kategori { get; set; }
        public string? Kod { get; set; }
        public string? Nama { get; set; }
        public decimal Amaun { get; set; }
    }

    private List<BakiPenghutangRow> _rows = new();   // TIADA dummy data

    // ---- lifecycle ----
    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        try
        {
            var all = await PenghutangApi.GetAllAsync() ?? new List<PenyelenggaraanPenghutangDTO>();

            // Kategori = rekod yg ada Kod (master kategori penghutang)
            _kategoriList = all
                .Where(x => !string.IsNullOrWhiteSpace(x.Kod))
                .OrderBy(x => x.Kod)
                .ToList();

            // Tahun kewangan daripada field TahunKewangan
            _years = all
                .Where(x => x.TahunKewangan.HasValue)
                .Select(x => x.TahunKewangan!.Value)
                .Distinct()
                .OrderByDescending(x => x)
                .ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal memuatkan data penghutang: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private Task OnKategoriChanged(Guid? id)
    {
        _selectedKategoriId = id;
        var item = _kategoriList.FirstOrDefault(x => x.ID == id);
        _kategoriKod = item?.Kod ?? string.Empty;
        return Task.CompletedTask;
    }

    // ---- actions (stub – sambung API laporan bila sedia) ----
    private void Cetak()
    {
        Snackbar.Add("Fungsi Cetak belum dihubungkan ke API laporan.", Severity.Info);
    }

    private void ExportExcel()
    {
        Snackbar.Add("Fungsi Export Excel belum dihubungkan ke API laporan.", Severity.Info);
    }

    private void KemaskiniBaki()
    {
        Snackbar.Add("Fungsi Kemaskini Baki belum dihubungkan ke API.", Severity.Info);
    }
}
