@page "/penyediaan-bil"

@using IMAS.API.AkaunBelumTerima.Shared.Models
@using IMAS.Blazor.AkaunBelumTerima.Services.Refit
@using MudBlazor

@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IBillApi BilService
@inject IPenyelenggaraanPenghutangApi PenghutangService

<MudPaper Class="pa-4">

    <!-- ======================= PENYEDIAAN BIL ======================= -->
    <MudCard Class="mb-4" Style="border-left:6px solid #8e44ad;">
        <MudCardHeader Class="py-2" Style="background:#8e44ad; color:white;">
            <MudText Typo="Typo.subtitle1" Class="pl-2">Penyediaan Bil</MudText>
        </MudCardHeader>

        <MudCardContent>

            <MudTabs Rounded="true" @bind-ActivePanelIndex="_activeTab">
                <!-- ========== TAB: BELUM POS ========== -->
                <MudTabPanel Text="Belum Pos">
                    <!-- Controls -->
                    <MudGrid AlignItems="AlignItems.Center" Class="mb-2">
                        <MudItem xs="12" md="3">
                            <MudSelect T="int"
                                       Value="@_pageSizeBelum"
                                       ValueChanged="(v) => { _pageSizeBelum = v; _pageBelum = 1; }"
                                       Dense="true"
                                       Variant="Variant.Outlined"
                                       Style="background:white; width:100px;">
                                <MudSelectItem T="int" Value="10">10</MudSelectItem>
                                <MudSelectItem T="int" Value="25">25</MudSelectItem>
                                <MudSelectItem T="int" Value="50">50</MudSelectItem>
                                <MudSelectItem T="int" Value="100">100</MudSelectItem>
                            </MudSelect>
                            <MudText Typo="Typo.caption">records</MudText>
                        </MudItem>
                        <MudItem xs="12" md="9" Class="d-flex justify-end">
                            <MudText Typo="Typo.caption" Class="mr-2">Search:</MudText>
                            <MudTextField T="string"
                                          @bind-Value="_searchBelum"
                                          Immediate="true"
                                          Variant="Variant.Outlined"
                                          Dense="true"
                                          Style="background:white; max-width:260px;" />
                        </MudItem>
                    </MudGrid>

                    <!-- Table -->
                    @if (_isLoading)
                    {
                        <MudProgressLinear Indeterminate />
                    }
                    else
                    {
                        <MudTable Items="_pagedBelum"
                                  T="PenyediaanBilDTO"
                                  Dense="true"
                                  Hover="true"
                                  Striped="true"
                                  Bordered="true"
                                  Elevation="0">
                            <HeaderContent>
                                <MudTh width="6%"></MudTh>
                                <MudTh width="20%">No. Bil</MudTh>
                                <MudTh width="12%">Tarikh</MudTh>
                                <MudTh>Nama Penghutang</MudTh>
                                <MudTh width="10%">Status</MudTh>
                                <MudTh width="18%"></MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>
                                    <MudCheckBox T="bool"
                                                 Checked="@_selectedBelum.Contains(context.ID)"
                                                 CheckedChanged="(v) => ToggleSelect(context.ID, v)" />
                                </MudTd>
                                <MudTd DataLabel="No. Bil">@context.NoBil</MudTd>
                                <MudTd DataLabel="Tarikh">@context.Tarikh?.ToString("dd/MM/yyyy")</MudTd>
                                <MudTd DataLabel="Nama Penghutang">@context.NamaPenghutang</MudTd>
                                <MudTd DataLabel="Status">@context.Status</MudTd>
                                <MudTd>
                                    <MudStack Row="true" Spacing="1">
                                        <MudButton Color="Color.Info"
                                                   Variant="Variant.Outlined"
                                                   Size="Size.Small"
                                                   OnClick="(() => EditItem(context))">
                                            Pilih
                                        </MudButton>
                                        <MudButton Color="Color.Success"
                                                   Variant="Variant.Outlined"
                                                   Size="Size.Small"
                                                   OnClick="(() => PostSingle(context))">
                                            Pos
                                        </MudButton>
                                        <MudButton Color="Color.Error"
                                                   Variant="Variant.Outlined"
                                                   Size="Size.Small"
                                                   OnClick="(() => DeleteItem(context))">
                                            Hapus
                                        </MudButton>
                                    </MudStack>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText Typo="Typo.caption">No data available in table</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        <!-- Footer -->
                        <MudGrid AlignItems="AlignItems.Center" Class="mt-2">
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.caption">
                                    Showing @(_totalBelum == 0 ? 0 : ((_pageBelum - 1) * _pageSizeBelum + 1))
                                    to @((Math.Min(_pageBelum * _pageSizeBelum, _totalBelum)))
                                    of @_totalBelum entries
                                </MudText>
                            </MudItem>
                            <MudItem xs="12" md="6" Class="d-flex justify-end">
                                <MudPagination Page="@_pageBelum"
                                               PageChanged="(p) => _pageBelum = p"
                                               Count="@(Math.Max(1, (int)Math.Ceiling((double)_totalBelum / _pageSizeBelum)))"
                                               HidePrevNext="false"
                                               Class="my-0" />
                            </MudItem>
                        </MudGrid>

                        <MudDivider Class="my-3" />

                        <MudButton Color="Color.Success"
                                   Variant="Variant.Filled"
                                   StartIcon="@Icons.Material.Filled.LocalPostOffice"
                                   Disabled="@(!_selectedBelum.Any())"
                                   OnClick="PostSelected">
                            Pos Berkelompok
                        </MudButton>
                    }
                </MudTabPanel>

                <!-- ========== TAB: SUDAH POS ========== -->
                <MudTabPanel Text="Sudah Pos">
                    <!-- Controls -->
                    <MudGrid AlignItems="AlignItems.Center" Class="mb-2">
                        <MudItem xs="12" md="3">
                            <MudSelect T="int"
                                       Value="@_pageSizeSudah"
                                       ValueChanged="(v) => { _pageSizeSudah = v; _pageSudah = 1; }"
                                       Dense="true"
                                       Variant="Variant.Outlined"
                                       Style="background:white; width:100px;">
                                <MudSelectItem T="int" Value="10">10</MudSelectItem>
                                <MudSelectItem T="int" Value="25">25</MudSelectItem>
                                <MudSelectItem T="int" Value="50">50</MudSelectItem>
                                <MudSelectItem T="int" Value="100">100</MudSelectItem>
                            </MudSelect>
                            <MudText Typo="Typo.caption">records</MudText>
                        </MudItem>
                        <MudItem xs="12" md="9" Class="d-flex justify-end">
                            <MudText Typo="Typo.caption" Class="mr-2">Search:</MudText>
                            <MudTextField T="string"
                                          @bind-Value="_searchSudah"
                                          Immediate="true"
                                          Variant="Variant.Outlined"
                                          Dense="true"
                                          Style="background:white; max-width:260px;" />
                        </MudItem>
                    </MudGrid>

                    <!-- Table -->
                    @if (_isLoading)
                    {
                        <MudProgressLinear Indeterminate />
                    }
                    else
                    {
                        <MudTable Items="_pagedSudah"
                                  T="PenyediaanBilDTO"
                                  Dense="true"
                                  Hover="true"
                                  Striped="true"
                                  Bordered="true"
                                  Elevation="0">
                            <HeaderContent>
                                <MudTh width="20%">No. Bil</MudTh>
                                <MudTh width="12%">Tarikh</MudTh>
                                <MudTh>Nama Penghutang</MudTh>
                                <MudTh width="12%">Status</MudTh>
                                <MudTh width="18%"></MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="No. Bil">@context.NoBil</MudTd>
                                <MudTd DataLabel="Tarikh">@context.Tarikh?.ToString("dd/MM/yyyy")</MudTd>
                                <MudTd DataLabel="Nama Penghutang">@context.NamaPenghutang</MudTd>
                                <MudTd DataLabel="Status">@context.Status</MudTd>
                                <MudTd>
                                    <MudButton Color="Color.Info"
                                               Variant="Variant.Outlined"
                                               Size="Size.Small"
                                               OnClick="(() => EditItem(context))">
                                        Pilih
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText Typo="Typo.caption">No data available in table</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        <!-- Footer -->
                        <MudGrid AlignItems="AlignItems.Center" Class="mt-2">
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.caption">
                                    Showing @(_totalSudah == 0 ? 0 : ((_pageSudah - 1) * _pageSizeSudah + 1))
                                    to @((Math.Min(_pageSudah * _pageSizeSudah, _totalSudah)))
                                    of @_totalSudah entries
                                </MudText>
                            </MudItem>
                            <MudItem xs="12" md="6" Class="d-flex justify-end">
                                <MudPagination Page="@_pageSudah"
                                               PageChanged="(p) => _pageSudah = p"
                                               Count="@(Math.Max(1, (int)Math.Ceiling((double)_totalSudah / _pageSizeSudah)))"
                                               HidePrevNext="false"
                                               Class="my-0" />
                            </MudItem>
                        </MudGrid>
                    }
                </MudTabPanel>
            </MudTabs>

        </MudCardContent>
    </MudCard>

    <!-- ======================= BORANG BIL (Tambah / Ubah) ======================= -->
    <MudCard Style="border-left:6px solid #2c7be5;">
        <MudCardHeader Class="py-2" Style="background:#2c7be5; color:white;">
            <MudText Typo="Typo.subtitle1" Class="pl-2">
                @(_model.ID == Guid.Empty ? "Tambah Bil" : "Ubah Bil")
            </MudText>
        </MudCardHeader>
        <MudCardContent>

            <MudGrid Class="mb-2">
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.caption">No. Bil *</MudText>
                    <MudTextField T="string"
                                  @bind-Value="_model.NoBil"
                                  Dense="true"
                                  Variant="Variant.Outlined"
                                  Style="background:white;" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.caption">Tarikh *</MudText>
                    <MudDatePicker @bind-Date="_model.Tarikh"
                                   Dense="true"
                                   InputIcon="@Icons.Material.Filled.Event"
                                   Variant="Variant.Outlined"
                                   Style="background:white;" />
                </MudItem>
                <MudItem xs="12" md="5">
                    <MudText Typo="Typo.caption">Nama Penghutang *</MudText>
                    <MudAutocomplete T="PenyelenggaraanPenghutangDTO"
                                     @bind-Value="_selectedDebtorForForm"
                                     ToStringFunc="d => d is null ? string.Empty : d.Nama"
                                     SearchFunc="SearchDebtors"
                                     Dense="true"
                                     Variant="Variant.Outlined"
                                     Style="background:white;" />
                </MudItem>
            </MudGrid>

            <MudGrid>
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.caption">Status</MudText>
                    <MudTextField T="string"
                                  @bind-Value="_model.Status"
                                  Dense="true"
                                  Variant="Variant.Outlined"
                                  ReadOnly="true"
                                  Style="background:white;" />
                </MudItem>
            </MudGrid>

            <MudDivider Class="my-3" />

            <MudStack Row="true" Spacing="2">
                <MudButton Color="Color.Success"
                           Variant="Variant.Filled"
                           StartIcon="@Icons.Material.Filled.Save"
                           OnClick="SaveItem">
                    Simpan
                </MudButton>
                <MudButton Color="Color.Info"
                           Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.Restore"
                           OnClick="ResetForm">
                    Reset
                </MudButton>
                <MudButton Color="Color.Error"
                           Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.Delete"
                           Disabled="@(_model.ID == Guid.Empty)"
                           OnClick="(() => DeleteItem(_model))">
                    Padam
                </MudButton>
            </MudStack>

        </MudCardContent>
    </MudCard>

</MudPaper>

@code {
    // ===== View model (UI) – map dari BillDTO + PenyelenggaraanPenghutangDTO
    public class PenyediaanBilDTO
    {
        public Guid ID { get; set; }
        public string? NoBil { get; set; }
        public DateTime? Tarikh { get; set; }
        public string? NamaPenghutang { get; set; }
        public Guid? PenghutangId { get; set; }
        public string Status { get; set; } = "Baru"; // "Baru" / "Pos"
        public bool SudahPos => string.Equals(Status, "Pos", StringComparison.OrdinalIgnoreCase);
        public string? NotaPembetulan { get; set; }
    }

    // ===== State
    private bool _isLoading;
    private int _activeTab = 0;

    private List<PenyediaanBilDTO> _all = new();
    private List<PenyelenggaraanPenghutangDTO> _allDebtors = new();

    // Belum Pos
    private int _pageBelum = 1;
    private int _pageSizeBelum = 10;
    private string _searchBelum = string.Empty;
    private HashSet<Guid> _selectedBelum = new();

    // Sudah Pos
    private int _pageSudah = 1;
    private int _pageSizeSudah = 10;
    private string _searchSudah = string.Empty;

    // Form model
    private PenyediaanBilDTO _model = NewModel();
    private PenyelenggaraanPenghutangDTO? _selectedDebtorForForm;

    // ===== Filters & paging
    private IEnumerable<PenyediaanBilDTO> _belumQuery =>
        _all.Where(x => !x.SudahPos)
            .Where(x => string.IsNullOrWhiteSpace(_searchBelum)
                || (x.NoBil?.Contains(_searchBelum, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.NamaPenghutang?.Contains(_searchBelum, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.Status?.Contains(_searchBelum, StringComparison.OrdinalIgnoreCase) ?? false));

    private IEnumerable<PenyediaanBilDTO> _sudahQuery =>
        _all.Where(x => x.SudahPos)
            .Where(x => string.IsNullOrWhiteSpace(_searchSudah)
                || (x.NoBil?.Contains(_searchSudah, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.NamaPenghutang?.Contains(_searchSudah, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.Status?.Contains(_searchSudah, StringComparison.OrdinalIgnoreCase) ?? false));

    private List<PenyediaanBilDTO> _pagedBelum => _belumQuery
        .OrderByDescending(x => x.Tarikh).ThenBy(x => x.NoBil)
        .Skip((_pageBelum - 1) * _pageSizeBelum).Take(_pageSizeBelum).ToList();

    private List<PenyediaanBilDTO> _pagedSudah => _sudahQuery
        .OrderByDescending(x => x.Tarikh).ThenBy(x => x.NoBil)
        .Skip((_pageSudah - 1) * _pageSizeSudah).Take(_pageSizeSudah).ToList();

    private int _totalBelum => _belumQuery.Count();
    private int _totalSudah => _sudahQuery.Count();

    // ===== Lifecycle
    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            // Penghutang via Refit
            var respDeb = await PenghutangService.GetAllAsync();
            _allDebtors = respDeb
                .Where(d => !string.IsNullOrWhiteSpace(d.Nama))
                .ToList();

            // Bill via Refit
            var bills = await BilService.GetAllAsync();

            _all = bills
                .Select(b =>
                {
                    var debtor = _allDebtors.FirstOrDefault(d => d.ID == b.PenyelenggaraanPenghutangEntitiesID);
                    return new PenyediaanBilDTO
                    {
                        ID = b.ID,
                        NoBil = b.NoBil,
                        Tarikh = b.Tarikh,
                        PenghutangId = b.PenyelenggaraanPenghutangEntitiesID,
                        NamaPenghutang = debtor?.Nama,
                        Status = MapStatusPosToStatus(b.StatusPos),
                        NotaPembetulan = null
                    };
                })
                .ToList();
        }
        catch (Exception ex)
        {
            _all = new();
            Snackbar.Add($"Gagal memuatkan data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private static PenyediaanBilDTO NewModel() => new()
    {
        ID = Guid.Empty,
        NoBil = string.Empty,
        Tarikh = DateTime.Today,
        Status = "Baru"
    };

    // ===== Helper mapping status UI <-> DB
    private static string MapStatusPosToStatus(string? statusPos)
    {
        if (string.IsNullOrWhiteSpace(statusPos))
            return "Baru";

        return statusPos.Equals("SUDAH POS", StringComparison.OrdinalIgnoreCase) ||
               statusPos.Equals("POS", StringComparison.OrdinalIgnoreCase)
            ? "Pos"
            : "Baru";
    }

    private static string MapStatusToStatusPos(string? status)
    {
        if (string.Equals(status, "Pos", StringComparison.OrdinalIgnoreCase))
            return "SUDAH POS";

        return "BELUM POS";
    }

    private static BillDTO BuildBillFromModel(PenyediaanBilDTO model)
    {
        return new BillDTO
        {
            NoBil = model.NoBil,
            Tarikh = model.Tarikh,
            StatusPos = MapStatusToStatusPos(model.Status),
            PenyelenggaraanPenghutangEntitiesID = model.PenghutangId
        };
    }

    // ===== Table actions
    private void ToggleSelect(Guid id, bool selected)
    {
        if (selected)
            _selectedBelum.Add(id);
        else
            _selectedBelum.Remove(id);
    }

    private void EditItem(PenyediaanBilDTO row)
    {
        _model = new PenyediaanBilDTO
        {
            ID = row.ID,
            NoBil = row.NoBil,
            Tarikh = row.Tarikh,
            NamaPenghutang = row.NamaPenghutang,
            PenghutangId = row.PenghutangId,
            Status = row.Status,
            NotaPembetulan = row.NotaPembetulan
        };

        _selectedDebtorForForm = _allDebtors.FirstOrDefault(d => d.ID == row.PenghutangId);
        StateHasChanged();
    }

    private async Task PostSingle(PenyediaanBilDTO row)
    {
        var ok = await DialogService.ShowMessageBox(
            "Pengesahan",
            (MarkupString)$"Pos bil <b>{row.NoBil}</b>?",
            yesText: "Pos",
            cancelText: "Batal");

        if (ok is not true) return;

        try
        {
            var bill = await BilService.GetByIdAsync(row.ID);
            bill.StatusPos = "SUDAH POS";
            await BilService.UpdateAsync(row.ID, bill);

            Snackbar.Add("Bil berjaya dipos.", Severity.Success);
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal pos bil: {ex.Message}", Severity.Error);
        }
    }

    private async Task PostSelected()
    {
        var ids = _selectedBelum.ToList();

        var ok = await DialogService.ShowMessageBox(
            "Pengesahan",
            (MarkupString)$"Pos berkelompok <b>{ids.Count}</b> bil terpilih?",
            yesText: "Pos",
            cancelText: "Batal");

        if (ok is not true) return;

        try
        {
            foreach (var id in ids)
            {
                var bill = await BilService.GetByIdAsync(id);
                bill.StatusPos = "SUDAH POS";
                await BilService.UpdateAsync(id, bill);
            }

            Snackbar.Add("Bil terpilih berjaya dipos.", Severity.Success);
            _selectedBelum.Clear();
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal pos berkelompok: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteItem(PenyediaanBilDTO row)
    {
        var ok = await DialogService.ShowMessageBox(
            "Pengesahan",
            (MarkupString)$"Padam bil <b>{row.NoBil}</b>?",
            yesText: "Padam",
            cancelText: "Batal");

        if (ok is not true) return;

        try
        {
            var resp = await BilService.DeleteAsync(row.ID);
            if (!resp.IsSuccessStatusCode)
                throw new Exception(resp.Error?.Message ?? $"HTTP {(int)resp.StatusCode}");

            Snackbar.Add("Bil berjaya dipadam.", Severity.Success);
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal memadam: {ex.Message}", Severity.Error);
        }
    }

    // ===== Form actions
    private async Task SaveItem()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_model.NoBil) ||
                !_model.Tarikh.HasValue ||
                _selectedDebtorForForm is null)
            {
                Snackbar.Add("No. Bil, Tarikh dan Nama Penghutang wajib diisi.", Severity.Warning);
                return;
            }

            _model.PenghutangId = _selectedDebtorForForm.ID;
            _model.NamaPenghutang = _selectedDebtorForForm.Nama;

            if (_model.ID == Guid.Empty)
            {
                // CREATE
                var dto = BuildBillFromModel(_model);
                var created = await BilService.CreateAsync(dto);

                Snackbar.Add("Bil berjaya ditambah.", Severity.Success);
            }
            else
            {
                // UPDATE
                var existing = await BilService.GetByIdAsync(_model.ID);

                existing.NoBil = _model.NoBil;
                existing.Tarikh = _model.Tarikh;
                existing.StatusPos = MapStatusToStatusPos(_model.Status);
                existing.PenyelenggaraanPenghutangEntitiesID = _model.PenghutangId;

                var updated = await BilService.UpdateAsync(_model.ID, existing);

                Snackbar.Add("Bil berjaya dikemaskini.", Severity.Success);
            }

            ResetForm();
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal menyimpan: {ex.Message}", Severity.Error);
        }
    }

    private void ResetForm()
    {
        _model = NewModel();
        _selectedDebtorForForm = null;
    }

    // ===== Autocomplete penghutang
    private Task<IEnumerable<PenyelenggaraanPenghutangDTO>> SearchDebtors(
        string value,
        CancellationToken token)
    {
        IEnumerable<PenyelenggaraanPenghutangDTO> q = _allDebtors;

        if (!string.IsNullOrWhiteSpace(value))
        {
            var s = value.Trim();
            q = q.Where(d =>
                (d.Nama?.Contains(s, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (d.KodPenghutang?.Contains(s, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        return Task.FromResult(q);
    }
}
