@page "/pengesahan-bil"

@using IMAS.API.AkaunBelumTerima.Shared.Models
@using IMAS.Blazor.AkaunBelumTerima.Services.Refit
@using MudBlazor

@inject IBillApi BillApi
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudPaper Class="pa-4">

    <MudText Typo="Typo.h5">Pengesahan Bil</MudText>

    <MudTabs @bind-ActivePanelIndex="_activeTab"
             OnActivePanelIndexChanged="OnTabChanged"
             Class="mt-2 mb-2">
        <MudTabPanel Text="Bil Belum Disahkan" />
        <MudTabPanel Text="Bil Telah Disahkan" />
    </MudTabs>

    <MudTextField T="string"
                  Value="@_search"
                  ValueChanged="OnSearchChanged"
                  Placeholder="Cari No Bil / Penyedia / Keterangan"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Class="my-3"
                  Margin="Margin.Dense"
                  Immediate="true" />

    <MudTable T="BillDTO"
              @ref="_table"
              ServerData="LoadServerData"
              Hover="true"
              Bordered="true"
              Striped="true"
              Dense="true">

        <HeaderContent>
            <MudTh>No Bil</MudTh>
            <MudTh>Penyedia</MudTh>
            <MudTh>Tarikh</MudTh>
            <MudTh>Keterangan</MudTh>
            <MudTh class="text-end">Jumlah</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Aksi</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd>@context.NoBil</MudTd>
            <MudTd>@context.Penyedia</MudTd>
            <MudTd>@(context.Tarikh?.ToString("dd/MM/yyyy"))</MudTd>
            <MudTd>@context.Keterangan</MudTd>
            <MudTd Class="text-end">@context.Jumlah?.ToString("N2")</MudTd>
            <MudTd>
                <MudChip T="string"
                         Color="@GetStatusColor(context.StatusSah)"
                         Text="@context.StatusSah" />
            </MudTd>
            <MudTd>
                <MudStack Direction="Row" Spacing="1">
                    <MudButton Size="Size.Small"
                               Color="Color.Info"
                               Variant="Variant.Outlined"
                               OnClick="@(() => ViewDetail(context))">
                        Papar Butiran
                    </MudButton>

                    <MudButton Size="Size.Small"
                               Color="Color.Success"
                               Variant="Variant.Outlined"
                               Disabled="@(!IsBelumSah(context))"
                               OnClick="@(() => ConfirmBill(context))">
                        Sahkan
                    </MudButton>

                    <MudButton Size="Size.Small"
                               Color="Color.Error"
                               Variant="Variant.Outlined"
                               Disabled="@(!IsBelumSah(context))"
                               OnClick="@(() => CancelBill(context))">
                        Batalkan
                    </MudButton>
                </MudStack>
            </MudTd>
        </RowTemplate>

    </MudTable>

</MudPaper>

@code {
    private List<BillDTO> _bills = new();
    private MudTable<BillDTO>? _table;
    private int _activeTab = 0;   // 0 = Belum Sah, 1 = Telah Sah (SAH/BATAL)
    private string _search = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _bills = await BillApi.GetAllAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal memuatkan bil: {ex.Message}", Severity.Error);
        }
    }

    // Dipanggil oleh MudTable (server data mode)
    private Task<TableData<BillDTO>> LoadServerData(
        TableState state,
        CancellationToken token)
    {
        IEnumerable<BillDTO> query = _bills;

        // Tab filter
        if (_activeTab == 0)
        {
            // Bil belum sah (StatusSah null/empty atau "BELUM SAH")
            query = query.Where(IsBelumSah);
        }
        else
        {
            // Bil telah diproses (SAH atau BATAL)
            query = query.Where(b => !IsBelumSah(b));
        }

        // Search
        if (!string.IsNullOrWhiteSpace(_search))
        {
            query = query.Where(x =>
                (x.NoBil ?? "").Contains(_search, StringComparison.OrdinalIgnoreCase) ||
                (x.Penyedia ?? "").Contains(_search, StringComparison.OrdinalIgnoreCase) ||
                (x.Keterangan ?? "").Contains(_search, StringComparison.OrdinalIgnoreCase)
            );
        }

        // Paging
        var total = query.Count();
        var items = query
            .OrderByDescending(x => x.Tarikh)
            .ThenBy(x => x.NoBil)
            .Skip(state.Page * state.PageSize)
            .Take(state.PageSize)
            .ToList();

        return Task.FromResult(new TableData<BillDTO>
        {
            TotalItems = total,
            Items = items
        });
    }

    private void OnTabChanged(int index)
    {
        _activeTab = index;
        _ = ReloadTable();
    }

    private Task OnSearchChanged(string value)
    {
        _search = value ?? string.Empty;
        return ReloadTable();
    }

    private async Task ReloadTable()
    {
        if (_table is not null)
            await _table.ReloadServerData();
    }

    // Null atau kosong kita treat sebagai "BELUM SAH"
    private bool IsBelumSah(BillDTO bill)
        => string.IsNullOrWhiteSpace(bill.StatusSah) ||
           string.Equals(bill.StatusSah, "BELUM SAH", StringComparison.OrdinalIgnoreCase);

    private Color GetStatusColor(string? status)
    {
        return status?.ToUpperInvariant() switch
        {
            "SUDAH SAH" => Color.Success,
            "BELUM SAH" or null or "" => Color.Warning,
            "BATAL" => Color.Error,
            _ => Color.Default
        };
    }

    private void ViewDetail(BillDTO bill)
    {
        // TODO: navigate ke page butiran / buka dialog detail
        // Boleh guna DialogService kalau nak paparkan butiran ringkas.
    }

    private async Task ConfirmBill(BillDTO bill)
    {
        var ok = await DialogService.ShowMessageBox(
            "Pengesahan",
            (MarkupString)$"Sahkan bil <b>{bill.NoBil}</b>?",
            yesText: "Sahkan",
            cancelText: "Batal");

        if (ok is not true) return;

        try
        {
            bill.StatusSah = "SUDAH SAH";

            await BillApi.UpdateAsync(bill.ID, bill);
            Snackbar.Add("Bil berjaya disahkan.", Severity.Success);

            _bills = await BillApi.GetAllAsync();
            await ReloadTable();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal mengesahkan bil: {ex.Message}", Severity.Error);
        }
    }

    private async Task CancelBill(BillDTO bill)
    {
        var ok = await DialogService.ShowMessageBox(
            "Pengesahan",
            (MarkupString)$"Batalkan bil <b>{bill.NoBil}</b>?",
            yesText: "Batalkan",
            cancelText: "Kembali");

        if (ok is not true) return;

        try
        {
            bill.StatusSah = "BATAL";

            await BillApi.UpdateAsync(bill.ID, bill);
            Snackbar.Add("Bil berjaya dibatalkan.", Severity.Success);

            _bills = await BillApi.GetAllAsync();
            await ReloadTable();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal membatalkan bil: {ex.Message}", Severity.Error);
        }
    }
}
