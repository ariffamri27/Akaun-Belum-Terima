@page "/unit"
@using IMAS.API.Belanjawan.Shared.Models
@using IMAS.Blazor.Belanjawan.Services.Refit
@inject IUnitApi UnitApi
@inject ISnackbar Snackbar

<PageTitle>Unit</PageTitle>

<MudPaper Class="p-4 mx-auto" Style="max-width: 1000px;">
    <MudText Typo="Typo.h5">Senarai Unit dan Keterangan</MudText>

    <MudStack Row Justify="Justify.SpaceBetween" Class="mb-2">
        <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Print">Cetak</MudButton>
        <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.FileDownload">Export Excel</MudButton>
    </MudStack>

    <MudTable Items="@UnitList" Dense Hover>
        <HeaderContent>
            <MudTh>Dana</MudTh>
            <MudTh>Bahagian</MudTh>
            <MudTh>Unit</MudTh>
            <MudTh>Keterangan</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.Dana?.DanaName</MudTd>
            <MudTd>@context.Bahagian?.BahagianName</MudTd>
            <MudTd>@context.UnitName</MudTd>
            <MudTd>@context.Keterangan</MudTd>
            <MudTd>
                <MudButton Color="Color.Primary" Size="Size.Small" OnClick="@(() => SelectUnit(context))">Pilih</MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>

    <MudDivider Class="my-4" />

    @if (SelectedUnit != null)
    {
        <MudText Typo="Typo.h6" GutterBottom>Maklumat Unit</MudText>

        <MudStack Spacing="2">
            <MudTextField Label="Dana" Value="@SelectedUnit.Dana?.DanaName" ReadOnly />
            <MudTextField Label="Bahagian" Value="@SelectedUnit.Bahagian?.BahagianName" ReadOnly />
            <MudTextField Label="Unit" @bind-Value="SelectedUnit.UnitName" ReadOnly="@(!IsEditing)" />
            <MudTextField Label="Keterangan" Value="@SelectedUnit.Keterangan" ReadOnly />
        </MudStack>

        <MudStack Row Spacing="2" Class="mt-3">
            <MudButton Color="Color.Primary" Disabled="@IsEditing" OnClick="EnableEdit">Ubah</MudButton>
            <MudButton Color="Color.Success" Disabled="@(!IsEditing)" OnClick="SaveEdit">Simpan</MudButton>
            <MudButton Color="Color.Secondary" OnClick="CancelEdit">Batal</MudButton>
        </MudStack>
    }
</MudPaper>

@code {
    private List<UnitDTO> UnitList = new();
    private UnitDTO? SelectedUnit;
    private bool IsEditing = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUnits();
    }

    private async Task LoadUnits()
    {
        try
        {
            UnitList = await UnitApi.GetAllAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal memuat Unit: {ex.Message}", Severity.Error);
        }
    }

    private void SelectUnit(UnitDTO unit)
    {
        SelectedUnit = new UnitDTO
        {
            ID = unit.ID,
            DanaID = unit.DanaID,
            BahagianID = unit.BahagianID,
            UnitName = unit.UnitName,
            Keterangan = unit.Keterangan,
            Dana = unit.Dana,
            Bahagian = unit.Bahagian
        };
        IsEditing = false;
    }

    private void EnableEdit() => IsEditing = true;

    private void CancelEdit() => IsEditing = false;

    private async Task SaveEdit()
    {
        if (SelectedUnit == null)
            return;

        try
        {
            var payload = new UnitDTO
            {
                ID = SelectedUnit.ID,
                UnitName = SelectedUnit.UnitName,
                Keterangan = SelectedUnit.Keterangan,
                DanaID = SelectedUnit.DanaID,
                BahagianID = SelectedUnit.BahagianID
            };

            var res = await UnitApi.UpdateAsync(payload.ID, payload);
            if (res.IsSuccessStatusCode)
            {
                Snackbar.Add("Unit berjaya dikemaskini", Severity.Success);
                await LoadUnits();
                IsEditing = false;
            }
            else
            {
                var content = await res.Content.ReadAsStringAsync();
                Snackbar.Add($"Gagal simpan kemaskini: {content}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ralat: {ex.Message}", Severity.Error);
        }
    }
}
