@page "/pertanyaan-vot"
@using IMAS.API.Belanjawan.Shared.Models
@using IMAS.Blazor.Belanjawan.Services.Refit
@using IMAS.Blazor.Belanjawan.Services.Refit.Belanjawan
@using MudBlazor
@inject IPertanyaanVotApi PertanyaanVotService
@inject IDialogService DialogService
@inject IDanaApi DanaService
@inject IBahagianApi BahagianService
@inject IUnitApi UnitService


<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5">Senarai Pertanyaan Vot</MudText>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    }
    else
    {
        <MudTable Items="_pertanyaanVotList" Hover="true">
            <HeaderContent>
                <MudTh>ID</MudTh>
                <MudTh>Tahun</MudTh>
                <MudTh>Vot Code</MudTh>
                <MudTh>Dana ID</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="ID">@context.ID</MudTd>
                <MudTd>@context.Tahun</MudTd>
                <MudTd>@context.VotCode</MudTd>
                <MudTd>@context.DanaID</MudTd>
                <MudTd>
                    <MudButton Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditPertanyaanVot(context))">Edit</MudButton>
                    <MudButton Color="Color.Error" Size="Size.Small" OnClick="@(() => DeletePertanyaanVot(context.ID))">Hapus</MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }

    <MudDivider Class="my-4" />

    <MudText Typo="Typo.h6">@(_isEdit ? "Kemaskini Pertanyaan Vot" : "Tambah Pertanyaan Vot")</MudText>
    <MudTextField Label="Tahun" @bind-Value="_pertanyaanVotForm.Tahun" />
    <MudTextField Label="Vot Code" @bind-Value="_pertanyaanVotForm.VotCode" />
    <MudTextField Label="Keterangan" @bind-Value="_pertanyaanVotForm.Keterangan" />
    <MudSelect T="Guid" Label="Dana" @bind-Value="_pertanyaanVotForm.DanaID">
        @foreach (var dana in _danaList)
        {
            <MudSelectItem T="Guid" Value="@(dana.Id)">@dana.DanaName</MudSelectItem>
        }
    </MudSelect>
    <MudSelect T="Guid" Label="Bahagian" @bind-Value="_pertanyaanVotForm.BahagianID">
        @foreach (var bahagian in _bahagianList)
        {
            <MudSelectItem T="Guid" Value="@(bahagian.ID)">@bahagian.BahagianName</MudSelectItem>
        }
    </MudSelect>
    <MudSelect T="Guid" Label="Unit" @bind-Value="_pertanyaanVotForm.UnitID">
        @foreach (var unit in _unitList)
        {
            <MudSelectItem T="Guid" Value="@(unit.ID)">@unit.UnitName</MudSelectItem>
        }
    </MudSelect>

    <MudButton Color="Color.Success" OnClick="SavePertanyaanVot">Simpan</MudButton>
    <MudButton Color="Color.Default" OnClick="ResetForm">Batal</MudButton>
</MudPaper>

@code {
    private List<PertanyaanVotDTO> _pertanyaanVotList = new();
    private PertanyaanVotDTO _pertanyaanVotForm = new();
    private bool _isEdit = false;
    private bool _isLoading = false;
    private List<DanaDTO> _danaList = new();
    private List<BahagianDTO> _bahagianList = new();
    private List<UnitDTO> _unitList = new();

    protected override async Task OnInitializedAsync()
    {
        _danaList = await DanaService.GetAllAsync();
        _bahagianList = await BahagianService.GetAllAsync();
        _unitList = await UnitService.GetAllAsync();

        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        _pertanyaanVotList = await PertanyaanVotService.GetAllAsync();
        _isLoading = false;
    }

    private void EditPertanyaanVot(PertanyaanVotDTO p)
    {
        _pertanyaanVotForm = new PertanyaanVotDTO
        {
            ID = p.ID,
            Tahun = p.Tahun,
            VotCode = p.VotCode,
            Keterangan = p.Keterangan,
            DanaID = p.DanaID,
            BahagianID = p.BahagianID,
            UnitID = p.UnitID
        };
        _isEdit = true;
    }

    private async Task SavePertanyaanVot()
    {
        try
        {
            if (_isEdit)
            {
                await PertanyaanVotService.UpdateAsync(_pertanyaanVotForm.ID, _pertanyaanVotForm);
            }
            else
            {
                await PertanyaanVotService.CreateAsync(_pertanyaanVotForm);
            }

            await LoadData();
            ResetForm();
        }
        catch (Exception ex)
        {
            await DialogService.ShowMessageBox("Ralat", $"Gagal simpan rekod. {ex.Message}");
        }
    }

    private async Task DeletePertanyaanVot(Guid id)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Pasti?",
            "Anda pasti mahu hapus rekod ini?",
            yesText: "Ya",
            cancelText: "Batal"
        );

        if (confirm == true)
        {
            var response = await PertanyaanVotService.DeleteAsync(id);
            if (response.IsSuccessStatusCode)
            {
                await LoadData();
            }
            else
            {
                await DialogService.ShowMessageBox("Ralat", "Gagal menghapuskan rekod.");
            }
        }
    }

    private void ResetForm()
    {
        _pertanyaanVotForm = new();
        _isEdit = false;
    }
}
