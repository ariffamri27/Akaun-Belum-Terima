@page "/pengesahan-viremen-sekatan"
@using IMAS.API.Belanjawan.Shared.Models
@using IMAS.Blazor.Belanjawan.Services.Refit.Belanjawan
@using MudBlazor
@inject IViremenSekatanApi ViremenSekatanService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5" GutterBottom>Pengesahan Viremen Sekatan</MudText>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    }
    else
    {
        <MudTable Items="_viremenSekatanList" Hover="true" Striped="true" Dense="true">
            <HeaderContent>
                <MudTh>No Viremen</MudTh>
                <MudTh>Tarikh</MudTh>
                <MudTh>Keterangan</MudTh>
                <MudTh>Penyedia</MudTh>
                <MudTh>Pengesah</MudTh>
                <MudTh>Pelulus</MudTh>
                <MudTh>Aksi</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.NoViremen</MudTd>
                <MudTd>@context.Tarikh.ToShortDateString()</MudTd>
                <MudTd>@context.Keterangan</MudTd>
                <MudTd>@context.Penyedia</MudTd>
                <MudTd>@context.Pengesah</MudTd>
                <MudTd>@context.Pelulus</MudTd>
                <MudTd>
                    <MudButton Size="Size.Small" Color="Color.Info" OnClick="@(() => Pilih(context))">Pilih</MudButton>
                    <MudButton Size="Size.Small" Color="Color.Primary" OnClick="@(() => UpdateStatus(context.ID, "Sah"))">Sah</MudButton>
                    <MudButton Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteViremenSekatan(context.ID))">Hapus</MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudPaper>

@code {
    private List<ViremenSekatanDTO> _viremenSekatanList = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        var allItems = await ViremenSekatanService.GetAllAsync() ?? new List<ViremenSekatanDTO>();
        _viremenSekatanList = allItems.Where(x => x.StatusSah == "Belum Sah" || x.StatusSah == "Sudah Sah").ToList();
        _isLoading = false;
    }

    private async Task Pilih(ViremenSekatanDTO item)
    {
        Snackbar.Add($"Dipilih: {item.NoViremen}", Severity.Info);
    }

    private async Task UpdateStatus(Guid id, string statusBaru)
    {
        try
        {
            var viremenSekatan = _viremenSekatanList.FirstOrDefault(v => v.ID == id);
            if (viremenSekatan != null)
            {
                viremenSekatan.StatusSah = statusBaru;
                await ViremenSekatanService.UpdateAsync(id, viremenSekatan);
                Snackbar.Add($"Status berjaya dikemaskini ke '{statusBaru}'", Severity.Success);
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal mengemaskini status: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteViremenSekatan(Guid id)
    {
        bool? confirm = await DialogService.ShowMessageBox("Pasti?", "Anda pasti mahu hapus rekod ini?", yesText: "Ya", cancelText: "Batal");
        if (confirm == true)
        {
            var response = await ViremenSekatanService.DeleteAsync(id);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Rekod berjaya dihapuskan.", Severity.Success);
                await LoadData();
            }
            else
            {
                Snackbar.Add("Gagal menghapuskan rekod.", Severity.Error);
            }
        }
    }
}
