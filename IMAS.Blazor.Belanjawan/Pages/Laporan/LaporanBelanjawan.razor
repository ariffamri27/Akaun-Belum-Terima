@page "/laporan-belanjawan"
@using IMAS.API.Belanjawan.Shared.Models
@using IMAS.Blazor.Belanjawan.Services.Refit
@using IMAS.Blazor.Belanjawan.Services.Refit.Belanjawan
@using MudBlazor
@inject IDanaApi DanaService
@inject IBahagianApi BahagianService
@inject IUnitApi UnitService
@inject ILokasiApi LokasiService
@inject ILaporanBelanjawanApi LaporanService
@inject ISnackbar Snackbar

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5" GutterBottom>Laporan Belanjawan</MudText>

    <MudGrid>
        <!-- Date Picker for 'Tarikh Mula' -->
        <MudItem xs="12" sm="6">
            <MudDatePicker Label="Tarikh Mula" @bind-Value="_laporanForm.TarikhMula" />
        </MudItem>

        <!-- Date Picker for 'Tarikh Akhir' -->
        <MudItem xs="12" sm="6">
            <MudDatePicker Label="Tarikh Akhir" @bind-Value="_laporanForm.TarikhAkhir" />
        </MudItem>

        <!-- Dana Dropdown -->
        <MudItem xs="12" sm="6">
            <MudSelect T="Guid" Label="Dana" @bind-Value="_laporanForm.DanaID">
                @foreach (var dana in _danaList)
                {
                    <MudSelectItem T="Guid" Value="@(dana.Id)">@dana.DanaName</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <!-- Bahagian Dropdown -->
        <MudItem xs="12" sm="6">
            <MudSelect T="Guid" Label="Bahagian" @bind-Value="_laporanForm.BahagianID">
                @foreach (var bahagian in _bahagianList)
                {
                    <MudSelectItem T="Guid" Value="@(bahagian.ID)">@bahagian.BahagianName</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <!-- Unit Dropdown -->
        <MudItem xs="12" sm="6">
            <MudSelect T="Guid" Label="Unit" @bind-Value="_laporanForm.UnitID">
                @foreach (var unit in _unitList)
                {
                    <MudSelectItem T="Guid" Value="@(unit.ID)">@unit.UnitName</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <!-- Lokasi Dropdown -->
        <MudItem xs="12" sm="6">
            <MudSelect T="Guid" Label="Lokasi" @bind-Value="_laporanForm.LokasiID">
                @foreach (var lokasi in _lokasiList)
                {
                    <MudSelectItem T="Guid" Value="@(lokasi.ID)">@lokasi.LokasiName</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <!-- Paras Input Field -->
        <MudItem xs="12" sm="6">
            <MudTextField Label="Paras" @bind-Value="_laporanForm.Paras" />
        </MudItem>
    </MudGrid>

    <!-- Submit and Reset buttons -->
    <MudButton Color="Color.Primary" OnClick="GenerateReport">Cetak</MudButton>
    <MudButton Color="Color.Default" OnClick="ResetForm">Batal</MudButton>
</MudPaper>

@code {
    private LaporanBelanjawanDTO _laporanForm = new LaporanBelanjawanDTO();
    private List<DanaDTO> _danaList = new List<DanaDTO>();
    private List<BahagianDTO> _bahagianList = new List<BahagianDTO>();
    private List<UnitDTO> _unitList = new List<UnitDTO>();
    private List<LokasiDTO> _lokasiList = new List<LokasiDTO>();

    protected override async Task OnInitializedAsync()
    {
        await LoadDropdownData();
    }

    private async Task LoadDropdownData()
    {
        try
        {
            // Fetch data for dropdowns using Refit APIs
            _danaList = await DanaService.GetAllAsync();
            _bahagianList = await BahagianService.GetAllAsync();
            _unitList = await UnitService.GetAllAsync();
            _lokasiList = await LokasiService.GetAllAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal memuat data dropdown: {ex.Message}", Severity.Error);
        }
    }

    private async Task GenerateReport()
    {
        try
        {
            if (_laporanForm.TarikhMula > _laporanForm.TarikhAkhir)
            {
                Snackbar.Add("Tarikh Mula tidak boleh lebih besar dari Tarikh Akhir", Severity.Warning);
                return;
            }

            // Call API to generate report with the selected data
            var laporan = await LaporanService.CreateAsync(_laporanForm);
            Snackbar.Add($"Laporan {laporan.ID} berjaya dicetak.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal mencetak laporan: {ex.Message}", Severity.Error);
        }
    }

    private void ResetForm()
    {
        _laporanForm = new LaporanBelanjawanDTO();
    }
}
