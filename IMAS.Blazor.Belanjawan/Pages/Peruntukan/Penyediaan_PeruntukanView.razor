@page "/penyediaan-peruntukan"
@using IMAS.API.Belanjawan.Shared.Models
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime
@inject IMAS.Blazor.Belanjawan.Services.Refit.Belanjawan.IPenyediaanPeruntukanApi PenyediaanApi

<PageTitle>Penyediaan Peruntukan</PageTitle>

<MudPaper Class="p-4 mx-auto" Style="max-width: 1000px;">
    <MudText Typo="Typo.h5" GutterBottom>Penyediaan Peruntukan</MudText>

    <MudTabs>
        <MudTabPanel Text="Belum Pos">
            <MudTable Items="BelumPosList" Hover="true" Striped="true">
                <HeaderContent>
                    <MudTh>No. Peruntukan</MudTh>
                    <MudTh>Tarikh</MudTh>
                    <MudTh>Keterangan</MudTh>
                    <MudTh>Penyedia</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.NoPeruntukan</MudTd>
                    <MudTd>@(context.Tarikh?.ToString("dd/MM/yyyy"))</MudTd>
                    <MudTd>@context.Keterangan</MudTd>
                    <MudTd>@context.Penyedia</MudTd>
                    <MudTd>
                        <MudButton Color="Color.Primary" Size="Size.Small" OnClick="@(() => OnPilihClicked(context))">Pilih</MudButton>
                        <MudButton Color="Color.Success" Size="Size.Small" OnClick="@(() => OnPosClicked(context))">POS</MudButton>
                        <MudButton Color="Color.Error" Size="Size.Small" OnClick="@(() => OnHapusClicked(context))">Hapus</MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudTabPanel>

        <MudTabPanel Text="Sudah Pos">
            <MudTable Items="SudahPosList" Hover="true" Striped="true">
                <HeaderContent>
                    <MudTh>No. Peruntukan</MudTh>
                    <MudTh>Tarikh</MudTh>
                    <MudTh>Keterangan</MudTh>
                    <MudTh>Penyedia</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.NoPeruntukan</MudTd>
                    <MudTd>@(context.Tarikh?.ToString("dd/MM/yyyy"))</MudTd>
                    <MudTd>@context.Keterangan</MudTd>
                    <MudTd>@context.Penyedia</MudTd>
                </RowTemplate>
            </MudTable>
        </MudTabPanel>
    </MudTabs>

    <MudDivider Class="my-4" />

    <MudStack Row Spacing="2">
        <MudButton Color="Color.Success" OnClick="@OnTambahClicked">+ Tambah</MudButton>

        @if (IsViewMode)
        {
            <MudButton Color="Color.Primary" OnClick="OnUbahClicked">Ubah</MudButton>
        }
        @if (IsEditMode)
        {
            <MudButton Color="Color.Warning" OnClick="OnSimpanClicked">Simpan</MudButton>
        }
    </MudStack>

    @if (SelectedPenyediaan != null)
    {
        <MudDivider Class="my-4" />
        <MudText Typo="Typo.h6">Maklumat Peruntukan</MudText>
        <MudStack Spacing="2">
            <MudTextField Label="No. Peruntukan" @bind-Value="SelectedPenyediaan.NoPeruntukan" Disabled="@(!IsFormEditable)" />
            <MudDatePicker Label="Tarikh" @bind-Date="SelectedPenyediaan.Tarikh" Disabled="@(!IsFormEditable)" />
            <MudTextField Label="Keterangan" @bind-Value="SelectedPenyediaan.Keterangan" Disabled="@(!IsFormEditable)" Lines="3" />
            <MudTextField Label="Penyedia" @bind-Value="SelectedPenyediaan.Penyedia" Disabled="@(!IsFormEditable)" />
        </MudStack>
    }
</MudPaper>

@code {
    private List<PeruntukanDTO> PenyediaanList = new();
    private List<PeruntukanDTO> BelumPosList => PenyediaanList.Where(p => p.Status == "BelumPos").ToList();
    private List<PeruntukanDTO> SudahPosList => PenyediaanList.Where(p => p.Status == "Pos").ToList();

    private enum FormMode { Add, View, Edit }
    private FormMode CurrentFormMode = FormMode.Add;

    private PeruntukanDTO? SelectedPenyediaan;

    private bool IsFormEditable => CurrentFormMode == FormMode.Edit;
    private bool IsAddMode => CurrentFormMode == FormMode.Add;
    private bool IsViewMode => CurrentFormMode == FormMode.View && SelectedPenyediaan != null;
    private bool IsEditMode => CurrentFormMode == FormMode.Edit && SelectedPenyediaan != null;

    protected override async Task OnInitializedAsync()
    {
        await RefreshList();
    }

    private void OnUbahClicked()
    {
        CurrentFormMode = FormMode.Edit;
    }

    private void OnPilihClicked(PeruntukanDTO selected)
    {
        SelectedPenyediaan = new PeruntukanDTO
        {
            ID = selected.ID,
            NoPeruntukan = selected.NoPeruntukan,
            Tarikh = selected.Tarikh,
            Keterangan = selected.Keterangan,
            Penyedia = selected.Penyedia,
            TahunKewangan = selected.TahunKewangan,
            DanaID = selected.DanaID,
            BahagianID = selected.BahagianID,
            UnitID = selected.UnitID,
            LokasiID = selected.LokasiID,
            Status = selected.Status,
            CreatedBy = selected.CreatedBy,
            CreatedAt = selected.CreatedAt
        };
        CurrentFormMode = FormMode.View;
    }

    private async Task OnSimpanClicked()
    {
        if (SelectedPenyediaan is not null)
        {
            try
            {
                await PenyediaanApi.UpdateAsync(SelectedPenyediaan.ID, SelectedPenyediaan);
                Snackbar.Add("Maklumat peruntukan dikemaskini.", Severity.Success);
                await RefreshList();
                CurrentFormMode = FormMode.View;
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Gagal mengemaskini: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OnPosClicked(PeruntukanDTO p)
    {
        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm", $"Anda pasti mahu POS No. {p.NoPeruntukan}?");
        if (confirmed)
        {
            try
            {
                p.Status = "Pos";
                await PenyediaanApi.UpdateAsync(p.ID, p);
                Snackbar.Add("Status berjaya ditukar ke 'Pos'.", Severity.Success);
                await RefreshList();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Gagal POS: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OnHapusClicked(PeruntukanDTO p)
    {
        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm", $"Anda pasti mahu hapus No. {p.NoPeruntukan}?");
        if (confirmed)
        {
            try
            {
                var result = await PenyediaanApi.DeleteAsync(p.ID);
                if (result.IsSuccessStatusCode)
                {
                    Snackbar.Add("Rekod berjaya dihapuskan.", Severity.Success);
                    await RefreshList();
                    SelectedPenyediaan = null;
                    CurrentFormMode = FormMode.Add;
                }
                else
                {
                    Snackbar.Add("Gagal menghapus rekod.", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Ralat: {ex.Message}", Severity.Error);
            }
        }
    }

    private void OnTambahClicked()
    {
        Navigation.NavigateTo("/penyediaan-peruntukan-tambah");
    }

    private async Task RefreshList()
    {
        try
        {
            PenyediaanList = await PenyediaanApi.GetAllAsync() ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal memuat data: {ex.Message}", Severity.Error);
        }
    }
}
