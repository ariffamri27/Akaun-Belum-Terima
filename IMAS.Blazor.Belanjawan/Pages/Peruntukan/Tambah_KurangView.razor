@page "/tambah-kurang"
@using IMAS.API.Belanjawan.Shared.Models
@using IMAS.Blazor.Belanjawan.Services.Refit.Belanjawan
@inject ITambahKurangPeruntukanApi TambahKurangService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Tambah / Kurang Peruntukan</PageTitle>

<MudPaper Class="p-4 mx-auto" Style="max-width: 1000px;">
    <MudText Typo="Typo.h5" GutterBottom>Senarai Tambah/Kurang Peruntukan</MudText>

    <MudTable Items="TambahKurangList" Hover="true" Striped="true" Dense="true">
        <HeaderContent>
            <MudTh>No. Peruntukan</MudTh>
            <MudTh>Tarikh</MudTh>
            <MudTh>Keterangan</MudTh>
            <MudTh>Tambah (RM)</MudTh>
            <MudTh>Kurang (RM)</MudTh>
            <MudTh>Tindakan</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.NoPeruntukan</MudTd>
            <MudTd>@context.Tarikh.ToString("dd/MM/yyyy")</MudTd>
            <MudTd>@context.Keterangan</MudTd>
            <MudTd>@context.AmaunTambah.ToString("N2")</MudTd>
            <MudTd>@context.AmaunKurang.ToString("N2")</MudTd>
            <MudTd>
                <MudButton Size="Size.Small" Color="Color.Info" OnClick="() => OnEditClicked(context)">Pilih</MudButton>
                <MudButton Size="Size.Small" Color="Color.Error" OnClick="() => OnDeleteClicked(context.ID)">Hapus</MudButton>
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>

    <MudDivider Class="my-4" />

    <MudText Typo="Typo.h5" GutterBottom>Maklumat Tambah/Kurang</MudText>

    <MudStack Spacing="2">
        <MudTextField Label="No. Peruntukan *" @bind-Value="Form.NoPeruntukan" />
        <MudDatePicker Label="Tarikh"
                       Date="Form.Tarikh"
                       DateChanged="@(v => Form.Tarikh = v ?? DateTime.Today)"
                       Immediate="true" />
        <MudTextField Label="Keterangan" @bind-Value="Form.Keterangan" Lines="3" />
        <MudTextField Label="Amaun Tambah (RM)" @bind-Value="Form.AmaunTambah" Adornment="Adornment.End" AdornmentText="RM" />
        <MudTextField Label="Amaun Kurang (RM)" @bind-Value="Form.AmaunKurang" Adornment="Adornment.End" AdornmentText="RM" />
    </MudStack>

    <MudStack Row Spacing="2" Class="mt-4">
        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="OnSave">Simpan</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Default" OnClick="ResetForm">Batal</MudButton>
    </MudStack>
</MudPaper>

@code {
    private List<TambahKurangPeruntukanDTO> TambahKurangList = new();
    private TambahKurangPeruntukanDTO Form = new();
    private bool IsEditMode = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        TambahKurangList = await TambahKurangService.GetAllAsync();
    }

    private void OnEditClicked(TambahKurangPeruntukanDTO data)
    {
        Form = new TambahKurangPeruntukanDTO
        {
            ID = data.ID,
            NoPeruntukan = data.NoPeruntukan,
            Tarikh = data.Tarikh,
            PeruntukanID = data.PeruntukanID,
            AmaunTambah = data.AmaunTambah,
            AmaunKurang = data.AmaunKurang,
            Keterangan = data.Keterangan
        };
        IsEditMode = true;
    }

    private async Task OnSave()
    {
        try
        {
            if (IsEditMode)
                await TambahKurangService.UpdateAsync(Form.ID, Form);
            else
                await TambahKurangService.CreateAsync(Form);

            Snackbar.Add("Rekod berjaya disimpan.", Severity.Success);
            await LoadData();
            ResetForm();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ralat menyimpan: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnDeleteClicked(Guid id)
    {
        bool? confirm = await DialogService.ShowMessageBox("Pasti?", "Anda pasti mahu hapus rekod ini?", "Ya", "Batal");
        if (confirm == true)
        {
            var result = await TambahKurangService.DeleteAsync(id);
            if (result.IsSuccessStatusCode)
            {
                Snackbar.Add("Rekod dihapus.", Severity.Success);
                await LoadData();
            }
            else
            {
                Snackbar.Add("Gagal hapus rekod.", Severity.Error);
            }
        }
    }

    private void ResetForm()
    {
        Form = new TambahKurangPeruntukanDTO();
        IsEditMode = false;
    }
}
