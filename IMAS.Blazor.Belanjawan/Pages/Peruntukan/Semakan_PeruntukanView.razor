@page "/semakan-peruntukan"
@using IMAS.API.Belanjawan.Shared.Models
@using IMAS.Blazor.Belanjawan.Services.Refit
@using IMAS.Blazor.Belanjawan.Services.Refit.Belanjawan
@using MudBlazor
@inject ISemakanPeruntukanApi SemakanService
@inject IDialogService DialogService
@inject IPenyediaanPeruntukanApi PeruntukanService

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5">Senarai Semakan Peruntukan</MudText>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    }
    else
    {
        <MudTable Items="_semakanList" Hover="true">
            <HeaderContent>
                <MudTh>ID</MudTh>
                <MudTh>Peruntukan Name</MudTh>
                <MudTh>Status Semakan</MudTh>
                <MudTh>Disemak Oleh</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.ID</MudTd>
                <MudTd>@context.Peruntukan?.NoPeruntukan</MudTd>
                <MudTd>@context.StatusSemakan</MudTd>
                <MudTd>@context.DisemakOleh</MudTd>
                <MudTd>
                    <MudButton Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditSemakan(context))">Edit</MudButton>
                    <MudButton Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteSemakan(context.ID))">Hapus</MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }

    <MudDivider Class="my-4" />

    <MudText Typo="Typo.h6">@(_isEdit ? "Kemaskini Semakan" : "Tambah Semakan")</MudText>
    <MudTextField Label="Disemak Oleh" @bind-Value="_semakanForm.DisemakOleh" />
    <MudTextField Label="Ulasan" @bind-Value="_semakanForm.Ulasan" />
    <MudSelect T="Guid" Label="Peruntukan" Value="_semakanForm.PeruntukanID" ValueChanged="@(value => _semakanForm.PeruntukanID = value)">
        @foreach (var peruntukan in _peruntukanList)
        {
            <!-- Use Guid? directly for the Value of MudSelectItem -->
            <MudSelectItem T="Guid" Value="@(peruntukan.ID)">@peruntukan.NoPeruntukan</MudSelectItem>
        }
    </MudSelect>

    <MudButton Color="Color.Success" OnClick="SaveSemakan">Simpan</MudButton>
    <MudButton Color="Color.Default" OnClick="ResetForm">Batal</MudButton>
</MudPaper>

@code {
    private List<SemakanPeruntukanDTO> _semakanList = new();
    private SemakanPeruntukanDTO _semakanForm = new();
    private bool _isEdit = false;
    private bool _isLoading = false;
    private List<PeruntukanDTO> _peruntukanList = new();  // Declare peruntukan list

    protected override async Task OnInitializedAsync()
    {
        _peruntukanList = await PeruntukanService.GetAllAsync();  // Load Peruntukan list
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        _semakanList = await SemakanService.GetAllAsync();  // Fetch semakan peruntukan data
        _isLoading = false;
    }

    private void EditSemakan(SemakanPeruntukanDTO s)
    {
        _semakanForm = s;
        _isEdit = true;
    }

    private async Task SaveSemakan()
    {
        try
        {
            if (_isEdit)
            {
                await SemakanService.UpdateAsync(_semakanForm.ID, _semakanForm);  // Update semakan
            }
            else
            {
                await SemakanService.CreateAsync(_semakanForm);  // Create semakan
            }

            await LoadData();
            ResetForm();
        }
        catch (Exception ex)
        {
            await DialogService.ShowMessageBox("Ralat", $"Gagal simpan rekod. {ex.Message}");
        }
    }

    private async Task DeleteSemakan(Guid id)
    {
        try
        {
            var response = await SemakanService.DeleteAsync(id);
            if (response.IsSuccessStatusCode)
            {
                await LoadData();  // Refresh the data after deletion
            }
            else
            {
                await DialogService.ShowMessageBox("Ralat", "Gagal menghapuskan rekod.");
            }
        }
        catch (Exception ex)
        {
            await DialogService.ShowMessageBox("Ralat", $"Gagal menghapuskan rekod: {ex.Message}");
        }
    }

    private void ResetForm()
    {
        _semakanForm = new();
        _isEdit = false;
    }
}
