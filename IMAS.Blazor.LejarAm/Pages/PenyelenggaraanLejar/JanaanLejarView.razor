@page "/janaan-lejar-am"
@using IMAS.API.LejarAm.Shared.Models
@using IMAS.Blazor.LejarAm.Services.Refit
@using MudBlazor
@using Microsoft.AspNetCore.Components.Web
@inject IPenyelenggaraanLejarApi PenyelenggaraanLejarService
@inject ISnackbar Snackbar

<MudPaper Class="pa-4">

    <!-- ======================= 1) JANAAN LEJAR AM ======================= -->
    <MudCard Class="mb-4" Style="border-left:6px solid #16a085;">
        <MudCardHeader Class="py-2" Style="background:#16a085; color:white;">
            <MudText Typo="Typo.subtitle1" Class="pl-2">Janaan Lejar Am</MudText>
        </MudCardHeader>
        <MudCardContent>

            <!-- Filters row -->
            <MudGrid Class="mb-2">
                <!-- Dana (mapped to Kategori) -->
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.caption">Dana</MudText>
                    <MudSelect T="string" @bind-Value="_janaan_Dana" Variant="Variant.Outlined" Dense="true" Style="background:white;">
                        <MudSelectItem T="string" Value="@("")">Select</MudSelectItem>
                        @foreach (var d in _distinctKategori)
                        {
                            <MudSelectItem T="string" Value="@d">@d</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <!-- Bahagian (free text) -->
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.caption">Bahagian</MudText>
                    <MudTextField T="string" @bind-Value="_janaan_Bahagian"
                                  Variant="Variant.Outlined" Dense="true"
                                  Placeholder="Carian program..."
                                  Style="background:white;" />
                </MudItem>

                <!-- Unit (mapped to JenisAkaun) -->
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.caption">Unit</MudText>
                    <MudSelect T="string" @bind-Value="_janaan_Unit" Variant="Variant.Outlined" Dense="true" Style="background:white;">
                        <MudSelectItem T="string" Value="@("")">Select</MudSelectItem>
                        @foreach (var u in _distinctJenisAkaun)
                        {
                            <MudSelectItem T="string" Value="@u">@u</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <!-- Lokasi (free text; mapped to JenisAliran) -->
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.caption">Lokasi</MudText>
                    <MudTextField T="string" @bind-Value="_janaan_Lokasi"
                                  Variant="Variant.Outlined" Dense="true"
                                  Placeholder="Carian jabatan..."
                                  Style="background:white;" />
                </MudItem>
            </MudGrid>

            <!-- Table controls -->
            <MudGrid AlignItems="AlignItems.Center" Class="mb-2">
                <MudItem xs="12" md="3">
                    <MudSelect T="int" Value="_pageSize1" ValueChanged="(v) => { _pageSize1 = v; _page1 = 1; }"
                               Dense="true" Variant="Variant.Outlined" Style="background:white; width:100px;">
                        <MudSelectItem T="int" Value="10">10</MudSelectItem>
                        <MudSelectItem T="int" Value="25">25</MudSelectItem>
                        <MudSelectItem T="int" Value="50">50</MudSelectItem>
                        <MudSelectItem T="int" Value="100">100</MudSelectItem>
                    </MudSelect>
                    <MudText Typo="Typo.caption">records</MudText>
                </MudItem>

                <MudItem xs="12" md="9" Class="d-flex justify-end">
                    <MudText Typo="Typo.caption" Class="mr-2">Search:</MudText>
                    <MudTextField T="string" @bind-Value="_search1" Immediate="true"
                                  Variant="Variant.Outlined" Dense="true"
                                  Style="background:white; max-width:240px;" />
                </MudItem>
            </MudGrid>

            <!-- Table -->
            @if (_isLoading)
            {
                <MudProgressLinear Indeterminate Color="Color.Primary" />
            }
            else
            {
                <MudTable Items="_pagedList1" Dense="true" Hover="true" Striped="true" T="PenyelenggaraanLejarDTO">
                    <HeaderContent>
                        <MudTh width="20%">Dana</MudTh>
                        <MudTh width="20%">Bahagian</MudTh>
                        <MudTh width="15%">Unit</MudTh>
                        <MudTh width="15%">Lokasi</MudTh>
                        <MudTh>Keterangan</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <!-- Map to existing fields: Kategori, Keterangan, JenisAkaun, JenisAliran -->
                        <MudTd DataLabel="Dana">@context.Kategori</MudTd>
                        <MudTd DataLabel="Bahagian">@context.Keterangan</MudTd>
                        <MudTd DataLabel="Unit">@context.JenisAkaun</MudTd>
                        <MudTd DataLabel="Lokasi">@context.JenisAliran</MudTd>
                        <MudTd DataLabel="Keterangan">@context.Keterangan</MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.caption">No data available in table</MudText>
                    </NoRecordsContent>
                </MudTable>

                <!-- Footer: count + print -->
                <MudGrid AlignItems="AlignItems.Center" Class="mt-2">
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.caption">
                            Showing @(_total1 == 0 ? 0 : ((_page1 - 1) * _pageSize1 + 1))
                            to @((Math.Min(_page1 * _pageSize1, _total1)))
                            of @_total1 entries
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" md="6" Class="d-flex justify-end">
                        <MudButton Color="Color.Success" Variant="Variant.Filled" StartIcon="Icons.Material.Filled.Print"
                                   OnClick="@(()=>Snackbar.Add("Cetak belum diimplementasi.", Severity.Info))">
                            Cetak
                        </MudButton>
                    </MudItem>
                </MudGrid>
            }
        </MudCardContent>
    </MudCard>

    <!-- ======================= 2) KOD KEWANGAN ======================= -->
    <MudCard Class="mb-2" Style="border-left:6px solid #2c7be5;">
        <MudCardHeader Class="py-2" Style="background:#2c7be5; color:white;">
            <MudText Typo="Typo.subtitle1" Class="pl-2">Kod Kewangan</MudText>
        </MudCardHeader>
        <MudCardContent>

            <!-- Filters row -->
            <MudGrid Class="mb-2" AlignItems="AlignItems.End">
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.caption">Tahun Kewangan *</MudText>
                    <MudSelect T="int?" @bind-Value="_tahunKewangan" Dense="true" Variant="Variant.Outlined" Style="background:white;">
                        @foreach (var y in _distinctTahun)
                        {
                            <MudSelectItem T="int?" Value="@y">@y</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.caption">Pilih Paras</MudText>
                    <MudSelect T="int?" @bind-Value="_pilihParas" Dense="true" Variant="Variant.Outlined" Style="background:white;">
                        <MudSelectItem T="int?" Value="@((int?)1)">1 - AKAUN</MudSelectItem>
                        <MudSelectItem T="int?" Value="@((int?)2)">2 - OBJEK</MudSelectItem>
                        <MudSelectItem T="int?" Value="@((int?)3)">3 - OBJEK AM</MudSelectItem>
                        <MudSelectItem T="int?" Value="@((int?)4)">4 - OBJEK LANJUT</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.caption">Carian</MudText>
                    <MudSelect T="string" @bind-Value="_carianParas" Dense="true" Variant="Variant.Outlined" Style="background:white;">
                        <MudSelectItem T="string" Value="@("")">Select Level</MudSelectItem>
                        <MudSelectItem T="string" Value="@("Level 1")">Level 1</MudSelectItem>
                        <MudSelectItem T="string" Value="@("Level 2")">Level 2</MudSelectItem>
                        <MudSelectItem T="string" Value="@("Level 3")">Level 3</MudSelectItem>
                        <MudSelectItem T="string" Value="@("Level 4")">Level 4</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="1" Class="d-flex">
                    <MudButton Color="Color.Success" Class="mt-4" OnClick="@(() => _page2 = 1)">Carian</MudButton>
                </MudItem>
            </MudGrid>

            <!-- Table controls -->
            <MudGrid AlignItems="AlignItems.Center" Class="mb-2">
                <MudItem xs="12" md="3">
                    <MudSelect T="int" Value="_pageSize2" ValueChanged="(v) => { _pageSize2 = v; _page2 = 1; }"
                               Dense="true" Variant="Variant.Outlined" Style="background:white; width:100px;">
                        <MudSelectItem T="int" Value="10">10</MudSelectItem>
                        <MudSelectItem T="int" Value="25">25</MudSelectItem>
                        <MudSelectItem T="int" Value="50">50</MudSelectItem>
                        <MudSelectItem T="int" Value="100">100</MudSelectItem>
                    </MudSelect>
                    <MudText Typo="Typo.caption">records</MudText>
                </MudItem>

                <MudItem xs="12" md="9" Class="d-flex justify-end">
                    <MudText Typo="Typo.caption" Class="mr-2">Search:</MudText>
                    <MudTextField T="string" @bind-Value="_search2" Immediate="true"
                                  Variant="Variant.Outlined" Dense="true"
                                  Style="background:white; max-width:240px;" />
                </MudItem>
            </MudGrid>

            <!-- Table -->
            @if (_isLoading)
            {
                <MudProgressLinear Indeterminate Color="Color.Primary" />
            }
            else
            {
                <MudTable Items="_pagedList2" Dense="true" Hover="true" Striped="true" T="PenyelenggaraanLejarDTO">
                    <HeaderContent>
                        <MudTh width="25%">Akaun</MudTh>
                        <MudTh>Keterangan</MudTh>
                        <MudTh width="15%">Kategori</MudTh>
                        <MudTh width="10%">Paras</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Akaun">@context.KodAkaun</MudTd>
                        <MudTd DataLabel="Keterangan">@context.Keterangan</MudTd>
                        <MudTd DataLabel="Kategori">@context.Kategori</MudTd>
                        <MudTd DataLabel="Paras">@context.Paras</MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.caption">No data available in table</MudText>
                    </NoRecordsContent>
                </MudTable>

                <!-- Footer: count + action -->
                <MudGrid AlignItems="AlignItems.Center" Class="mt-2">
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.caption">
                            Showing @(_total2 == 0 ? 0 : ((_page2 - 1) * _pageSize2 + 1))
                            to @((Math.Min(_page2 * _pageSize2, _total2)))
                            of @_total2 entries
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" md="6" Class="d-flex justify-end">
                        <MudButton Color="Color.Success" Variant="Variant.Filled" EndIcon="Icons.Material.Filled.PlayArrow"
                                   OnClick="@(()=>Snackbar.Add("Janaan belum diimplementasi.", Severity.Info))">
                            Jana
                        </MudButton>
                    </MudItem>
                </MudGrid>
            }
        </MudCardContent>
    </MudCard>

</MudPaper>

@code {
    private bool _isLoading;

    // Raw data
    private List<PenyelenggaraanLejarDTO> _all = new();

    // Distincts for dropdowns
    private List<string> _distinctKategori = new();
    private List<string> _distinctJenisAkaun = new();
    private List<int?> _distinctTahun = new();

    // ========== Section 1 (Janaan Lejar Am) ==========
    private string _janaan_Dana = string.Empty;     // maps to Kategori
    private string _janaan_Bahagian = string.Empty; // free text (use Keterangan)
    private string _janaan_Unit = string.Empty;     // maps to JenisAkaun
    private string _janaan_Lokasi = string.Empty;   // free text (use JenisAliran)
    private string _search1 = string.Empty;

    private int _page1 = 1;
    private int _pageSize1 = 10;

    private IEnumerable<PenyelenggaraanLejarDTO> _filtered1 =>
        _all
            .Where(x => string.IsNullOrWhiteSpace(_janaan_Dana) || string.Equals(x.Kategori, _janaan_Dana, StringComparison.OrdinalIgnoreCase))
            .Where(x => string.IsNullOrWhiteSpace(_janaan_Bahagian) || (x.Keterangan?.Contains(_janaan_Bahagian, StringComparison.OrdinalIgnoreCase) ?? false))
            .Where(x => string.IsNullOrWhiteSpace(_janaan_Unit) || string.Equals(x.JenisAkaun, _janaan_Unit, StringComparison.OrdinalIgnoreCase))
            .Where(x => string.IsNullOrWhiteSpace(_janaan_Lokasi) || (x.JenisAliran?.Contains(_janaan_Lokasi, StringComparison.OrdinalIgnoreCase) ?? false))
            .Where(x => string.IsNullOrWhiteSpace(_search1)
                || (x.KodAkaun?.Contains(_search1, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.Keterangan?.Contains(_search1, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.Kategori?.Contains(_search1, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.JenisAkaun?.Contains(_search1, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.JenisAliran?.Contains(_search1, StringComparison.OrdinalIgnoreCase) ?? false));

    private List<PenyelenggaraanLejarDTO> _pagedList1 => _filtered1
        .OrderBy(x => x.Kategori).ThenBy(x => x.JenisAkaun).ThenBy(x => x.Keterangan)
        .Skip((_page1 - 1) * _pageSize1).Take(_pageSize1).ToList();

    private int _total1 => _filtered1.Count();

    // ========== Section 2 (Kod Kewangan) ==========
    private int? _tahunKewangan = DateTime.Now.Year;
    private int? _pilihParas = 4;
    private string _carianParas = string.Empty;
    private string _search2 = string.Empty;

    private int _page2 = 1;
    private int _pageSize2 = 10;

    private IEnumerable<PenyelenggaraanLejarDTO> _filtered2 =>
        _all
            .Where(x => !_tahunKewangan.HasValue || x.Tahun == _tahunKewangan)
            .Where(x => !_pilihParas.HasValue || x.Paras == _pilihParas)
            .Where(x => string.IsNullOrWhiteSpace(_carianParas) || (x.Keterangan?.Contains(_carianParas, StringComparison.OrdinalIgnoreCase) ?? false))
            .Where(x => string.IsNullOrWhiteSpace(_search2)
                || (x.KodAkaun?.Contains(_search2, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.Keterangan?.Contains(_search2, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.Kategori?.Contains(_search2, StringComparison.OrdinalIgnoreCase) ?? false));

    private List<PenyelenggaraanLejarDTO> _pagedList2 => _filtered2
        .OrderBy(x => x.KodAkaun)
        .Skip((_page2 - 1) * _pageSize2).Take(_pageSize2).ToList();

    private int _total2 => _filtered2.Count();

    // Shared
    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            var resp = await PenyelenggaraanLejarService.GetAllPenyelenggaraanLejar();
            if (!resp.IsSuccessStatusCode) throw new Exception($"HTTP {(int)resp.StatusCode}: {resp.Error?.Message}");
            _all = resp.Content ?? new();

            _distinctKategori = _all.Select(x => x.Kategori ?? "").Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().OrderBy(x => x).ToList();
            _distinctJenisAkaun = _all.Select(x => x.JenisAkaun ?? "").Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().OrderBy(x => x).ToList();
            _distinctTahun = _all.Select(x => x.Tahun).Where(y => y.HasValue).Distinct().OrderByDescending(x => x).ToList();

            if (!_distinctTahun.Any()) _distinctTahun = new List<int?> { DateTime.Now.Year };
            _tahunKewangan ??= _distinctTahun.First();
        }
        catch (Exception ex)
        {
            _all = new();
            Snackbar.Add($"Gagal memuatkan data: {ex.Message}", Severity.Error);
        }
        finally { _isLoading = false; }
    }
}
