@page "/pengaktifan-kod-lejar"
@using IMAS.API.LejarAm.Shared.Models
@using IMAS.Blazor.LejarAm.Services.Refit
@using MudBlazor
@using Microsoft.AspNetCore.Components.Web
@inject IPenyelenggaraanLejarApi PenyelenggaraanLejarService
@inject ISnackbar Snackbar

<MudPaper Class="pa-4">

    <!-- ======================= Pengaktifan Kod Lejar ======================= -->
    <MudCard Class="mb-2" Style="border-left:6px solid #2c7be5;">
        <MudCardHeader Class="py-2" Style="background:#2c7be5; color:white;">
            <MudText Typo="Typo.subtitle1" Class="pl-2">Pengaktifan Kod Lejar</MudText>
        </MudCardHeader>

        <MudCardContent>

            <!-- Filters row: Tahun | Paras | Bahagian | Kategori -->
            <MudGrid Class="mb-2">
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.caption">Pilih Tahun</MudText>
                    <MudSelect T="int?" @bind-Value="_filterTahun" Dense="true" Variant="Variant.Outlined" Style="background:white;">
                        @foreach (var y in _distinctTahun)
                        {
                            <MudSelectItem T="int?" Value="@y">@y</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.caption">Pilih Paras</MudText>
                    <MudSelect T="int?" @bind-Value="_filterParas" Dense="true" Variant="Variant.Outlined" Style="background:white;">
                        <MudSelectItem T="int?" Value="@((int?)1)">1 - OBJEK AM</MudSelectItem>
                        <MudSelectItem T="int?" Value="@((int?)2)">2 - SUB OBJEK</MudSelectItem>
                        <MudSelectItem T="int?" Value="@((int?)3)">3 - DETAIL</MudSelectItem>
                        <MudSelectItem T="int?" Value="@((int?)4)">4 - OBJEK LANJUT</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.caption">Pilih Bahagian</MudText>
                    <MudSelect T="string" @bind-Value="_filterBahagian" Dense="true" Variant="Variant.Outlined" Clearable Style="background:white;">
                        <MudSelectItem T="string" Value="@("")">Pilih Bahagian</MudSelectItem>
                        @foreach (var b in _distinctBahagian)
                        {
                            <MudSelectItem T="string" Value="@b">@b</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.caption">Pilih Kategori</MudText>
                    <MudSelect T="string" @bind-Value="_filterKategori" Dense="true" Variant="Variant.Outlined" Clearable Style="background:white;">
                        <MudSelectItem T="string" Value="@("")">Select Category</MudSelectItem>
                        @foreach (var k in _distinctKategori)
                        {
                            <MudSelectItem T="string" Value="@k">@k</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            </MudGrid>

            <!-- controls row: records + Search -->
            <MudGrid AlignItems="AlignItems.Center" Class="mb-2">
                <MudItem xs="12" md="3">
                    <MudSelect T="int" Value="_pageSize" ValueChanged="(v) => { _pageSize = v; _page = 1; }"
                               Dense="true" Variant="Variant.Outlined" Style="background:white; width:100px;">
                        <MudSelectItem T="int" Value="10">10</MudSelectItem>
                        <MudSelectItem T="int" Value="25">25</MudSelectItem>
                        <MudSelectItem T="int" Value="50">50</MudSelectItem>
                        <MudSelectItem T="int" Value="100">100</MudSelectItem>
                    </MudSelect>
                    <MudText Typo="Typo.caption">records</MudText>
                </MudItem>

                <MudItem xs="12" md="9" Class="d-flex justify-end">
                    <MudText Typo="Typo.caption" Class="mr-2">Search:</MudText>
                    <MudTextField T="string" @bind-Value="_search" Immediate="true" Variant="Variant.Outlined" Dense="true"
                                  Style="background:white; max-width:260px;" />
                </MudItem>
            </MudGrid>

            <!-- Table -->
            @if (_isLoading)
            {
                <MudProgressLinear Indeterminate Color="Color.Primary" />
            }
            else
            {
                <MudTable Items="_pagedList" Dense="true" Hover="true" Striped="true" T="PenyelenggaraanLejarDTO">
                    <HeaderContent>
                        <MudTh width="20%">Kod</MudTh>
                        <MudTh>Keterangan</MudTh>
                        <MudTh width="12%">Status</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Kod">@context.KodAkaun</MudTd>
                        <MudTd DataLabel="Keterangan">@context.Keterangan</MudTd>
                        <MudTd DataLabel="Status">@context.Status</MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.caption">No data available in table</MudText>
                    </NoRecordsContent>
                </MudTable>

                <!-- footer: pager right, actions left -->
                <MudGrid AlignItems="AlignItems.Center" Class="mt-2">
                    <MudItem xs="12" md="6">
                        <MudButton Color="Color.Info" Variant="Variant.Filled" StartIcon="Icons.Material.Filled.Print" Class="mr-2"
                                   OnClick="@(()=>Snackbar.Add("Cetak belum diimplementasi.", Severity.Info))">
                            Cetak
                        </MudButton>
                        <MudButton Color="Color.Success" Variant="Variant.Filled" StartIcon="Icons.Material.Filled.Download"
                                   OnClick="@(()=>Snackbar.Add("Export Excel belum diimplementasi.", Severity.Info))">
                            Export Excel
                        </MudButton>
                    </MudItem>
                    <MudItem xs="12" md="6" Class="d-flex justify-end">
                        <MudPagination Count="@TotalPages"
                                       Selected="@_page"
                                       SelectedChanged="(p)=>{_page=p;}"
                                       ShowFirstButton="true"
                                       ShowLastButton="true" />
                    </MudItem>
                </MudGrid>
            }
        </MudCardContent>
    </MudCard>

</MudPaper>

@code {
    private bool _isLoading;

    private List<PenyelenggaraanLejarDTO> _all = new();

    // filters
    private int? _filterTahun;
    private int? _filterParas = 4;
    private string _filterBahagian = string.Empty; // mapped to JenisAkaun
    private string _filterKategori = string.Empty;

    // distincts for the dropdowns
    private List<int?> _distinctTahun = new();
    private List<string> _distinctBahagian = new();
    private List<string> _distinctKategori = new();

    // search & paging
    private string _search = string.Empty;
    private int _pageSize = 10;
    private int _page = 1;

    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            var resp = await PenyelenggaraanLejarService.GetAllPenyelenggaraanLejar();
            if (!resp.IsSuccessStatusCode) throw new Exception($"HTTP {(int)resp.StatusCode}: {resp.Error?.Message}");
            _all = resp.Content ?? new();

            _distinctTahun = _all.Select(x => x.Tahun).Where(t => t.HasValue).Distinct().OrderByDescending(t => t).ToList();
            if (!_distinctTahun.Any()) _distinctTahun = new List<int?> { DateTime.Now.Year };
            _filterTahun ??= _distinctTahun.First();

            _distinctBahagian = _all.Select(x => x.JenisAkaun ?? "")
                                    .Where(s => !string.IsNullOrWhiteSpace(s))
                                    .Distinct().OrderBy(x => x).ToList();

            _distinctKategori = _all.Select(x => x.Kategori ?? "")
                                    .Where(s => !string.IsNullOrWhiteSpace(s))
                                    .Distinct().OrderBy(x => x).ToList();
        }
        catch (Exception ex)
        {
            _all = new();
            Snackbar.Add($"Gagal memuatkan data: {ex.Message}", Severity.Error);
        }
        finally { _isLoading = false; }
    }

    private IEnumerable<PenyelenggaraanLejarDTO> _filtered => _all
        .Where(x => !_filterTahun.HasValue || x.Tahun == _filterTahun)
        .Where(x => !_filterParas.HasValue || x.Paras == _filterParas)
        .Where(x => string.IsNullOrWhiteSpace(_filterBahagian) || string.Equals(x.JenisAkaun ?? "", _filterBahagian, StringComparison.OrdinalIgnoreCase))
        .Where(x => string.IsNullOrWhiteSpace(_filterKategori) || string.Equals(x.Kategori ?? "", _filterKategori, StringComparison.OrdinalIgnoreCase))
        .Where(x => string.IsNullOrWhiteSpace(_search)
            || (x.KodAkaun?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false)
            || (x.Keterangan?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false)
            || (x.Status?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false));

    private List<PenyelenggaraanLejarDTO> _pagedList => _filtered
        .OrderBy(x => x.KodAkaun)
        .Skip((_page - 1) * _pageSize)
        .Take(_pageSize)
        .ToList();

    private int TotalPages => Math.Max(1, (int)Math.Ceiling(_filtered.Count() / (double)Math.Max(1, _pageSize)));
}
