@page "/definisi-tahun-kewangan"
@using IMAS.API.LejarAm.Shared.Models
@using IMAS.Blazor.LejarAm.Services.Refit
@using MudBlazor
@inject IPenyelenggaraanLejarApi PenyelenggaraanLejarService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudPaper Class="pa-4">
    <!-- Header: Date + Update button -->
    <MudCard Class="mb-4" Style="background:#16a085; color:white;">
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">⚠️ Definisi Bulan/Tahun Kewangan</MudText>

            <MudGrid AlignItems="AlignItems.Center">
                <MudItem xs="12" md="3">
                    <MudDatePicker @bind-Date="_tarikhTutupKewangan"
                                   Label="Tarikh Tutup Kewangan"
                                   InputIcon="Icons.Material.Filled.CalendarToday"
                                   DateFormat="dd/MM/yyyy"
                                   Variant="Variant.Outlined"
                                   Style="background:white;" />
                </MudItem>

                <MudItem xs="12" md="3" Class="d-flex align-center">
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="KemaskiniTarikhTutup">
                        Kemaskini Tarikh Tutup Kewangan.
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <!-- Tahun kewangan select + Tambah -->
    <MudCard Class="mb-3">
        <MudCardContent>
            <MudGrid AlignItems="AlignItems.Center">
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Class="mb-1">Tahun Kewangan</MudText>
                    <MudSelect T="int?" @bind-Value="_selectedYear" Variant="Variant.Outlined" Style="background:white; max-width:200px">
                        <MudSelectItem T="int?" Value="@((int?)null)">Select…</MudSelectItem>
                        @foreach (var y in _availableYears)
                        {
                            <MudSelectItem T="int?" Value="@(y)">@y</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="6" Class="d-flex justify-end">
                    <MudButton Color="Color.Success" StartIcon="Icons.Material.Filled.Add" OnClick="TambahBaru">
                        Tambah
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <!-- Jadual Tahun | Bulan | Status -->
    <MudCard Class="mb-4">
        <MudCardContent>
            @if (_isLoading)
            {
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
            }
            else
            {
                <MudTable Items="_pagedList" Hover="true" Striped="true" Dense="true" T="PenyelenggaraanLejarDTO">
                    <HeaderContent>
                        <MudTh>Tahun</MudTh>
                        <MudTh>Bulan</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Tahun">@context.Tahun</MudTd>
                        <MudTd DataLabel="Bulan">@NamaBulan(@context.Bulan)</MudTd>
                        <MudTd DataLabel="Status">@context.Status</MudTd>
                        <MudTd>
                            <MudButton Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditItem(context))">Edit</MudButton>
                            <MudButton Color="Color.Error" Size="Size.Small" OnClick="@(async () => await DeleteItem(context.ID))">Hapus</MudButton>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudAlert Severity="Severity.Info">Tiada data.</MudAlert>
                    </NoRecordsContent>
                </MudTable>

                <MudText Typo="Typo.caption" Class="mt-2">
                    Menunjukkan @(Math.Min(_totalItems, ((_currentPage - 1) * _pageSize) + 1))
                    hingga @((Math.Min(_currentPage * _pageSize, _totalItems)))
                    daripada @_totalItems rekod
                </MudText>
            }
        </MudCardContent>
    </MudCard>

    <!-- Borang Tambah/Kemaskini -->
    <MudCard>
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">🔧 Borang Definisi</MudText>

            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudTextField T="int?" Label="Tahun"
                                  @bind-Value="_form.Tahun"
                                  Variant="Variant.Outlined"
                                  Style="background:white;"
                                  Required="true" />
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudSelect T="int?" Label="Bulan"
                               @bind-Value="_form.Bulan"
                               Variant="Variant.Outlined"
                               Style="background:white;"
                               Required="true">
                        <MudSelectItem T="int?" Value="@((int?)null)">Pilih…</MudSelectItem>
                        @for (int m = 1; m <= 12; m++)
                        {
                            <MudSelectItem T="int?" Value="@((int?)m)">@NamaBulan(m)</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudSelect T="string" Label="Status"
                               @bind-Value="_form.Status"
                               Variant="Variant.Outlined"
                               Style="background:white;">
                        <MudSelectItem T="string" Value="@STATUS_DIBUKA">DIBUKA</MudSelectItem>
                        <MudSelectItem T="string" Value="@STATUS_DITUTUP">DITUTUP</MudSelectItem>
                    </MudSelect>
                </MudItem>

            </MudGrid>

            <MudDivider Class="my-3" />

            <MudStack Row="true" Spacing="2">
                <MudButton Color="Color.Success" StartIcon="Icons.Material.Filled.Save" OnClick="SaveItem" Loading="@_isSaving">
                    @(_isEdit ? "Simpan Perubahan" : "Tambah")
                </MudButton>

                <MudButton Color="Color.Default" StartIcon="Icons.Material.Filled.Refresh" OnClick="ResetForm">
                    Set Semula
                </MudButton>

                <MudButton Color="Color.Error" StartIcon="Icons.Material.Filled.Delete" Disabled="@(!_isEdit)"
                           OnClick="@(async () => await DeleteItem(_form.ID))">
                    Padam
                </MudButton>
            </MudStack>
        </MudCardContent>
    </MudCard>
</MudPaper>

@code {
    // --- state
    private List<PenyelenggaraanLejarDTO> _all = new();
    private int _pageSize = 12;
    private int _currentPage = 1;

    private int? _selectedYear;
    private List<int> _availableYears = new();

    private DateTime? _tarikhTutupKewangan = DateTime.Today;

    private bool _isLoading = false;
    private bool _isSaving = false;
    private bool _isEdit = false;

    private PenyelenggaraanLejarDTO _form = new();

    private const string STATUS_DIBUKA = "DIBUKA";
    private const string STATUS_DITUTUP = "DITUTUP";
    // Ensure default
    protected override async Task OnInitializedAsync()
    {
        _form.Status ??= STATUS_DIBUKA;
        await LoadData();
    }


    // --- computed
    private IEnumerable<PenyelenggaraanLejarDTO> _filtered => _all
        .Where(x => x.Tahun.HasValue || x.Bulan.HasValue || !string.IsNullOrWhiteSpace(x.Status))
        .Where(x => !_selectedYear.HasValue || x.Tahun == _selectedYear.Value);

    private List<PenyelenggaraanLejarDTO> _pagedList => _filtered
        .OrderByDescending(x => x.Tahun).ThenBy(x => x.Bulan)
        .Skip((_currentPage - 1) * _pageSize)
        .Take(_pageSize)
        .ToList();

    private int _totalItems => _filtered.Count();

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            var resp = await PenyelenggaraanLejarService.GetAllPenyelenggaraanLejar();
            if (!resp.IsSuccessStatusCode)
                throw new Exception($"HTTP {(int)resp.StatusCode}: {resp.Error?.Message}");

            _all = resp.Content ?? new();
            _availableYears = _all
                .Where(x => x.Tahun.HasValue)
                .Select(x => x.Tahun!.Value)
                .Distinct()
                .OrderByDescending(y => y)
                .ToList();

            if (_availableYears.Count == 0)
                _availableYears = Enumerable.Range(DateTime.Today.Year - 2, 5).ToList();

            _currentPage = 1;
        }
        catch (Exception ex)
        {
            _all = new();
            Snackbar.Add($"Gagal memuatkan data: {ex.Message}", Severity.Error);
        }
        finally { _isLoading = false; }
    }

    private void TambahBaru()
    {
        var year = _selectedYear ?? DateTime.Today.Year;
        _form = new PenyelenggaraanLejarDTO
        {
            ID = Guid.Empty,
            Tahun = year,
            Bulan = null,
            Status = "DIBUKA",
            // nilai minimum untuk elak null pada API backend lama
            Paras = 1,
            KodAkaun = $"DEF-{year}",
            Keterangan = "Definisi Tahun/Bulan Kewangan"
        };
        _isEdit = false;
    }

    private void EditItem(PenyelenggaraanLejarDTO item)
    {
        _form = new PenyelenggaraanLejarDTO
        {
            ID = item.ID,
            Tahun = item.Tahun,
            Bulan = item.Bulan,
            Status = item.Status,
            TarikhTutup = item.TarikhTutup,
            // bawa nilai sedia ada untuk medan lama (jika ada)
            KodAkaun = item.KodAkaun,
            Keterangan = item.Keterangan,
            Paras = item.Paras,
            Kategori = item.Kategori,
            JenisAkaun = item.JenisAkaun,
            JenisAkaunParas2 = item.JenisAkaunParas2,
            JenisAliran = item.JenisAliran,
            JenisKedudukanPenyata = item.JenisKedudukanPenyata
        };
        _isEdit = true;
    }

    private async Task SaveItem()
    {
        if (!_form.Tahun.HasValue || !_form.Bulan.HasValue)
        {
            Snackbar.Add("Medan Tahun dan Bulan wajib diisi.", Severity.Warning);
            return;
        }

        // pastikan medan lama tidak null jika backend perlukan
        NormalizeForLegacyApi(_form);

        _isSaving = true;
        try
        {
            if (_isEdit)
            {
                var resp = await PenyelenggaraanLejarService.UpdatePenyelenggaraanLejar(_form.ID, _form);
                if (!resp.IsSuccessStatusCode)
                    throw new Exception($"HTTP {(int)resp.StatusCode}: {resp.Error?.Message}");
                Snackbar.Add("Rekod berjaya dikemaskini.", Severity.Success);
            }
            else
            {
                var resp = await PenyelenggaraanLejarService.CreatePenyelenggaraanLejar(_form);
                if (!resp.IsSuccessStatusCode)
                    throw new Exception($"HTTP {(int)resp.StatusCode}: {resp.Error?.Message}");
                Snackbar.Add("Rekod berjaya ditambah.", Severity.Success);
            }

            await LoadData();
            ResetForm();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal simpan rekod: {ex.Message}", Severity.Error);
        }
        finally { _isSaving = false; }
    }

    private async Task DeleteItem(Guid id)
    {
        if (id == Guid.Empty) return;

        var confirm = await DialogService.ShowMessageBox(
            "Pasti?", "Anda pasti mahu menghapuskan rekod ini?",
            yesText: "Ya", cancelText: "Batal");

        if (confirm == true)
        {
            try
            {
                var resp = await PenyelenggaraanLejarService.DeletePenyelenggaraanLejar(id);
                if (!resp.IsSuccessStatusCode)
                    throw new Exception($"Kod {resp.StatusCode}");

                Snackbar.Add("Rekod berjaya dihapus.", Severity.Success);
                await LoadData();
                ResetForm();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Gagal menghapus rekod: {ex.Message}", Severity.Error);
            }
        }
    }

    private void ResetForm()
    {
        _form = new();
        _isEdit = false;
    }

    private async Task KemaskiniTarikhTutup()
    {
        if (!_tarikhTutupKewangan.HasValue)
        {
            Snackbar.Add("Sila pilih tarikh tutup kewangan.", Severity.Warning);
            return;
        }

        var targetRows = _filtered.ToList(); // tahun dipilih (jika ada)
        if (targetRows.Count == 0)
        {
            Snackbar.Add("Tiada rekod untuk dikemaskini.", Severity.Info);
            return;
        }

        try
        {
            foreach (var row in targetRows)
            {
                row.TarikhTutup = _tarikhTutupKewangan.Value;
                NormalizeForLegacyApi(row);
                var resp = await PenyelenggaraanLejarService.UpdatePenyelenggaraanLejar(row.ID, row);
                if (!resp.IsSuccessStatusCode)
                    throw new Exception($"HTTP {(int)resp.StatusCode}: {resp.Error?.Message}");
            }
            Snackbar.Add("Tarikh tutup kewangan berjaya dikemaskini.", Severity.Success);
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal kemaskini tarikh: {ex.Message}", Severity.Error);
        }
    }

    private static void NormalizeForLegacyApi(PenyelenggaraanLejarDTO dto)
    {
        // elak null pada mapping backend (cth Paras.Value)
        dto.Paras ??= 1;
        dto.KodAkaun ??= $"DEF-{dto.Tahun ?? DateTime.Today.Year}-{(dto.Bulan ?? 1):00}";
        dto.Keterangan ??= "Definisi Tahun/Bulan Kewangan";
        dto.Kategori ??= string.Empty;
        dto.JenisAkaun ??= string.Empty;
        dto.JenisAkaunParas2 ??= string.Empty;
        dto.JenisAliran ??= string.Empty;
        dto.JenisKedudukanPenyata ??= string.Empty;
        if (dto.TarikhTutup == default) dto.TarikhTutup = DateTime.Today;
    }

    private static string NamaBulan(int? m) => m switch
    {
        1 => "Januari",
        2 => "Februari",
        3 => "Mac",
        4 => "April",
        5 => "Mei",
        6 => "Jun",
        7 => "Julai",
        8 => "Ogos",
        9 => "September",
        10 => "Oktober",
        11 => "November",
        12 => "Disember",
        _ => "-"
    };
}
