@page "/senarai-jurnal"
@using IMAS.API.LejarAm.Shared.Models
@using IMAS.API.LejarAm.Shared.Infrastructure.Refit
@using Microsoft.AspNetCore.Components.Web
@using MudBlazor
@inject IJurnalApi JurnalService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudPaper Class="pa-4">
    <!-- Page Header -->
    <MudText Typo="Typo.h4" Class="mb-4">Senarai Jurnal</MudText>

    <!-- Filter Tabs -->
    <MudTabs Elevation="0"
             Color="Color.Primary"
             Class="mb-4"
             ActivePanelIndex="@_activeTabIndex"
             ActivePanelIndexChanged="OnTabChanged">
        <MudTabPanel Text="Senarai Jurnal Belum Disemak" />
        <MudTabPanel Text="Senarai Jurnal Yang Disemak" />
    </MudTabs>

    <!-- Filter Section -->
    <MudCard Class="mb-4">
        <MudCardContent>
            <MudGrid AlignItems="AlignItems.Center">
                <!-- Bulan -->
                <MudItem xs="12" md="3">
                    <MudSelect T="string"
                               Label="Pilih Bulan"
                               Value="_selectedMonth"
                               ValueChanged="OnMonthChanged"
                               ValueExpression="@(() => _selectedMonth)"
                               Clearable="true">
                        <MudSelectItem Value="@("01")">Januari</MudSelectItem>
                        <MudSelectItem Value="@("02")">Februari</MudSelectItem>
                        <MudSelectItem Value="@("03")">Mac</MudSelectItem>
                        <MudSelectItem Value="@("04")">April</MudSelectItem>
                        <MudSelectItem Value="@("05")">Mei</MudSelectItem>
                        <MudSelectItem Value="@("06")">Jun</MudSelectItem>
                        <MudSelectItem Value="@("07")">Julai</MudSelectItem>
                        <MudSelectItem Value="@("08")">Ogos</MudSelectItem>
                        <MudSelectItem Value="@("09")">September</MudSelectItem>
                        <MudSelectItem Value="@("10")">Oktober</MudSelectItem>
                        <MudSelectItem Value="@("11")">November</MudSelectItem>
                        <MudSelectItem Value="@("12")">Disember</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <!-- Tahun -->
                <MudItem xs="12" md="3">
                    <MudSelect T="string"
                               Label="Pilih Tahun"
                               Value="_selectedYear"
                               ValueChanged="OnYearChanged"
                               ValueExpression="@(() => _selectedYear)"
                               Clearable="true">
                        <MudSelectItem Value="@("2023")">2023</MudSelectItem>
                        <MudSelectItem Value="@("2024")">2024</MudSelectItem>
                        <MudSelectItem Value="@("2025")">2025</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <!-- Page size + Search -->
                <MudItem xs="12" md="6" Class="d-flex justify-end">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudSelect T="int"
                                   Value="_pageSize"
                                   ValueChanged="OnPageSizeChanged"
                                   ValueExpression="@(() => _pageSize)"
                                   Dense="true"
                                   Style="min-width: 80px;">
                            <MudSelectItem Value="@(10)">10</MudSelectItem>
                            <MudSelectItem Value="@(25)">25</MudSelectItem>
                            <MudSelectItem Value="@(50)">50</MudSelectItem>
                            <MudSelectItem Value="@(100)">100</MudSelectItem>
                        </MudSelect>
                        <MudText Typo="Typo.body2">records</MudText>
                        <MudTextField T="string"
                                      Label="Search"
                                      @bind-Value="_searchText"
                                      OnKeyDown="OnSearchKeyDown"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="Icons.Material.Filled.Search"
                                      Style="max-width: 200px;"
                                      Immediate="true" />
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <!-- Data Table -->
    <MudCard>
        <MudCardContent>
            <MudTable Items="_pagedList"
                      Hover="true"
                      Striped="true"
                      Loading="_loading"
                      T="JurnalDTO">
                <HeaderContent>
                    <MudTh>
                        <MudTableSortLabel T="JurnalDTO" SortBy="j => j.NoJurnal">
                            No. Jurnal
                        </MudTableSortLabel>
                    </MudTh>
                    <MudTh>
                        <MudTableSortLabel T="JurnalDTO" SortBy="j => j.TarikhJurnal">
                            Tarikh Jurnal
                        </MudTableSortLabel>
                    </MudTh>
                    <MudTh>
                        <MudTableSortLabel T="JurnalDTO" SortBy="j => j.Keterangan">
                            Keterangan
                        </MudTableSortLabel>
                    </MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Tindakan</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="No. Jurnal">@context.NoJurnal</MudTd>
                    <MudTd DataLabel="Tarikh Jurnal">@context.TarikhJurnal.ToString("dd/MM/yyyy")</MudTd>
                    <MudTd DataLabel="Keterangan">@context.Keterangan</MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small">
                            @context.Status
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Tindakan">
                        <MudButton Color="Color.Info"
                                   Size="Size.Small"
                                   Variant="Variant.Filled"
                                   OnClick="@(() => ViewDetails(context))">
                            Lihat
                        </MudButton>
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudAlert Severity="Severity.Info">
                        Tiada rekod dijumpai.
                    </MudAlert>
                </NoRecordsContent>
            </MudTable>
        </MudCardContent>
    </MudCard>

    <!-- Pagination -->
    <MudDivider Class="my-3" />
    <MudGrid AlignItems="AlignItems.Center">
        <MudItem xs="12" md="6">
            <MudText Typo="Typo.body2">
                Menunjukkan @(Math.Min(_totalItems, ((_currentPage - 1) * _pageSize) + 1))
                hingga @((Math.Min(_currentPage * _pageSize, _totalItems)))
                daripada @_totalItems rekod
            </MudText>
        </MudItem>
        <MudItem xs="12" md="6" Class="d-flex justify-end">
            <MudPagination Page="@_currentPage"
                           Count="@((int)Math.Ceiling((double)_totalItems / _pageSize))"
                           OnPageChanged="OnPageChanged"
                           ShowFirstButton="true"
                           ShowLastButton="true" />
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    // Raw data
    private List<JurnalDTO> _all = new();

    // UI state
    private bool _loading = false;
    private int _activeTabIndex = 0;      // 0: Belum Disemak (BARU) | 1: Disemak (POS)
    private string? _selectedMonth;       // "01".."12"
    private string? _selectedYear;        // "2023".."2025"
    private string _searchText = string.Empty;

    private int _pageSize = 10;
    private int _currentPage = 1;

    // Derived data
    private IEnumerable<JurnalDTO> Filtered => _all.Where(j =>
        // Status mapped to tabs:
        (
            (_activeTabIndex == 0 && string.Equals(j.Status, "BARU", StringComparison.OrdinalIgnoreCase)) ||
            (_activeTabIndex == 1 && string.Equals(j.Status, "POS", StringComparison.OrdinalIgnoreCase))
        )
        // Month filter
        && (string.IsNullOrWhiteSpace(_selectedMonth) ? true : (int.TryParse(_selectedMonth, out var m) && j.TarikhJurnal.Month == m))
        // Year filter
        && (string.IsNullOrWhiteSpace(_selectedYear) ? true : (int.TryParse(_selectedYear, out var y) && j.TarikhJurnal.Year == y))
        // Search filter
        && (string.IsNullOrWhiteSpace(_searchText)
            || (j.NoJurnal?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            || (j.NoRujukan?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            || (j.Keterangan?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            || (j.SumberTransaksi?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false))
    );

    private int _totalItems => Filtered.Count();

    private List<JurnalDTO> _pagedList => Filtered
        .Skip((_currentPage - 1) * _pageSize)
        .Take(_pageSize)
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadAll();
    }

    private async Task LoadAll()
    {
        _loading = true;
        try
        {
            _all = await JurnalService.GetAllJurnals() ?? new();
            _currentPage = 1;
        }
        catch (Exception ex)
        {
            _all = new();
            Snackbar.Add($"Ralat memuatkan jurnal: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    // Tabs
    private async Task OnTabChanged(int index)
    {
        _activeTabIndex = index;
        _currentPage = 1;
        await InvokeAsync(StateHasChanged);
    }

    // Filters
    private Task OnMonthChanged(string value)
    {
        _selectedMonth = value;
        _currentPage = 1;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task OnYearChanged(string value)
    {
        _selectedYear = value;
        _currentPage = 1;
        StateHasChanged();
        return Task.CompletedTask;
    }

    // Page size
    private Task OnPageSizeChanged(int size)
    {
        _pageSize = size;
        _currentPage = 1;
        StateHasChanged();
        return Task.CompletedTask;
    }

    // Search
    private Task OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            _currentPage = 1;
            StateHasChanged();
        }
        return Task.CompletedTask;
    }

    // Pagination
    private Task OnPageChanged(int page)
    {
        _currentPage = page;
        StateHasChanged();
        return Task.CompletedTask;
    }

    // Status chip color mapping
    private Color GetStatusColor(string? status) => (status ?? "").ToUpperInvariant() switch
    {
        "BARU" => Color.Warning,
        "POS" => Color.Success,
        "HAPUS" => Color.Error,
        "DRAFT" => Color.Info,
        _ => Color.Default
    };

    // Detail view
    private void ViewDetails(JurnalDTO j)
    {
        Navigation.NavigateTo($"/journal-form/{j.ID}");
    }
}
