@page "/pengesahan-jurnal"
@using IMAS.API.LejarAm.Shared.Models
@using IMAS.API.LejarAm.Shared.Infrastructure.Refit
@using MudBlazor
@using Microsoft.AspNetCore.Components.Web
@inject IJurnalApi JurnalService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudPaper Class="pa-4">
    <!-- Page Header -->
    <MudText Typo="Typo.h4" Class="mb-4">Pengesahan Jurnal</MudText>

    <!-- Filter Tabs -->
    <MudTabs Elevation="0"
             Color="Color.Primary"
             Class="mb-4"
             ActivePanelIndex="@_activeTabIndex"
             ActivePanelIndexChanged="OnTabChanged">
        <MudTabPanel Text="Senarai Jurnal Belum Disahkan" />
        <MudTabPanel Text="Senarai Jurnal Yang Disahkan" />
    </MudTabs>

    <!-- Filter Section -->
    <MudCard Class="mb-4">
        <MudCardContent>
            <MudGrid AlignItems="AlignItems.Center">
                <!-- Bulan -->
                <MudItem xs="12" md="3">
                    <MudSelect T="string"
                               Label="Pilih Bulan"
                               Value="_selectedMonth"
                               ValueChanged="OnMonthChanged"
                               ValueExpression="@(() => _selectedMonth)"
                               Clearable="true">
                        <MudSelectItem Value="@("01")">Januari</MudSelectItem>
                        <MudSelectItem Value="@("02")">Februari</MudSelectItem>
                        <MudSelectItem Value="@("03")">Mac</MudSelectItem>
                        <MudSelectItem Value="@("04")">April</MudSelectItem>
                        <MudSelectItem Value="@("05")">Mei</MudSelectItem>
                        <MudSelectItem Value="@("06")">Jun</MudSelectItem>
                        <MudSelectItem Value="@("07")">Julai</MudSelectItem>
                        <MudSelectItem Value="@("08")">Ogos</MudSelectItem>
                        <MudSelectItem Value="@("09")">September</MudSelectItem>
                        <MudSelectItem Value="@("10")">Oktober</MudSelectItem>
                        <MudSelectItem Value="@("11")">November</MudSelectItem>
                        <MudSelectItem Value="@("12")">Disember</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <!-- Tahun -->
                <MudItem xs="12" md="3">
                    <MudSelect T="string"
                               Label="Pilih Tahun"
                               Value="_selectedYear"
                               ValueChanged="OnYearChanged"
                               ValueExpression="@(() => _selectedYear)"
                               Clearable="true">
                        <MudSelectItem Value="@("2023")">2023</MudSelectItem>
                        <MudSelectItem Value="@("2024")">2024</MudSelectItem>
                        <MudSelectItem Value="@("2025")">2025</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <!-- Page size + search -->
                <MudItem xs="12" md="6" Class="d-flex justify-end">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudSelect T="int"
                                   Value="_pageSize"
                                   ValueChanged="OnPageSizeChanged"
                                   ValueExpression="@(() => _pageSize)"
                                   Dense="true"
                                   Style="min-width: 80px;">
                            <MudSelectItem Value="@(10)">10</MudSelectItem>
                            <MudSelectItem Value="@(25)">25</MudSelectItem>
                            <MudSelectItem Value="@(50)">50</MudSelectItem>
                            <MudSelectItem Value="@(100)">100</MudSelectItem>
                        </MudSelect>
                        <MudText Typo="Typo.body2">records</MudText>
                        <MudTextField T="string"
                                      Label="Search"
                                      @bind-Value="_searchText"
                                      OnKeyDown="OnSearchKeyDown"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="Icons.Material.Filled.Search"
                                      Style="max-width: 220px;"
                                      Immediate="true" />
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <!-- Data Table -->
    <MudCard>
        <MudCardContent>
            <MudTable Items="_pagedList"
                      Hover="true"
                      Striped="true"
                      Loading="_loading"
                      MultiSelection="true"
                      @bind-SelectedItems="_selectedItems"
                      Dense="true"
                      T="JurnalDTO">
                <HeaderContent>
                    <MudTh>
                        <MudTableSortLabel T="JurnalDTO" SortBy="j => j.NoJurnal">No. Jurnal</MudTableSortLabel>
                    </MudTh>
                    <MudTh>
                        <MudTableSortLabel T="JurnalDTO" SortBy="j => j.TarikhJurnal">Tarikh Jurnal</MudTableSortLabel>
                    </MudTh>
                    <MudTh>
                        <MudTableSortLabel T="JurnalDTO" SortBy="j => j.Keterangan">Keterangan</MudTableSortLabel>
                    </MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Tindakan</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="No. Jurnal">@context.NoJurnal</MudTd>
                    <MudTd DataLabel="Tarikh Jurnal">@context.TarikhJurnal.ToString("dd/MM/yyyy")</MudTd>
                    <MudTd DataLabel="Keterangan">@context.Keterangan</MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small">
                            @context.Status
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Tindakan">
                        <MudButton Color="Color.Info"
                                   Size="Size.Small"
                                   Variant="Variant.Filled"
                                   OnClick="@(() => ViewDetails(context))">
                            Lihat
                        </MudButton>
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudAlert Severity="Severity.Info">
                        Tiada rekod dijumpai.
                    </MudAlert>
                </NoRecordsContent>
            </MudTable>
        </MudCardContent>
    </MudCard>

    <!-- Bulk Actions (only on "Belum Disahkan" tab and when items selected) -->
    @if (_activeTabIndex == 0 && _selectedItems.Any())
    {
        <MudCard Class="mt-4">
            <MudCardContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                    <MudText Typo="Typo.subtitle1"><strong>@_selectedItems.Count item(s) dipilih</strong></MudText>
                    <MudButton Color="Color.Success"
                               StartIcon="Icons.Material.Filled.CheckCircle"
                               OnClick="BulkVerify"
                               Loading="_bulkProcessing">
                        Sahkan Terpilih
                    </MudButton>
                    <MudButton Color="Color.Error"
                               StartIcon="Icons.Material.Filled.Cancel"
                               OnClick="BulkReject"
                               Loading="_bulkProcessing">
                        Tolak Terpilih
                    </MudButton>
                    <MudButton Color="Color.Default"
                               StartIcon="Icons.Material.Filled.Clear"
                               OnClick="ClearSelection">
                        Kosongkan Pilihan
                    </MudButton>
                </MudStack>
            </MudCardContent>
        </MudCard>
    }

    <!-- Pagination -->
    <MudDivider Class="my-3" />
    <MudGrid AlignItems="AlignItems.Center">
        <MudItem xs="12" md="6">
            <MudText Typo="Typo.body2">
                Menunjukkan @(Math.Min(_totalItems, ((_currentPage - 1) * _pageSize) + 1))
                hingga @((Math.Min(_currentPage * _pageSize, _totalItems))) daripada @_totalItems rekod
            </MudText>
        </MudItem>
        <MudItem xs="12" md="6" Class="d-flex justify-end">
            <MudPagination Page="@_currentPage"
                           Count="@((int)Math.Ceiling((double)_totalItems / _pageSize))"
                           OnPageChanged="OnPageChanged"
                           ShowFirstButton="true"
                           ShowLastButton="true" />
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    // Raw list from API
    private List<JurnalDTO> _all = new();

    // Selection
    private HashSet<JurnalDTO> _selectedItems = new();

    // UI state
    private bool _loading = false;
    private bool _bulkProcessing = false;

    private int _activeTabIndex = 0;          // 0: Belum Disahkan (BARU), 1: Disahkan (POS)
    private string? _selectedMonth;           // "01".."12"
    private string? _selectedYear;            // "2023".."2025"
    private string _searchText = string.Empty;

    private int _pageSize = 10;
    private int _currentPage = 1;

    // Computed filtered list
    private IEnumerable<JurnalDTO> Filtered => _all.Where(j =>
        // Status tab filter
        (
            (_activeTabIndex == 0 && string.Equals(j.Status, "BARU", StringComparison.OrdinalIgnoreCase)) ||
            (_activeTabIndex == 1 && string.Equals(j.Status, "POS", StringComparison.OrdinalIgnoreCase))
        )
        // Month filter
        && (string.IsNullOrEmpty(_selectedMonth) || j.TarikhJurnal.Month == int.Parse(_selectedMonth))
        // Year filter
        && (string.IsNullOrEmpty(_selectedYear) || j.TarikhJurnal.Year == int.Parse(_selectedYear))
        // Search filter
        && (string.IsNullOrWhiteSpace(_searchText)
            || (j.NoJurnal?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            || (j.NoRujukan?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            || (j.Keterangan?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            || (j.SumberTransaksi?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false))
    );

    private int _totalItems => Filtered.Count();

    private List<JurnalDTO> _pagedList => Filtered
        .Skip((_currentPage - 1) * _pageSize)
        .Take(_pageSize)
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadAll();
    }

    private async Task LoadAll()
    {
        _loading = true;
        try
        {
            _all = await JurnalService.GetAllJurnals() ?? new();
            _currentPage = 1;
            _selectedItems.Clear();
        }
        catch (Exception ex)
        {
            _all = new();
            Snackbar.Add($"Ralat memuatkan jurnal: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    // Tab change
    private async Task OnTabChanged(int index)
    {
        _activeTabIndex = index;
        _currentPage = 1;
        _selectedItems.Clear();
        await InvokeAsync(StateHasChanged);
    }

    // Filters
    private Task OnMonthChanged(string value)
    {
        _selectedMonth = value;
        _currentPage = 1;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task OnYearChanged(string value)
    {
        _selectedYear = value;
        _currentPage = 1;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task OnPageSizeChanged(int size)
    {
        _pageSize = size;
        _currentPage = 1;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            _currentPage = 1;
            StateHasChanged();
        }
        return Task.CompletedTask;
    }

    private Task OnPageChanged(int page)
    {
        _currentPage = page;
        StateHasChanged();
        return Task.CompletedTask;
    }

    // Status chip colors
    private Color GetStatusColor(string? status) => (status ?? "").ToUpperInvariant() switch
    {
        "BARU" => Color.Warning,
        "POS" => Color.Success,
        "HAPUS" => Color.Error,
        _ => Color.Default
    };

    // Row actions
    private void ViewDetails(JurnalDTO j)
    {
        // Navigate to your journal form page for detail/verification
        Navigation.NavigateTo($"/journal-form/{j.ID}");
    }

    // Bulk actions
    private async Task BulkVerify()
    {
        if (!_selectedItems.Any()) return;

        bool? confirm = await DialogService.ShowMessageBox(
            "Pengesahan",
            $"Anda pasti mahu sahkan {_selectedItems.Count} jurnal yang dipilih?",
            yesText: "Ya",
            cancelText: "Batal"
        );

        if (confirm == true)
        {
            _bulkProcessing = true;
            try
            {
                var tasks = _selectedItems.Select(async j =>
                {
                    var updated = new JurnalDTO
                    {
                        ID = j.ID,
                        NoJurnal = j.NoJurnal,
                        NoRujukan = j.NoRujukan,
                        TarikhJurnal = j.TarikhJurnal,
                        Status = "POS", // Mark as verified/posted
                        JenisJurnal = j.JenisJurnal,
                        SumberTransaksi = j.SumberTransaksi,
                        Keterangan = j.Keterangan
                    };
                    await JurnalService.UpdateJurnal(j.ID, updated);
                });

                await Task.WhenAll(tasks);
                Snackbar.Add($"{_selectedItems.Count} jurnal berjaya disahkan.", Severity.Success);
                await LoadAll();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Ralat semasa pengesahan: {ex.Message}", Severity.Error);
            }
            finally
            {
                _bulkProcessing = false;
            }
        }
    }

    private async Task BulkReject()
    {
        if (!_selectedItems.Any()) return;

        bool? confirm = await DialogService.ShowMessageBox(
            "Pengesahan",
            $"Anda pasti mahu tolak {_selectedItems.Count} jurnal yang dipilih?",
            yesText: "Ya",
            cancelText: "Batal"
        );

        if (confirm == true)
        {
            _bulkProcessing = true;
            try
            {
                var tasks = _selectedItems.Select(async j =>
                {
                    var updated = new JurnalDTO
                    {
                        ID = j.ID,
                        NoJurnal = j.NoJurnal,
                        NoRujukan = j.NoRujukan,
                        TarikhJurnal = j.TarikhJurnal,
                        Status = "HAPUS", // Use HAPUS as "rejected" / not approved
                        JenisJurnal = j.JenisJurnal,
                        SumberTransaksi = j.SumberTransaksi,
                        Keterangan = j.Keterangan
                    };
                    await JurnalService.UpdateJurnal(j.ID, updated);
                });

                await Task.WhenAll(tasks);
                Snackbar.Add($"{_selectedItems.Count} jurnal berjaya ditolak.", Severity.Success);
                await LoadAll();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Ralat semasa penolakan: {ex.Message}", Severity.Error);
            }
            finally
            {
                _bulkProcessing = false;
            }
        }
    }

    private void ClearSelection() => _selectedItems.Clear();
}
