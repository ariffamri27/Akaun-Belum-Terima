@page "/pengesahan-jurnal"
@using IMAS.API.LejarAm.Shared.Models
@using IMAS.API.LejarAm.Shared.Infrastructure.Refit
@using MudBlazor
@using Microsoft.AspNetCore.Components.Web

@inject IJurnalApi JurnalService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h4" Class="mb-4">Pengesahan Jurnal</MudText>

    <!-- Tabs -->
    <MudTabs Elevation="0"
             Color="Color.Primary"
             Class="mb-4"
             ActivePanelIndex="@_activeTabIndex"
             ActivePanelIndexChanged="OnTabChanged">
        <MudTabPanel Text="Belum Disahkan" />
        <MudTabPanel Text="Disahkan" />
    </MudTabs>

    <!-- Filters -->
    <MudCard Class="mb-4">
        <MudCardContent>
            <MudGrid AlignItems="AlignItems.Center">
                <MudItem xs="12" md="3">
                    <MudSelect T="string" Label="Pilih Bulan"
                               Value="_selectedMonth"
                               ValueChanged="OnMonthChanged"
                               ValueExpression="@(() => _selectedMonth)"
                               Clearable="true">
                        <MudSelectItem Value="@("01")">Januari</MudSelectItem>
                        <MudSelectItem Value="@("02")">Februari</MudSelectItem>
                        <MudSelectItem Value="@("03")">Mac</MudSelectItem>
                        <MudSelectItem Value="@("04")">April</MudSelectItem>
                        <MudSelectItem Value="@("05")">Mei</MudSelectItem>
                        <MudSelectItem Value="@("06")">Jun</MudSelectItem>
                        <MudSelectItem Value="@("07")">Julai</MudSelectItem>
                        <MudSelectItem Value="@("08")">Ogos</MudSelectItem>
                        <MudSelectItem Value="@("09")">September</MudSelectItem>
                        <MudSelectItem Value="@("10")">Oktober</MudSelectItem>
                        <MudSelectItem Value="@("11")">November</MudSelectItem>
                        <MudSelectItem Value="@("12")">Disember</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudSelect T="string" Label="Pilih Tahun"
                               Value="_selectedYear"
                               ValueChanged="OnYearChanged"
                               ValueExpression="@(() => _selectedYear)"
                               Clearable="true">
                        <MudSelectItem Value="@("2023")">2023</MudSelectItem>
                        <MudSelectItem Value="@("2024")">2024</MudSelectItem>
                        <MudSelectItem Value="@("2025")">2025</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="6" Class="d-flex justify-end">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudSelect T="int"
                                   Value="_pageSize"
                                   ValueChanged="OnPageSizeChanged"
                                   ValueExpression="@(() => _pageSize)"
                                   Dense="true"
                                   Style="min-width: 80px;">
                            <MudSelectItem Value="@(10)">10</MudSelectItem>
                            <MudSelectItem Value="@(25)">25</MudSelectItem>
                            <MudSelectItem Value="@(50)">50</MudSelectItem>
                            <MudSelectItem Value="@(100)">100</MudSelectItem>
                        </MudSelect>
                        <MudText Typo="Typo.body2">rekod</MudText>
                        <MudTextField T="string"
                                      Label="Search"
                                      @bind-Value="_searchText"
                                      OnKeyDown="OnSearchKeyDown"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="Icons.Material.Filled.Search"
                                      Style="max-width: 220px;"
                                      Immediate="true" />
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <!-- Table -->
    <MudCard>
        <MudCardContent>
            <MudTable Items="_pagedList"
                      Hover="true"
                      Striped="true"
                      Loading="_loading"
                      MultiSelection="true"
                      @bind-SelectedItems="_selectedItems"
                      Dense="true"
                      T="JurnalDTO">
                <HeaderContent>
                    <MudTh><MudTableSortLabel T="JurnalDTO" SortBy="j => j.NoJurnal">No. Jurnal</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel T="JurnalDTO" SortBy="j => j.TarikhJurnal">Tarikh Jurnal</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel T="JurnalDTO" SortBy="j => j.Keterangan">Keterangan</MudTableSortLabel></MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Tindakan</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.NoJurnal</MudTd>
                    <MudTd>@context.TarikhJurnal.ToString("dd/MM/yyyy")</MudTd>
                    <MudTd>@context.Keterangan</MudTd>
                    <MudTd>
                        <MudChip T="string" Color="@GetStatusColor(context.StatusSah)" Size="Size.Small">
                            @context.StatusSah
                        </MudChip>
                    </MudTd>
                    <MudTd>
                        <MudStack Row="true" Spacing="1">
                            <MudButton Color="Color.Info" Size="Size.Small" OnClick="@(() => ViewDetails(context))">
                                Lihat
                            </MudButton>

                            @if (_activeTabIndex == 0)
                            {
                                <MudButton Color="Color.Success" Size="Size.Small" OnClick="@(() => MarkSah(context))">
                                    SAH
                                </MudButton>
                                <MudButton Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteSingle(context.ID))">
                                    Hapus
                                </MudButton>
                            }
                        </MudStack>
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudAlert Severity="Severity.Info">Tiada rekod dijumpai.</MudAlert>
                </NoRecordsContent>
            </MudTable>
        </MudCardContent>
    </MudCard>

    <!-- Bulk -->
    @if (_activeTabIndex == 0 && _selectedItems.Any())
    {
        <MudCard Class="mt-4">
            <MudCardContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                    <MudText Typo="Typo.subtitle1"><strong>@_selectedItems.Count item(s) dipilih</strong></MudText>
                    <MudButton Color="Color.Success" StartIcon="Icons.Material.Filled.CheckCircle" OnClick="BulkVerify" Loading="_bulkProcessing">Sahkan Terpilih</MudButton>
                    <MudButton Color="Color.Error" StartIcon="Icons.Material.Filled.Cancel" OnClick="BulkReject" Loading="_bulkProcessing">Tolak Terpilih</MudButton>
                    <MudButton Color="Color.Default" StartIcon="Icons.Material.Filled.Clear" OnClick="ClearSelection">Kosongkan Pilihan</MudButton>
                </MudStack>
            </MudCardContent>
        </MudCard>
    }

    <!-- Pagination -->
    <MudDivider Class="my-3" />
    <MudGrid AlignItems="AlignItems.Center">
        <MudItem xs="12" md="6">
            <MudText Typo="Typo.body2">
                Menunjukkan @(Math.Min(_totalItems, ((_currentPage - 1) * _pageSize) + 1))
                hingga @((Math.Min(_currentPage * _pageSize, _totalItems))) daripada @_totalItems rekod
            </MudText>
        </MudItem>
        <MudItem xs="12" md="6" Class="d-flex justify-end">
            <MudPagination Page="@_currentPage"
                           Count="@((int)Math.Ceiling((double)_totalItems / _pageSize))"
                           OnPageChanged="OnPageChanged"
                           ShowFirstButton="true"
                           ShowLastButton="true" />
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    private List<JurnalDTO> _all = new();
    private HashSet<JurnalDTO> _selectedItems = new();

    private bool _loading = false;
    private bool _bulkProcessing = false;

    private int _activeTabIndex = 0; // 0: BELUM SAH, 1: SAH
    private string? _selectedMonth;
    private string? _selectedYear;
    private string _searchText = string.Empty;

    private int _pageSize = 10;
    private int _currentPage = 1;

    private IEnumerable<JurnalDTO> Filtered => _all.Where(j =>
        (
            (_activeTabIndex == 0 && string.Equals(j.StatusSah, "BELUM SAH", StringComparison.OrdinalIgnoreCase)) ||
            (_activeTabIndex == 1 && string.Equals(j.StatusSah, "SAH", StringComparison.OrdinalIgnoreCase))
        )
        && (string.IsNullOrEmpty(_selectedMonth) || j.TarikhJurnal.Month == int.Parse(_selectedMonth))
        && (string.IsNullOrEmpty(_selectedYear) || j.TarikhJurnal.Year == int.Parse(_selectedYear))
        && (string.IsNullOrWhiteSpace(_searchText)
            || (j.NoJurnal?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            || (j.NoRujukan?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            || (j.Keterangan?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            || (j.SumberTransaksi?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)));

    private int _totalItems => Filtered.Count();

    private List<JurnalDTO> _pagedList => Filtered
        .OrderByDescending(x => x.TarikhJurnal)
        .Skip((_currentPage - 1) * _pageSize)
        .Take(_pageSize)
        .ToList();

    protected override async Task OnInitializedAsync() => await LoadAll();

    private async Task LoadAll()
    {
        _loading = true;
        try
        {
            _all = await JurnalService.GetAllJurnals() ?? new();
            _currentPage = 1;
            _selectedItems.Clear();
        }
        catch (Exception ex)
        {
            _all = new();
            Snackbar.Add($"Ralat memuatkan jurnal: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task MarkSah(JurnalDTO j)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Sahkan Jurnal",
            $"Sahkan jurnal {j.NoJurnal}?",
            yesText: "Sahkan", cancelText: "Batal");

        if (confirm != true) return;

        try
        {
            var updated = Copy(j, sSah: "SAH");
            await JurnalService.UpdateJurnal(j.ID, updated);
            Snackbar.Add($"Jurnal {j.NoJurnal} telah disahkan.", Severity.Success);
            await LoadAll();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ralat semasa sahkan jurnal: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteSingle(Guid id)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Hapus Jurnal",
            "Anda pasti mahu menghapuskan jurnal ini?",
            yesText: "Hapus", cancelText: "Batal");

        if (confirm != true) return;

        try
        {
            await JurnalService.DeleteJurnal(id);
            Snackbar.Add("Jurnal berjaya dihapus.", Severity.Success);
            await LoadAll();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ralat menghapus jurnal: {ex.Message}", Severity.Error);
        }
    }

    // Tabs + filters + paging
    private async Task OnTabChanged(int index) { _activeTabIndex = index; _currentPage = 1; _selectedItems.Clear(); await InvokeAsync(StateHasChanged); }
    private Task OnMonthChanged(string value) { _selectedMonth = value; _currentPage = 1; StateHasChanged(); return Task.CompletedTask; }
    private Task OnYearChanged(string value) { _selectedYear = value; _currentPage = 1; StateHasChanged(); return Task.CompletedTask; }
    private Task OnPageSizeChanged(int size) { _pageSize = size; _currentPage = 1; StateHasChanged(); return Task.CompletedTask; }
    private Task OnSearchKeyDown(KeyboardEventArgs e) { if (e.Key == "Enter") { _currentPage = 1; StateHasChanged(); } return Task.CompletedTask; }
    private Task OnPageChanged(int page) { _currentPage = page; StateHasChanged(); return Task.CompletedTask; }

    // Colors
    private Color GetStatusColor(string? status) => (status ?? "").ToUpperInvariant() switch
    {
        "BELUM SAH" => Color.Warning,
        "SAH" => Color.Success,
        "HAPUS" => Color.Error,
        _ => Color.Default
    };

    private void ViewDetails(JurnalDTO j) => Navigation.NavigateTo($"/journal-form/{j.ID}");

    // Bulk
    private async Task BulkVerify()
    {
        if (!_selectedItems.Any()) return;

        bool? confirm = await DialogService.ShowMessageBox(
            "Pengesahan",
            $"Anda pasti mahu sahkan {_selectedItems.Count} jurnal yang dipilih?",
            yesText: "Ya", cancelText: "Batal");

        if (confirm != true) return;

        _bulkProcessing = true;
        try
        {
            var tasks = _selectedItems.Select(j => JurnalService.UpdateJurnal(j.ID, Copy(j, sSah: "SAH")));
            await Task.WhenAll(tasks);
            Snackbar.Add($"{_selectedItems.Count} jurnal berjaya disahkan.", Severity.Success);
            await LoadAll();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ralat semasa pengesahan: {ex.Message}", Severity.Error);
        }
        finally
        {
            _bulkProcessing = false;
        }
    }

    private async Task BulkReject()
    {
        if (!_selectedItems.Any()) return;

        bool? confirm = await DialogService.ShowMessageBox(
            "Pengesahan",
            $"Anda pasti mahu tolak {_selectedItems.Count} jurnal yang dipilih?",
            yesText: "Ya", cancelText: "Batal");

        if (confirm != true) return;

        _bulkProcessing = true;
        try
        {
            var tasks = _selectedItems.Select(j => JurnalService.UpdateJurnal(j.ID, Copy(j, sSah: "HAPUS")));
            await Task.WhenAll(tasks);
            Snackbar.Add($"{_selectedItems.Count} jurnal berjaya ditolak.", Severity.Success);
            await LoadAll();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ralat semasa penolakan: {ex.Message}", Severity.Error);
        }
        finally
        {
            _bulkProcessing = false;
        }
    }

    private void ClearSelection() => _selectedItems.Clear();

    private static JurnalDTO Copy(JurnalDTO j, string? sPos = null, string? sSemak = null, string? sSah = null)
        => new()
        {
            ID = j.ID,
            NoJurnal = j.NoJurnal,
            NoRujukan = j.NoRujukan,
            TarikhJurnal = j.TarikhJurnal,
            StatusPos = sPos ?? j.StatusPos,
            StatusSemak = sSemak ?? j.StatusSemak,
            StatusSah = sSah ?? j.StatusSah,
            JenisJurnal = j.JenisJurnal,
            SumberTransaksi = j.SumberTransaksi,
            Keterangan = j.Keterangan
        };
}
