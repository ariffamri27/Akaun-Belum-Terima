@page "/journal-form"
@page "/journal-form/{JournalId:guid}"
@using IMAS.API.LejarAm.Shared.Models
@using IMAS.API.LejarAm.Shared.Infrastructure.Refit
@using MudBlazor
@using Microsoft.AspNetCore.Components
@inject IJurnalApi JurnalService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudPaper Class="pa-4">
    <!-- Header -->
    <MudCard Class="mb-4" Style="background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%); color: white;">
        <MudCardContent>
            <MudText Typo="Typo.h5">📝 Penyediaan Jurnal</MudText>
        </MudCardContent>
    </MudCard>

    <!-- Action Buttons -->
    <MudButtonGroup Class="mb-4">
        <MudButton Color="Color.Success"
                   StartIcon="Icons.Material.Filled.Save"
                   OnClick="SaveJournal"
                   Loading="_saving">
            @(_isEdit ? "Simpan Perubahan" : "Simpan")
        </MudButton>
        <MudButton Color="Color.Error"
                   StartIcon="Icons.Material.Filled.Delete"
                   OnClick="DeleteJournal"
                   Disabled="@(!_isEdit)">
            Buang
        </MudButton>
        <MudButton Color="Color.Default"
                   StartIcon="Icons.Material.Filled.Refresh"
                   OnClick="ResetForm">
            Set Semula
        </MudButton>
    </MudButtonGroup>

    <!-- Journal Information Form -->
    <MudCard>
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-4">Sila masukkan maklumat transaksi.</MudText>

            <MudForm @ref="_form">
                <MudGrid>
                    <!-- No. Jurnal (auto) -->
                    <MudItem xs="12" md="6">
                        <MudTextField Label="No. Jurnal"
                                      @bind-Value="_model.NoJurnal"
                                      ReadOnly="true"
                                      Variant="Variant.Outlined"
                                      Adornment="Adornment.End"
                                      AdornmentText="*AUTO"
                                      Style="background: white;" />
                    </MudItem>

                    <!-- Tarikh Jurnal (DateTime? binder) -->
                    <MudItem xs="12" md="6">
                        <MudDatePicker Label="Tarikh Jurnal"
                                       @bind-Date="_tarikhJurnal"
                                       DateFormat="dd/MM/yyyy"
                                       Variant="Variant.Outlined"
                                       Required="true"
                                       Style="background: white;" />
                    </MudItem>

                    <!-- No Rujukan -->
                    <MudItem xs="12" md="6">
                        <MudTextField Label="No. Rujukan"
                                      @bind-Value="_model.NoRujukan"
                                      Variant="Variant.Outlined"
                                      Style="background: white;" />
                    </MudItem>

                    <!-- Status -->
                    <MudItem xs="12" md="6">
                        <MudSelect T="string"
                                   Label="Status"
                                   @bind-Value="_model.Status"
                                   Variant="Variant.Outlined"
                                   Style="background: white;"
                                   Required="true">
                            <MudSelectItem Value="@("BARU")">BARU</MudSelectItem>
                            <MudSelectItem Value="@("POS")">POS</MudSelectItem>
                            <MudSelectItem Value="@("HAPUS")">HAPUS</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <!-- Jenis Jurnal -->
                    <MudItem xs="12" md="6">
                        <MudSelect T="string"
                                   Label="Jenis Jurnal"
                                   @bind-Value="_model.JenisJurnal"
                                   Variant="Variant.Outlined"
                                   Style="background: white;"
                                   Required="true">
                            <MudSelectItem Value="@("MANUAL")">MANUAL</MudSelectItem>
                            <MudSelectItem Value="@("AUTO")">AUTO</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <!-- Sumber Transaksi -->
                    <MudItem xs="12" md="6">
                        <MudSelect T="string"
                                   Label="Sumber Transaksi"
                                   @bind-Value="_model.SumberTransaksi"
                                   Variant="Variant.Outlined"
                                   Style="background: white;"
                                   Required="true">
                            <MudSelectItem Value="@("GENERAL LEDGER")">GENERAL LEDGER</MudSelectItem>
                            <MudSelectItem Value="@("ACCOUNTS PAYABLE")">ACCOUNTS PAYABLE</MudSelectItem>
                            <MudSelectItem Value="@("ACCOUNTS RECEIVABLE")">ACCOUNTS RECEIVABLE</MudSelectItem>
                            <MudSelectItem Value="@("CASH MANAGEMENT")">CASH MANAGEMENT</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <!-- Keterangan -->
                    <MudItem xs="12">
                        <MudTextField Label="Keterangan"
                                      @bind-Value="_model.Keterangan"
                                      Lines="3"
                                      Variant="Variant.Outlined"
                                      Style="background: white;" />
                    </MudItem>
                </MudGrid>
            </MudForm>
        </MudCardContent>
    </MudCard>

    <!-- Bottom Actions -->
    <MudDivider Class="my-4" />
    <MudStack Row="true" Justify="Justify.SpaceBetween">
        <MudButton Color="Color.Default"
                   StartIcon="Icons.Material.Filled.ArrowBack"
                   OnClick="GoBack">
            Kembali
        </MudButton>
        <MudButton Color="Color.Primary"
                   StartIcon="Icons.Material.Filled.Save"
                   OnClick="SaveJournal"
                   Loading="_saving">
            Seterusnya
        </MudButton>
    </MudStack>
</MudPaper>

@code {
    [Parameter] public Guid? JournalId { get; set; }

    private MudForm _form = default!;
    private bool _isEdit = false;
    private bool _saving = false;

    // DTO used directly
    private JurnalDTO _model = new()
    {
        ID = Guid.Empty,
        NoJurnal = string.Empty,
        NoRujukan = null,
        TarikhJurnal = DateTime.Today,
        Status = "BARU",
        JenisJurnal = "MANUAL",
        SumberTransaksi = "GENERAL LEDGER",
        Keterangan = string.Empty
    };

    // MudDatePicker binds to nullable
    private DateTime? _tarikhJurnal = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        if (JournalId.HasValue && JournalId.Value != Guid.Empty)
        {
            _isEdit = true;
            await LoadJournal(JournalId.Value);
        }
        else
        {
            // fresh form default already set; keep _tarikhJurnal in sync
            _tarikhJurnal = _model.TarikhJurnal;
        }
    }

    private async Task LoadJournal(Guid id)
    {
        try
        {
            var j = await JurnalService.GetJurnalById(id);
            if (j is null)
            {
                Snackbar.Add("Rekod jurnal tidak ditemui.", Severity.Warning);
                return;
            }

            _model = new JurnalDTO
            {
                ID = j.ID,
                NoJurnal = j.NoJurnal,
                NoRujukan = j.NoRujukan,
                TarikhJurnal = j.TarikhJurnal,
                Status = j.Status,
                JenisJurnal = j.JenisJurnal,
                SumberTransaksi = j.SumberTransaksi,
                Keterangan = j.Keterangan
            };
            _tarikhJurnal = j.TarikhJurnal;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ralat memuatkan jurnal: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveJournal()
    {
        // Ensure mandatory fields
        if (_tarikhJurnal is null)
        {
            Snackbar.Add("Tarikh Jurnal wajib diisi.", Severity.Warning);
            return;
        }
        if (string.IsNullOrWhiteSpace(_model.Status))
        {
            Snackbar.Add("Status wajib diisi.", Severity.Warning);
            return;
        }
        if (string.IsNullOrWhiteSpace(_model.JenisJurnal))
        {
            Snackbar.Add("Jenis Jurnal wajib diisi.", Severity.Warning);
            return;
        }
        if (string.IsNullOrWhiteSpace(_model.SumberTransaksi))
        {
            Snackbar.Add("Sumber Transaksi wajib diisi.", Severity.Warning);
            return;
        }

        // sync date back to DTO
        _model.TarikhJurnal = _tarikhJurnal ?? DateTime.Today;

        _saving = true;
        try
        {
            if (_isEdit && _model.ID != Guid.Empty)
            {
                await JurnalService.UpdateJurnal(_model.ID, _model);
                Snackbar.Add("Jurnal berjaya dikemaskini.", Severity.Success);
            }
            else
            {
                _model.ID = Guid.Empty; // let backend generate
                var created = await JurnalService.CreateJurnal(_model);
                _model.ID = created.ID;
                _model.NoJurnal = created.NoJurnal; // if backend assigns number
                _isEdit = true;
                Snackbar.Add("Jurnal berjaya disimpan.", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ralat menyimpan jurnal: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task DeleteJournal()
    {
        if (!_isEdit || _model.ID == Guid.Empty) return;

        bool? confirm = await DialogService.ShowMessageBox(
            "Pasti?",
            $"Anda pasti mahu hapus jurnal {_model.NoJurnal}?",
            yesText: "Ya",
            cancelText: "Batal"
        );

        if (confirm == true)
        {
            try
            {
                await JurnalService.DeleteJurnal(_model.ID);
                Snackbar.Add("Jurnal berjaya dihapus.", Severity.Success);
                GoBack();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Ralat menghapus jurnal: {ex.Message}", Severity.Error);
            }
        }
    }

    private void ResetForm()
    {
        _model = new JurnalDTO
        {
            ID = Guid.Empty,
            NoJurnal = string.Empty,
            NoRujukan = null,
            TarikhJurnal = DateTime.Today,
            Status = "BARU",
            JenisJurnal = "MANUAL",
            SumberTransaksi = "GENERAL LEDGER",
            Keterangan = string.Empty
        };
        _tarikhJurnal = _model.TarikhJurnal;
        _isEdit = false;
    }

    private void GoBack() => Navigation.NavigateTo("/penyediaan-jurnal");
}
