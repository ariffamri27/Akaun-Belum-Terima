@page "/penyediaan-jurnal"
@using IMAS.API.LejarAm.Shared.Models
@using IMAS.API.LejarAm.Shared.Infrastructure.Refit
@using MudBlazor
@using Microsoft.AspNetCore.Components.Web
@inject IJurnalApi JurnalService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudPaper Class="pa-4">
    <!-- Header -->
    <MudCard Class="mb-4" Style="background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%); color: white;">
        <MudCardContent>
            <MudText Typo="Typo.h5">📝 Penyediaan Jurnal</MudText>
        </MudCardContent>
    </MudCard>

    <!-- Action Buttons (use selection or form) -->
    <MudButtonGroup Class="mb-4">
        <MudButton Color="Color.Success"
                   StartIcon="Icons.Material.Filled.Add"
                   OnClick="AddNewJournal">
            Tambah
        </MudButton>
        <MudButton Color="Color.Primary"
                   StartIcon="Icons.Material.Filled.Edit"
                   OnClick="EditSelectedJournal"
                   Disabled="@(_selectedJournal == null)">
            Ubah
        </MudButton>
        <MudButton Color="Color.Error"
                   StartIcon="Icons.Material.Filled.Delete"
                   OnClick="DeleteSelectedJournal"
                   Disabled="@(_selectedJournal == null)">
            Buang
        </MudButton>
    </MudButtonGroup>

    <!-- Filter Tabs -->
    <MudTabs Class="mb-4"
             Elevation="0"
             Color="Color.Primary"
             ActivePanelIndex="@_activeTab"
             ActivePanelIndexChanged="OnTabChanged">
        <MudTabPanel Text="Belum Pos"></MudTabPanel>
        <MudTabPanel Text="Pos"></MudTabPanel>
    </MudTabs>

    <!-- Records per page and Search -->
    <MudGrid Class="mb-3" AlignItems="AlignItems.Center">
        <MudItem xs="6" md="2">
            <!-- Use Value/ValueChanged to avoid @bind ValueChanged duplication -->
            <MudSelect T="int" Label="Records"
                       Value="@_pageSize"
                       ValueChanged="OnPageSizeChanged"
                       ValueExpression="@(() => _pageSize)"
                       Dense="true">
                <MudSelectItem Value="@(10)">10</MudSelectItem>
                <MudSelectItem Value="@(25)">25</MudSelectItem>
                <MudSelectItem Value="@(50)">50</MudSelectItem>
                <MudSelectItem Value="@(100)">100</MudSelectItem>
            </MudSelect>
            <MudText Typo="Typo.caption">records</MudText>
        </MudItem>
        <MudItem xs="6" md="10" Class="d-flex justify-end">
            <MudTextField T="string"
                          Label="Search"
                          @bind-Value="_searchText"
                          Adornment="Adornment.End"
                          AdornmentIcon="Icons.Material.Filled.Search"
                          Style="max-width: 300px;"
                          OnKeyDown="OnSearchKeyDown" />
        </MudItem>
    </MudGrid>

    <!-- Data Table -->
    <MudTable Items="_pagedList"
              Hover="true"
              Striped="true"
              Loading="_loading"
              SelectedItem="_selectedJournal"
              SelectedItemChanged="OnSelectedItemChanged"
              Dense="true"
              T="JurnalDTO">
        <HeaderContent>
            <MudTh>
                <MudTableSortLabel T="JurnalDTO" SortBy="j => j.NoJurnal">
                    No. Jurnal
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="JurnalDTO" SortBy="j => j.TarikhJurnal">
                    Tarikh Jurnal
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="JurnalDTO" SortBy="j => j.Keterangan">
                    Keterangan
                </MudTableSortLabel>
            </MudTh>
            <MudTh>Sumber Transaksi</MudTh>
            <MudTh>Status</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="No. Jurnal">@context.NoJurnal</MudTd>
            <MudTd DataLabel="Tarikh Jurnal">@context.TarikhJurnal.ToString("dd/MM/yyyy")</MudTd>
            <MudTd DataLabel="Keterangan">@context.Keterangan</MudTd>
            <MudTd DataLabel="Sumber Transaksi">@context.SumberTransaksi</MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string"
                         Color="@GetStatusColor(context.Status)"
                         Size="Size.Small">
                    @context.Status
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Tindakan">
                <MudButton Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditFromRow(context))">Edit</MudButton>
                <MudButton Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteFromRow(context.ID))">Hapus</MudButton>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudAlert Severity="Severity.Info">
                Tiada rekod dijumpai.
            </MudAlert>
        </NoRecordsContent>
    </MudTable>

    <!-- Pagination -->
    <MudDivider Class="my-3" />
    <MudGrid AlignItems="AlignItems.Center">
        <MudItem xs="12" md="6">
            <MudText Typo="Typo.body2">
                Menunjukkan @(Math.Min(_totalItems, ((_currentPage-1) * _pageSize) + 1))
                hingga @((Math.Min(_currentPage * _pageSize, _totalItems))) daripada @_totalItems rekod
            </MudText>
        </MudItem>
        <MudItem xs="12" md="6" Class="d-flex justify-end">
            <MudPagination Page="@_currentPage"
                           Count="@((int)Math.Ceiling((double)_totalItems / _pageSize))"
                           OnPageChanged="OnPageChanged"
                           ShowFirstButton="true"
                           ShowLastButton="true" />
        </MudItem>
    </MudGrid>

    <!-- Inline Form (Create/Update) -->
    <MudDivider Class="my-4" />
    <MudCard Style="background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%); color: white;">
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">@( _isEdit ? "Ubah Jurnal" : "Tambah Jurnal" )</MudText>

            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudTextField Label="No Jurnal"
                                  @bind-Value="_form.NoJurnal"
                                  Variant="Variant.Outlined"
                                  Style="background: white;"
                                  Required="true" />
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudTextField Label="No Rujukan"
                                  @bind-Value="_form.NoRujukan"
                                  Variant="Variant.Outlined"
                                  Style="background: white;" />
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudDatePicker Label="Tarikh Jurnal"
                                   @bind-Date="_tarikhJurnal"
                                   DateFormat="dd/MM/yyyy"
                                   Variant="Variant.Outlined"
                                   Style="background: white;"
                                   Required="true" />
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudSelect T="string" Label="Status"
                               @bind-Value="_form.Status"
                               Variant="Variant.Outlined"
                               Style="background: white;">
                        <MudSelectItem Value="@("BARU")">BARU</MudSelectItem>
                        <MudSelectItem Value="@("POS")">POS</MudSelectItem>
                        <MudSelectItem Value="@("HAPUS")">HAPUS</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudSelect T="string" Label="Jenis Jurnal"
                               @bind-Value="_form.JenisJurnal"
                               Variant="Variant.Outlined"
                               Style="background: white;">
                        <MudSelectItem Value="@("MANUAL")">MANUAL</MudSelectItem>
                        <MudSelectItem Value="@("AUTO")">AUTO</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudTextField Label="Sumber Transaksi"
                                  @bind-Value="_form.SumberTransaksi"
                                  Variant="Variant.Outlined"
                                  Style="background: white;" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField Label="Keterangan"
                                  @bind-Value="_form.Keterangan"
                                  Variant="Variant.Outlined"
                                  Lines="3"
                                  Style="background: white;" />
                </MudItem>
            </MudGrid>

            <MudDivider Class="my-3" />

            <MudStack Row="true" Spacing="2">
                <MudButton Color="Color.Success"
                           StartIcon="Icons.Material.Filled.Save"
                           OnClick="SaveJournal"
                           Disabled="@_saving"
                           Loading="@_saving">
                    Simpan
                </MudButton>
                <MudButton Color="Color.Default"
                           StartIcon="Icons.Material.Filled.Refresh"
                           OnClick="ResetForm">
                    Set Semula
                </MudButton>
                <MudButton Color="Color.Error"
                           StartIcon="Icons.Material.Filled.Delete"
                           Disabled="@(!_isEdit)"
                           OnClick="@(() => DeleteFromRow(_form.ID))">
                    Padam
                </MudButton>
            </MudStack>
        </MudCardContent>
    </MudCard>

    <!-- Bottom Action -->
    <MudDivider Class="my-4" />
    <MudButton Color="Color.Secondary"
               StartIcon="Icons.Material.Filled.ArrowBack"
               OnClick="GoBack">
        Pos Bersekumpuk
    </MudButton>
</MudPaper>

@code {
    // Data store
    private List<JurnalDTO> _all = new();
    private JurnalDTO? _selectedJournal;
    private DateTime? _tarikhJurnal = DateTime.Today;

    // UI state
    private bool _loading = false;
    private bool _saving = false;
    private bool _isEdit = false;

    private int _activeTab = 0; // 0: BARU, 1: POS
    private string _statusFilter => _activeTab == 0 ? "BARU" : "POS";

    private string _searchText = string.Empty;
    private int _pageSize = 10;
    private int _currentPage = 1;

    // Form model
    private JurnalDTO _form = new()
    {
        ID = Guid.Empty,
        NoJurnal = string.Empty,
        NoRujukan = null,
        TarikhJurnal = DateTime.Today,
        Status = "BARU",
        JenisJurnal = "MANUAL",
        SumberTransaksi = "GENERAL LEDGER",
        Keterangan = string.Empty
    };

    // Computed
    private IEnumerable<JurnalDTO> Filtered =>
        _all.Where(j =>
            // Status filter
            (j.Status?.Equals(_statusFilter, StringComparison.OrdinalIgnoreCase) ?? false)
            // Search filter
            && (string.IsNullOrWhiteSpace(_searchText)
                || (j.NoJurnal?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
                || (j.NoRujukan?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
                || (j.Keterangan?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
                || (j.SumberTransaksi?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false))
        );

    private int _totalItems => Filtered.Count();

    private List<JurnalDTO> _pagedList => Filtered
        .Skip((_currentPage - 1) * _pageSize)
        .Take(_pageSize)
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadAll();
    }

    private async Task LoadAll()
    {
        _loading = true;
        try
        {
            _all = await JurnalService.GetAllJurnals() ?? new();
            _currentPage = 1;
        }
        catch (Exception ex)
        {
            _all = new();
            Snackbar.Add($"Gagal memuatkan jurnal: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    // Tabs
    private Task OnTabChanged(int index)
    {
        _activeTab = index;
        _currentPage = 1;
        StateHasChanged();
        return Task.CompletedTask;
    }

    // Table selection
    private void OnSelectedItemChanged(JurnalDTO? journal) => _selectedJournal = journal;

    // Search & paging
    private Task OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            _currentPage = 1;
            StateHasChanged();
        }
        return Task.CompletedTask;
    }

    private Task OnPageChanged(int page)
    {
        _currentPage = page;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task OnPageSizeChanged(int size)
    {
        _pageSize = size;
        _currentPage = 1;
        StateHasChanged();
        return Task.CompletedTask;
    }

    // Colors
    private Color GetStatusColor(string? status) => status?.ToUpperInvariant() switch
    {
        "BARU" => Color.Info,
        "POS" => Color.Success,
        "HAPUS" => Color.Error,
        _ => Color.Default
    };

    // Top action buttons
    private void AddNewJournal()
    {
        ResetForm();
        _isEdit = false;
    }

    private void EditSelectedJournal()
    {
        if (_selectedJournal is null) return;
        SetForm(_selectedJournal);
        _isEdit = true;
    }

    private async Task DeleteSelectedJournal()
    {
        if (_selectedJournal is null) return;
        await DeleteById(_selectedJournal.ID);
    }

    // Row actions
    private void EditFromRow(JurnalDTO j)
    {
        SetForm(j);
        _isEdit = true;
    }

    private async Task DeleteFromRow(Guid id) => await DeleteById(id);

    private async Task DeleteById(Guid id)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Pasti?",
            "Anda pasti mahu hapus jurnal ini?",
            yesText: "Ya",
            cancelText: "Batal"
        );

        if (confirm == true)
        {
            try
            {
                await JurnalService.DeleteJurnal(id);
                Snackbar.Add("Jurnal berjaya dihapus.", Severity.Success);
                await LoadAll();
                _selectedJournal = null;
                // If we were editing the same one, reset the form
                if (_form.ID == id) ResetForm();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Ralat hapus jurnal: {ex.Message}", Severity.Error);
            }
        }
    }

    // Form helpers
    private void SetForm(JurnalDTO j)
    {
        _form = new JurnalDTO
        {
            ID = j.ID,
            NoJurnal = j.NoJurnal,
            NoRujukan = j.NoRujukan,
            TarikhJurnal = j.TarikhJurnal,
            Status = j.Status,
            JenisJurnal = j.JenisJurnal,
            SumberTransaksi = j.SumberTransaksi,
            Keterangan = j.Keterangan
        };

        _tarikhJurnal = j.TarikhJurnal; // sync picker
    }

    private void ResetForm()
    {
        _form = new JurnalDTO
        {
            ID = Guid.Empty,
            NoJurnal = string.Empty,
            NoRujukan = null,
            TarikhJurnal = DateTime.Today,
            Status = "BARU",
            JenisJurnal = "MANUAL",
            SumberTransaksi = "GENERAL LEDGER",
            Keterangan = string.Empty
        };

        _tarikhJurnal = _form.TarikhJurnal; // sync picker
    }

    private async Task SaveJournal()
    {
        if (string.IsNullOrWhiteSpace(_form.NoJurnal))
        {
            Snackbar.Add("No Jurnal wajib diisi.", Severity.Warning);
            return;
        }

        // ensure DTO has a non-null value from the picker
        _form.TarikhJurnal = _tarikhJurnal ?? DateTime.Today;

        _saving = true;
        try
        {
            if (_isEdit && _form.ID != Guid.Empty)
            {
                await JurnalService.UpdateJurnal(_form.ID, _form);
                Snackbar.Add("Jurnal berjaya dikemaskini.", Severity.Success);
            }
            else
            {
                _form.ID = Guid.Empty;
                await JurnalService.CreateJurnal(_form);
                Snackbar.Add("Jurnal berjaya ditambah.", Severity.Success);
            }

            await LoadAll();
            ResetForm();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ralat simpan jurnal: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void GoBack() => Navigation.NavigateTo("/pos-bersekumpuk");
}
