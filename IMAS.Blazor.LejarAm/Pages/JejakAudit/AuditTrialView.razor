@page "/audit-trail"
@using IMAS.API.LejarAm.Shared.Models
@using IMAS.Blazor.LejarAm.Services.Refit
@using MudBlazor
@inject IAuditTrailApi AuditTrailService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudPaper Class="pa-4">

    <!-- Header -->
    <MudCard Class="mb-4" Style="background: #4285f4; color: white;">
        <MudCardContent>
            <MudText Typo="Typo.h6">📄 Laporan Audit Trail</MudText>
        </MudCardContent>
    </MudCard>

    <!-- Filter Bar -->
    <MudCard Class="mb-4">
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" md="3">
                    <MudSelect T="int?" Label="Tahun Kewangan" @bind-Value="_filter.TahunKewangan" Clearable="true">
                        @foreach (var y in _years)
                        {
                            <MudSelectItem Value="@y">@y</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudSelect T="string" Label="Status Dokumen" @bind-Value="_filter.StatusDokumen" Clearable="true">
                        <MudSelectItem Value=@("BARU")>BARU</MudSelectItem>
                        <MudSelectItem Value=@("DRAFT")>DRAFT</MudSelectItem>
                        <MudSelectItem Value=@("POS")>POS</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="2">
                    <MudTextField Label="No Mula" @bind-Value="_filter.NoMula" />
                </MudItem>

                <MudItem xs="12" md="2">
                    <MudTextField Label="No Akhir" @bind-Value="_filter.NoAkhir" />
                </MudItem>

                <MudItem xs="12" md="2">
                    <MudDatePicker Label="Tarikh Mula" @bind-Date="_filter.TarikhMula" DateFormat="dd/MM/yyyy" />
                </MudItem>

                <MudItem xs="12" md="2">
                    <MudDatePicker Label="Tarikh Akhir" @bind-Date="_filter.TarikhAkhir" DateFormat="dd/MM/yyyy" />
                </MudItem>
            </MudGrid>

            <MudDivider Class="my-3" />

            <MudStack Row="true" Spacing="1">
                <MudButton Color="Color.Primary" StartIcon="Icons.Material.Filled.Search" OnClick="LoadData" Disabled="@_isLoading">Cari</MudButton>
                <MudButton Color="Color.Default" StartIcon="Icons.Material.Filled.Clear" OnClick="ClearFilters" Disabled="@_isLoading">Kosongkan</MudButton>
            </MudStack>
        </MudCardContent>
    </MudCard>

    <!-- Report Header -->
    <MudPaper Class="pa-4 mb-2">
        <div class="text-center">
            <MudText Typo="Typo.caption">SISTEM PENGURUSAN KEWANGAN</MudText>
            <MudText Typo="Typo.subtitle2">LAPORAN AUDIT TRAIL JURNAL</MudText>
        </div>
        <MudSpacer />
        <MudText Typo="Typo.caption" Class="mt-2">
            NO MULA - AKHIR : @_filter.NoMula @(" - ") @_filter.NoAkhir
            <br />
            TARIKH MULA - AKHIR : @(_filter.TarikhMula?.ToString("dd/MM/yyyy") ?? "-") @(" - ")
            @(_filter.TarikhAkhir?.ToString("dd/MM/yyyy") ?? "-")
        </MudText>
    </MudPaper>

    <!-- Results Table -->
    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    }
    else
    {
        <MudTable T="AuditRow" Items="_pagedRows" Hover="true" Striped="true" Dense="true">
            <HeaderContent>
                <MudTh>Bil</MudTh>
                <MudTh>No Doc</MudTh>
                <MudTh>Tarikh Doc</MudTh>
                <MudTh>Nama Penghutang</MudTh>
                <MudTh>Butiran</MudTh>
                <MudTh>Kod Akaun</MudTh>
                <MudTh>Keterangan Akaun</MudTh>
                <MudTh Class="text-right">Debit</MudTh>
                <MudTh Class="text-right">Kredit</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Bil">@context.RowNo</MudTd>
                <MudTd DataLabel="No Doc">@context.Item.NoDoc</MudTd>
                <MudTd DataLabel="Tarikh Doc">@context.Item.TarikhDoc?.ToString("dd/MM/yyyy")</MudTd>
                <MudTd DataLabel="Nama Penghutang">@context.Item.NamaPenghutang</MudTd>
                <MudTd DataLabel="Butiran">@context.Item.Butiran</MudTd>
                <MudTd DataLabel="Kod Akaun">@context.Item.KodAkaun</MudTd>
                <MudTd DataLabel="Keterangan Akaun">@context.Item.KeteranganAkaun</MudTd>
                <MudTd DataLabel="Debit" Class="text-right">@((context.Item.Debit ?? 0m).ToString("N2"))</MudTd>
                <MudTd DataLabel="Kredit" Class="text-right">@((context.Item.Kredit ?? 0m).ToString("N2"))</MudTd>
                <MudTd DataLabel="Tindakan">
                    <MudStack Row="true" Spacing="1">
                        <MudButton Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditAuditTrail(context.Item))">Ubah</MudButton>
                        <MudButton Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteAuditTrail(context.Item.ID))">Hapus</MudButton>
                    </MudStack>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudAlert Severity="Severity.Info">Tiada rekod dijumpai. Sila ubah kriteria carian.</MudAlert>
            </NoRecordsContent>
        </MudTable>
    }

    <!-- Pagination -->
    <MudGrid Class="mt-2" AlignItems="AlignItems.Center">
        <MudItem xs="12" md="6">
            <MudText Typo="Typo.caption">
                Menunjukkan @(Math.Min(_totalItems, _startRow + 1))
                hingga @((Math.Min(_startRow + _pageSize, _totalItems)))
                daripada @_totalItems rekod
            </MudText>
        </MudItem>
        <MudItem xs="12" md="6" Class="d-flex justify-end">
            <MudPagination Page="@_currentPage"
                           Count="@((int)Math.Ceiling((double)_totalItems / Math.Max(1,_pageSize)))"
                           OnPageChanged="OnPageChanged"
                           ShowFirstButton
                           ShowLastButton />
        </MudItem>
    </MudGrid>

    <MudDivider Class="my-4" />

    <!-- CRUD Form -->
    <MudCard>
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">@(_isEdit ? "Kemaskini Rekod" : "Tambah Rekod")</MudText>

            <MudGrid Class="mb-2">
                <MudItem xs="12" md="3">
                    <MudTextField Label="No Doc" @bind-Value="_form.NoDoc" Required />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudDatePicker Label="Tarikh Doc" @bind-Date="_form.TarikhDoc" DateFormat="dd/MM/yyyy" Required />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField Label="Nama Penghutang" @bind-Value="_form.NamaPenghutang" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField Label="Butiran" @bind-Value="_form.Butiran" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudTextField Label="Kod Akaun" @bind-Value="_form.KodAkaun" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudTextField Label="Keterangan Akaun" @bind-Value="_form.KeteranganAkaun" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudNumericField T="decimal?" Label="Debit" @bind-Value="_form.Debit" Required />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudNumericField T="decimal?" Label="Kredit" @bind-Value="_form.Kredit" Required />
                </MudItem>
            </MudGrid>

            <MudStack Row="true" Spacing="1">
                <MudButton Color="Color.Success" StartIcon="Icons.Material.Filled.Save" OnClick="SaveAuditTrail" Disabled="@_saving" Loading="@_saving">Simpan</MudButton>
                <MudButton Color="Color.Default" StartIcon="Icons.Material.Filled.Refresh" OnClick="ResetForm">Batal</MudButton>
            </MudStack>
        </MudCardContent>
    </MudCard>

    <!-- Bottom bar -->
    <MudPaper Class="pa-3 mt-3" Style="background:#f7f7f7;">
        <MudStack Row="true" Spacing="1">
            <MudButton Color="Color.Info" StartIcon="Icons.Material.Filled.Print" OnClick="PrintReport" Disabled="@_isLoading">Cetak</MudButton>
            <MudButton Color="Color.Success" StartIcon="Icons.Material.Filled.FileDownload" OnClick="ExportExcel" Disabled="@_isLoading">Export Excel</MudButton>
        </MudStack>
    </MudPaper>
</MudPaper>

@code {
    // Row wrapper to show "Bil"
    private sealed record AuditRow(int RowNo, AuditTrailDTO Item);

    // Data
    private List<AuditTrailDTO> _all = new();
    private List<AuditRow> _pagedRows = new();
    private int _totalItems;

    // Paging
    private int _pageSize = 10;
    private int _currentPage = 1;
    private int _startRow => (_currentPage - 1) * _pageSize;

    // Form + state
    private AuditTrailDTO _form = new();
    private bool _isEdit = false;
    private bool _isLoading = false;
    private bool _saving = false;

    // Filters
    private AuditTrailFilterDTO _filter = new();
    private IEnumerable<int?> _years =
        Enumerable.Range(DateTime.UtcNow.Year - 4, 6).Reverse().Select(y => (int?)y);

    protected override async Task OnInitializedAsync()
    {
        // sensible defaults like the picture
        _filter.TahunKewangan = DateTime.Today.Year;
        _filter.TarikhMula = new DateTime(DateTime.Today.Year, 1, 1);
        _filter.TarikhAkhir = new DateTime(DateTime.Today.Year, 12, 31);
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            _all = await AuditTrailService.SearchAsync(_filter) ?? new();
            _totalItems = _all.Count;
            BuildPagedRows();
        }
        catch (Exception ex)
        {
            _all = new();
            _totalItems = 0;
            await DialogService.ShowMessageBox("Ralat", $"Gagal memuatkan data. {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void BuildPagedRows()
    {
        _pagedRows = _all
            .Skip(_startRow)
            .Take(_pageSize)
            .Select((x, i) => new AuditRow(_startRow + i + 1, x))
            .ToList();
    }

    private void ClearFilters()
    {
        _filter = new AuditTrailFilterDTO
        {
            TahunKewangan = DateTime.Today.Year
        };
        _currentPage = 1;
        _ = LoadData();
    }

    private Task OnPageChanged(int page)
    {
        _currentPage = page;
        BuildPagedRows();
        return Task.CompletedTask;
    }

    // ---- CRUD ----
    private void EditAuditTrail(AuditTrailDTO a)
    {
        _form = new AuditTrailDTO
        {
            ID = a.ID,
            NoDoc = a.NoDoc,
            TarikhDoc = a.TarikhDoc,
            NamaPenghutang = a.NamaPenghutang,
            Butiran = a.Butiran,
            KodAkaun = a.KodAkaun,
            KeteranganAkaun = a.KeteranganAkaun,
            Debit = a.Debit,
            Kredit = a.Kredit,
            AuditTrailFilterEntitiesID = a.AuditTrailFilterEntitiesID
        };
        _isEdit = true;
    }

    private async Task SaveAuditTrail()
    {
        // simple validation to match your controller's required .Value fields
        if (string.IsNullOrWhiteSpace(_form.NoDoc))
        {
            Snackbar.Add("No Doc wajib diisi.", Severity.Warning);
            return;
        }
        if (_form.TarikhDoc is null)
        {
            Snackbar.Add("Tarikh Doc wajib diisi.", Severity.Warning);
            return;
        }
        if (_form.Debit is null || _form.Kredit is null)
        {
            Snackbar.Add("Debit dan Kredit wajib diisi.", Severity.Warning);
            return;
        }

        _saving = true;
        try
        {
            if (_isEdit && _form.ID != Guid.Empty)
            {
                await AuditTrailService.UpdateAsync(_form.ID, _form);
                Snackbar.Add("Rekod berjaya dikemaskini.", Severity.Success);
            }
            else
            {
                _form.ID = Guid.Empty; // backend generates ID
                await AuditTrailService.CreateAsync(_form);
                Snackbar.Add("Rekod berjaya ditambah.", Severity.Success);
            }

            await LoadData();
            ResetForm();
        }
        catch (Exception ex)
        {
            await DialogService.ShowMessageBox("Ralat", $"Gagal simpan rekod. {ex.Message}");
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task DeleteAuditTrail(Guid id)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Pasti?",
            "Anda pasti mahu hapus rekod ini?",
            yesText: "Ya",
            cancelText: "Batal"
        );

        if (confirm != true) return;

        try
        {
            var resp = await AuditTrailService.DeleteAsync(id);
            if (!resp.IsSuccessStatusCode)
                throw new Exception($"HTTP {(int)resp.StatusCode}");

            Snackbar.Add("Rekod berjaya dihapus.", Severity.Success);
            await LoadData();
        }
        catch (Exception ex)
        {
            await DialogService.ShowMessageBox("Ralat", $"Gagal menghapuskan rekod. {ex.Message}");
        }
    }

    private void ResetForm()
    {
        _form = new();
        _isEdit = false;
    }

    // ---- Print / Export ----
    private async Task PrintReport()
    {
        try
        {
            var resp = await AuditTrailService.PrintReportAsync(_filter);
            if (!resp.IsSuccessStatusCode)
                throw new Exception($"HTTP {(int)resp.StatusCode}");

            var maybeUrl = resp.Content ?? string.Empty;
            if (!string.IsNullOrWhiteSpace(maybeUrl) && (maybeUrl.StartsWith("/") || maybeUrl.StartsWith("http")))
            {
                Navigation.NavigateTo(maybeUrl, forceLoad: true);
            }
            else
            {
                Snackbar.Add("Permintaan cetak telah dihantar.", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal mencetak: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportExcel()
    {
        try
        {
            var bytes = await AuditTrailService.ExportExcelAsync(_filter);
            if (bytes is null || bytes.Length == 0)
            {
                Snackbar.Add("Tiada data untuk dieksport.", Severity.Info);
                return;
            }

            // Open data URL in new tab
            var base64 = Convert.ToBase64String(bytes);
            var url = $"data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,{base64}";
            await Task.Delay(1);
            Navigation.NavigateTo(url, forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal eksport Excel: {ex.Message}", Severity.Error);
        }
    }
}
